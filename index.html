<script>
/* ======= ENDPOINTS (RET disse til dine PA HTTP-triggere) ======= */
var ENDPOINT_EVENT = "https://<din-flow-url>/event";
var ENDPOINT_REP   = "https://<din-flow-url>/rep";
var ENDPOINT_NOTE  = "https://<din-flow-url>/note";

/* ======= XHR (Edge-kompatibel) ======= */
function postJSON(url,payload,label){
  if(!url || url.indexOf('http')!==0){ return; }
  try{
    var xhr=new XMLHttpRequest();
    xhr.open('POST',url,true);
    xhr.setRequestHeader('Content-Type','application/json;charset=UTF-8');
    xhr.onreadystatechange=function(){ if(xhr.readyState===4){ /* valgfri log: console.log(label, xhr.status); */ } };
    xhr.send(JSON.stringify(payload));
  }catch(e){}
}

/* ======= Gensend kÃ¸ (offline -> online) ======= */
function resendQueued(){
  var feed = loadJSON('produktionsstop.feed.v1', []);
  var changed=false;
  for(var i=0;i<feed.length;i++){
    var r=feed[i];
    if(r.sent) continue;

    if(r.type==='stop'){
      var payload={
        id:r.id, start:r.start, end:r.end, duration_ms:r.durationMs,
        line:r.line, order:r.orderNo, item:r.itemNo, operator:r.operator,
        cause_code:(r.reason&&r.reason.code)||'', cause_label:(r.reason&&r.reason.label)||'',
        details:(r.detailChips||[]).join(', '), other:r.other||'', comment:r.comment||''
      };
      postJSON(ENDPOINT_EVENT,payload,'STOP'); r.sent=true; changed=true;
    }
    if(r.type==='rep'){
      var payloadR={
        id:r.id, line:r.line, order:r.orderNo, item:r.itemNo, operator:r.operator,
        priority:r.priority, type:r.faultType, description:r.description
      };
      postJSON(ENDPOINT_REP,payloadR,'REP'); r.sent=true; changed=true;
    }
    if(r.type==='note'){
      var payloadN={ id:r.id, ts:r.ts||null, line:r.line, order:r.orderNo, item:r.itemNo, operator:r.operator, text:r.text };
      postJSON(ENDPOINT_NOTE,payloadN,'NOTE'); r.sent=true; changed=true;
    }
  }
  if(changed) saveJSON('produktionsstop.feed.v1', feed);
}

/* ======= Start gensendelser ved load og hvert 5. minut ======= */
window.addEventListener('DOMContentLoaded', function(){
  resendQueued();
  setInterval(resendQueued, 5*60*1000);
});
</script>
</body>
</html>
