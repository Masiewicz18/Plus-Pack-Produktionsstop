<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Plus Pack â€“ Stop & Rep Registrering</title>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;font-family:Segoe UI,Arial,Helvetica,sans-serif;background:#f4f6f9;color:#0f172a}
header{background:#0a61ae;color:#fff;padding:10px 16px;font-size:18px;font-weight:700}
.container{max-width:1200px;margin:0 auto;padding:12px}
.card{background:#fff;border:1px solid #e6ecf3;border-radius:12px;padding:12px 16px;margin-bottom:10px;box-shadow:0 4px 16px rgba(15,23,42,.05)}
h3{margin:0 0 6px;font-size:17px;color:#0a366e}
label{font-size:12px;color:#334155;display:block;margin-bottom:3px}
input,select,textarea{width:100%;border:1px solid #cfd8e3;border-radius:8px;padding:8px 10px;font-size:14px;background:#fff}
textarea{min-height:70px}
.row{display:flex;flex-wrap:wrap;gap:8px}
.field{flex:1 1 220px;margin-bottom:8px}
.btn{border:1px solid #cfd8e3;border-radius:8px;padding:10px 12px;font-weight:600;background:#fff;cursor:pointer}
.btn:hover{background:#f1f5f9}
.btn-primary{background:#0a61ae;color:#fff;border:none}
.btn-primary:hover{background:#094f8c}
.btn-stop{background:#fee2e2;border:1px solid #fca5a5;color:#7f1d1d}
.btn-start{background:#dcfce7;border:1px solid #86efac;color:#065f46}
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.chip{border:1px solid #dbe4ef;background:#f5f9ff;border-radius:999px;padding:5px 8px;font-size:13px;cursor:pointer}
.chip input{margin-right:4px}
.loglist{list-style:none;padding:0;margin:0;border:1px solid #e2e8f0;border-radius:10px;background:#fff;max-height:260px;overflow-y:auto}
.loglist li{padding:8px 10px;border-bottom:1px solid #f1f5f9;font-size:14px;line-height:1.3}
.loglist li:last-child{border-bottom:none}
.tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px}
.tag.stop{background:#fee2e2;color:#991b1b}
.tag.rep{background:#ffedd5;color:#9a3412}
.tag.note{background:#dbeafe;color:#1e3a8a}
.time{color:#475569;font-size:12px;margin-top:2px}
.hint{font-size:12px;color:#64748b}
.quick{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.smallbtn{font-size:12px;padding:6px 8px;border-radius:6px}
.sep{height:1px;background:#e5e7eb;margin:10px 0}
.statuspill{display:inline-flex;align-items:center;gap:6px;border:1px solid #e2e8f0;border-radius:999px;padding:6px 10px}
.dot{width:10px;height:10px;border-radius:999px;background:#16a34a}
.dot.stop{background:#dc2626}
.timer{font:700 28px/1.1 ui-monospace,Consolas,monospace;color:#0f172a}
.timer small{display:block;font:600 11px/1 Segoe UI,Arial;color:#64748b}
@media (max-width:900px){.row{display:block}}
</style>
</head>
<body>
<header>Plus Pack â€“ Stop & Rep Registrering</header>
<div class="container">

  <!-- STATUS OG BASISINFO -->
  <div class="card">
    <div class="row" style="align-items:center">
      <div class="statuspill"><span id="dot" class="dot"></span><span id="statxt">KÃ¸rer</span></div>
      <div class="timer" style="flex:1;text-align:center"><small>Aktuelt stop</small><span id="liveTimer">â€”</span></div>
      <div class="row" style="gap:8px">
        <button id="btn-stop" class="btn btn-stop">Stop</button>
        <button id="btn-start" class="btn btn-start" disabled>Start</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Basisoplysninger</h3>
    <div class="row">
      <div class="field"><label>Linje / Maskine</label><select id="line">
        <option value="">â€” VÃ¦lg â€”</option>
        <option>L10 Rhodes</option><option>L11 Mech RF135</option><option>L13 Beutler</option>
        <option>L14 Flexo C50</option><option>L15 Flexo C30</option><option>L16 Schuler</option>
      </select></div>
      <div class="field"><label>Ordre nr.</label><input id="orderNo" type="text"></div>
      <div class="field"><label>Vare nr.</label><input id="itemNo" type="text"></div>
      <div class="field"><label>OperatÃ¸r</label><input id="operator" type="text"></div>
    </div>
    <div class="hint">Disse felter huskes lokalt, ogsÃ¥ efter refresh.</div>
  </div>

  <!-- HANDLINGER -->
  <div class="card">
    <h3>Handlinger</h3>
    <div class="row" style="gap:8px">
      <button id="btn-new-stop" class="btn btn-stop" style="flex:1">RegistrÃ©r stop</button>
      <button id="btn-new-rep" class="btn btn-primary" style="flex:1">Opret rep-seddel</button>
      <button id="btn-new-note" class="btn" style="flex:1">Gem note</button>
    </div>
  </div>

  <!-- PANEL: REGISTRERING AF STOP -->
  <div class="card" id="stopPanel" style="display:none">
    <h3>RegistrÃ©r stop</h3>
    <div class="row">
      <div class="field" style="flex:1 1 400px">
        <label>Ã…rsag</label>
        <div id="reasonList" class="chips"></div>
      </div>
      <div class="field" style="flex:1 1 400px">
        <label>Uddybning</label>
        <div id="detailList" class="chips"></div>
      </div>
    </div>
    <div class="row sm">
      <div class="field"><label>Andet</label><input id="other" type="text"></div>
      <div class="field"><label>Kommentar</label><input id="comment" type="text"></div>
    </div>
    <div class="row sm">
      <div class="field"><label>Hurtig udfyldning</label>
        <select id="quickLast"><option value="">â€” VÃ¦lg tidligere registrering â€”</option></select>
      </div>
      <div class="field"><label>Skabeloner</label>
        <select id="tplSelect"><option value="">â€” VÃ¦lg favorit â€”</option></select>
      </div>
    </div>
    <div class="quick">
      <button id="btnTplSave" class="smallbtn btn-primary">Gem som skabelon</button>
      <button id="btnTplDel" class="smallbtn">Slet skabelon</button>
      <button id="btnCopyLast" class="smallbtn">Kopier sidste for Ã¥rsag</button>
    </div>
    <div class="sep"></div>
    <div class="row" style="justify-content:flex-end;gap:6px">
      <button id="btn-cancel-stop" class="btn">Annuller</button>
      <button id="btn-confirm-stop" class="btn btn-stop">BekrÃ¦ft stop</button>
    </div>
  </div>

  <!-- PANEL: REP-SEDDEL -->
  <div class="card" id="repPanel" style="display:none">
    <h3>Opret rep-seddel</h3>
    <div class="row sm">
      <div class="field"><label>Fejltype</label><input id="rep-type" type="text"></div>
      <div class="field"><label>Prioritet</label><select id="rep-pri"><option>Lav</option><option>Mellem</option><option>HÃ¸j</option><option>Kritisk</option></select></div>
      <div class="field"><label>Modtager</label><input id="rep-to" type="email" placeholder="vedligehold@pluspack.com"></div>
    </div>
    <div class="field"><label>Beskrivelse</label><textarea id="rep-desc"></textarea></div>
    <div class="row" style="justify-content:flex-end;gap:6px">
      <button id="btn-cancel-rep" class="btn">Annuller</button>
      <button id="btn-send-rep" class="btn btn-primary">Send rep-seddel</button>
    </div>
  </div>

  <!-- NOTE -->
  <div class="card" id="notePanel" style="display:none">
    <h3>Ny note</h3>
    <textarea id="noteText" placeholder="Skriv kort note her..."></textarea>
    <div class="row" style="justify-content:flex-end;gap:6px">
      <button id="btn-cancel-note" class="btn">Annuller</button>
      <button id="btn-save-note" class="btn btn-primary">Gem note</button>
    </div>
  </div>

  <!-- FEED -->
  <div class="card">
    <h3>Seneste aktiviteter</h3>
    <ul id="feedList" class="loglist"></ul>
  </div>

</div>

  <script>
/* ---------- HjÃ¦lpefunktioner ---------- */
function $(id){return document.getElementById(id);}
function show(el){if(el)el.style.display='';}
function hide(el){if(el)el.style.display='none';}
function pad(n){return(n<10?'0':'')+n;}
function fmtDate(d){var t=new Date(d);return pad(t.getHours())+':'+pad(t.getMinutes())+'  '+pad(t.getDate())+'/'+pad(t.getMonth()+1);}
function fmtDur(ms){var s=Math.floor(ms/1000),m=Math.floor(s/60)%60,h=Math.floor(s/3600);return pad(h)+':'+pad(m)+':'+pad(s%60);}
function uuid(){return 'id-'+Date.now()+'-'+Math.floor(Math.random()*1e6);}

/* ---------- LocalStorage keys ---------- */
var STORE_EVENTS='pluspack.v3.events', STORE_SETTINGS='pluspack.v3.settings', STORE_TEMPLATES='pluspack.v3.tpl';
function load(k,def){try{return JSON.parse(localStorage.getItem(k))||def;}catch(e){return def;}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v));}

/* ---------- Globale refs ---------- */
var els={
 dot:$('dot'), statxt:$('statxt'), liveTimer:$('liveTimer'),
 btnStop:$('btn-stop'), btnStart:$('btn-start'),
 line:$('line'), order:$('orderNo'), item:$('itemNo'), oper:$('operator'),
 stopPanel:$('stopPanel'), repPanel:$('repPanel'), notePanel:$('notePanel'),
 quick:$('quickLast'), tpl:$('tplSelect'),
 btnNewStop:$('btn-new-stop'), btnNewRep:$('btn-new-rep'), btnNewNote:$('btn-new-note'),
 feed:$('feedList')
};
var IS_STOP=false, STOP_START=null, stopMeta=null, timer=null;

/* ---------- Ã…rsager ---------- */
var REASONS=[
 {code:'PRES',label:'Presse',details:['Rensning','SmÃ¸ring','OpsÃ¦tning']},
 {code:'VAERK',label:'VÃ¦rktÃ¸j',details:['Skift','Slid','Defekt']},
 {code:'STAK',label:'Stakker',details:['Fejl','Opsamler','Andet']},
 {code:'FOLIE',label:'Folie',details:['PÃ¥fyld','Bestilling']},
 {code:'ORDRE',label:'Ordre',details:['Afventer','Uklar ordre']},
 {code:'ANDET',label:'Andet',details:['Sikkerhed','RengÃ¸ring']}
];
function renderReasons(){
 var rHTML='',dHTML='';
 for(var i=0;i<REASONS.length;i++){
   var r=REASONS[i];
   rHTML+='<label class="chip"><input type="radio" name="reason" value="'+r.code+'">'+r.label+'</label>';
 }
 $('reasonList').innerHTML=rHTML;
 $('reasonList').onclick=function(e){
   var t=e.target;if(t.name==='reason'){
     var r=REASONS.filter(function(x){return x.code===t.value;})[0]||{details:[]};
     var d='';for(var j=0;j<r.details.length;j++){d+='<label class="chip"><input type="checkbox" value="'+r.details[j]+'">'+r.details[j]+'</label>';}
     $('detailList').innerHTML=d;
   }
 };
}

/* ---------- Status / Timer ---------- */
function setStatus(st){
 IS_STOP=st;
 els.btnStop.disabled=st;els.btnStart.disabled=!st;
 els.dot.className=st?'dot stop':'dot';
 els.statxt.innerHTML=st?'Stoppet':'KÃ¸rer';
 els.liveTimer.innerHTML=st?'00:00:00':'â€”';
}
function tick(){
 if(!IS_STOP)return;
 var ms=Date.now()-new Date(STOP_START).getTime();
 els.liveTimer.innerHTML=fmtDur(ms);
}

/* ---------- Basisfelter ---------- */
function syncBasics(){
 save(STORE_SETTINGS,{
   line:els.line.value,order:els.order.value,item:els.item.value,oper:els.oper.value
 });
}
function restoreBasics(){
 var s=load(STORE_SETTINGS,{});
 if(s.line)els.line.value=s.line;
 if(s.order)els.order.value=s.order;
 if(s.item)els.item.value=s.item;
 if(s.oper)els.oper.value=s.oper;
}

/* ---------- Feed rendering ---------- */
function renderFeed(){
 var list=load(STORE_EVENTS,[]).sort(function(a,b){return new Date(b.ts)-new Date(a.ts);});
 if(!list.length){els.feed.innerHTML='<li class="hint" style="padding:6px">Ingen registreringer endnu</li>';return;}
 var html='';
 for(var i=0;i<list.length;i++){
   var e=list[i],tag='',clr='';
   if(e.type==='stop'){tag='stop';clr='ðŸ”´ Stop';}
   else if(e.type==='rep'){tag='rep';clr='ðŸŸ  Rep-seddel';}
   else{tag='note';clr='ðŸ”µ Note';}
   html+='<li><span class="tag '+tag+'">'+clr+'</span><b>'+ (e.line||'') +'</b> Â· '+fmtDate(e.ts);
   if(e.order)html+=' Â· Ordre: '+e.order;
   if(e.item)html+=' Â· Vare: '+e.item;
   html+='<div>'+ (e.comment||e.desc||'-') +'</div></li>';
 }
 els.feed.innerHTML=html;
}

/* ---------- Stopregistrering ---------- */
function collectStop(){
 var rSel=document.querySelector('input[name="reason"]:checked');
 var rCode=rSel?rSel.value:'';var rObj=REASONS.filter(function(x){return x.code===rCode;})[0]||{};
 var det=[];var boxes=$('detailList').getElementsByTagName('input');
 for(var i=0;i<boxes.length;i++){if(boxes[i].checked)det.push(boxes[i].value);}
 return{
   id:uuid(),type:'stop',ts:new Date().toISOString(),
   line:els.line.value,order:els.order.value,item:els.item.value,oper:els.oper.value,
   reason:rObj.label||'',detail:det.join(','),
   comment:$('comment').value||$('other').value||''
 };
}
function confirmStop(){
 var ev=collectStop();stopMeta=ev;STOP_START=new Date().toISOString();setStatus(true);
 if(timer)clearInterval(timer);timer=setInterval(tick,1000);hide($('stopPanel'));
}

/* ---------- Rep-seddel ---------- */
function collectRep(){
 return{
   id:uuid(),type:'rep',ts:new Date().toISOString(),
   line:els.line.value,order:els.order.value,item:els.item.value,oper:els.oper.value,
   pri:$('rep-pri').value,typeTxt:$('rep-type').value,desc:$('rep-desc').value
 };
}
function sendRep(){
 var r=collectRep();var all=load(STORE_EVENTS,[]);all.push(r);save(STORE_EVENTS,all);
 hide($('repPanel'));renderFeed();
}

/* ---------- Note ---------- */
function saveNote(){
 var t=$('noteText').value;if(!t)return;
 var n={id:uuid(),type:'note',ts:new Date().toISOString(),line:els.line.value,comment:t};
 var all=load(STORE_EVENTS,[]);all.push(n);save(STORE_EVENTS,all);
 $('noteText').value='';hide($('notePanel'));renderFeed();
}

/* ---------- Quick / Templates ---------- */
function refreshQuick(){
 var rows=load(STORE_EVENTS,[]).filter(function(x){return x.type==='stop';}).slice(-10).reverse();
 var h='<option value="">â€” VÃ¦lg tidligere â€”</option>';
 for(var i=0;i<rows.length;i++){h+='<option value="'+rows[i].id+'">'+rows[i].reason+' Â· '+(rows[i].comment||'')+'</option>';}
 $('quickLast').innerHTML=h;
}
function applyFromPrev(id){
 var rows=load(STORE_EVENTS,[]);var ev=rows.filter(function(x){return x.id===id;})[0];
 if(!ev)return;
 var radios=document.getElementsByName('reason');
 for(var i=0;i<radios.length;i++){if(radios[i].value===ev.reason)radios[i].checked=true;}
 $('other').value='';$('comment').value=ev.comment||'';
}
$('quickLast').onchange=function(){if(this.value)applyFromPrev(this.value);};

/* ---------- Init ---------- */
window.addEventListener('DOMContentLoaded',function(){
 restoreBasics();renderReasons();renderFeed();refreshQuick();
 els.line.onchange=syncBasics;els.order.oninput=syncBasics;els.item.oninput=syncBasics;els.oper.oninput=syncBasics;

 els.btnNewStop.onclick=function(){show($('stopPanel'));hide($('repPanel'));hide($('notePanel'));}
 els.btnNewRep.onclick=function(){show($('repPanel'));hide($('stopPanel'));hide($('notePanel'));}
 els.btnNewNote.onclick=function(){show($('notePanel'));hide($('stopPanel'));hide($('repPanel'));}

 $('btn-cancel-stop').onclick=function(){hide($('stopPanel'));}
 $('btn-cancel-rep').onclick=function(){hide($('repPanel'));}
 $('btn-cancel-note').onclick=function(){hide($('notePanel'));}

 $('btn-confirm-stop').onclick=function(){
   var ev=collectStop();var arr=load(STORE_EVENTS,[]);arr.push(ev);save(STORE_EVENTS,arr);
   hide($('stopPanel'));renderFeed();setStatus(true);STOP_START=new Date().toISOString();
   if(timer)clearInterval(timer);timer=setInterval(tick,1000);
 };
 $('btn-start').onclick=function(){
   if(!IS_STOP)return;
   setStatus(false);if(timer){clearInterval(timer);timer=null;}
   IS_STOP=false;STOP_START=null;
 };
 $('btn-stop').onclick=function(){show($('stopPanel'));}
 $('btn-send-rep').onclick=sendRep;
 $('btn-save-note').onclick=saveNote;
});
</script>
<script>
/* ---------- Power Automate endpoints ---------- */
/*  IndsÃ¦t dine faktiske flow-URLâ€™er her  */
var ENDPOINT_STOP   = "https://<din-flow-url-her>/stop";
var ENDPOINT_REP    = "https://<din-flow-url-her>/rep";
var ENDPOINT_NOTE   = "https://<din-flow-url-her>/note";

/* ---------- XHR-POST (Edge-sikker) ---------- */
function postJSON(url,payload){
  try{
    var xhr=new XMLHttpRequest();
    xhr.open("POST",url,true);
    xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8");
    xhr.send(JSON.stringify(payload));
  }catch(e){
    console.log("Send-fejl",e);
  }
}

/* ---------- Auto-send nye registreringer ---------- */
function autoSend(){
  var all = load(STORE_EVENTS,[]);
  if(!all.length) return;
  for(var i=0;i<all.length;i++){
    var r=all[i], pl={};
    if(r.sent) continue;

    /* BASISFELTER */
    pl.line = r.line||''; pl.order = r.order||''; pl.item = r.item||''; pl.oper = r.oper||'';
    pl.id = r.id; pl.timestamp = r.ts; pl.type = r.type;

    if(r.type==='stop'){
      pl.reason = r.reason||''; pl.detail = r.detail||''; pl.comment = r.comment||'';
      postJSON(ENDPOINT_STOP,pl);
    }
    else if(r.type==='rep'){
      pl.priority = r.pri||''; pl.errorType = r.typeTxt||''; pl.description = r.desc||'';
      postJSON(ENDPOINT_REP,pl);
    }
    else if(r.type==='note'){
      pl.note = r.comment||r.desc||'';
      postJSON(ENDPOINT_NOTE,pl);
    }
    r.sent=true;
  }
  save(STORE_EVENTS,all);
}

/* ---------- Periodisk afsendelse + ved start ---------- */
window.addEventListener('DOMContentLoaded',function(){
  // send alt ved opstart
  autoSend();
  // og gentag hvert 5. minut
  setInterval(autoSend,5*60*1000);
});

/* ---------- Ekstra forbedring: behold basisfelter efter refresh ---------- */
window.addEventListener('beforeunload',function(){
  syncBasics();
});
</script>
</body>
</html>

