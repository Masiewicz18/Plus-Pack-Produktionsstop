<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Plus Pack – Produktionsstop (Handling & Indstillinger)</title>

<style>
/* ===== Klassisk layout – kompatibelt med gammel Edge ===== */
:root{
  --brand:#0a61ae;
  --bg:#f2f4f7;
  --panel:#ffffff;
  --text:#111827;
  --muted:#4b5563;
  --border:#d1d5db;
  --shadow:0 2px 8px rgba(0,0,0,.1);
  --ok:#22c55e;
  --danger:#dc2626;
}

/* Reset & base */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
h3{margin-top:0}
button,input,select,textarea{font-family:inherit;font-size:14px}

/* Brand-top */
.brand{
  background:var(--brand);
  color:#fff;
  padding:12px 18px;
  font-weight:700;
  font-size:18px;
}

/* Container */
.container{
  max-width:1000px;
  margin:0 auto;
  padding:16px;
}

/* Kort */
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:var(--shadow);
  padding:16px;
  margin-bottom:16px;
}

/* Fallback layout til gammel Edge – flex-baseret */
.section-flex{display:flex;flex-wrap:wrap;gap:12px}
.section-flex > *{flex:1 1 300px}

/* Knapper */
.btn{
  border:1px solid var(--border);
  background:#fff;
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
}
.btn:hover{background:#f8fafc}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.btn-primary:hover{background:#094f8a}
.btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
.btn-danger:hover{background:#b91c1c}

/* Inputs */
.field{display:flex;flex-direction:column;margin-bottom:12px}
label{font-size:13px;color:var(--muted);margin-bottom:4px}
input,select,textarea{
  border:1px solid var(--border);
  border-radius:6px;
  padding:8px 10px;
}
textarea{min-height:70px;resize:vertical}

/* Statusindikator */
.status{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border:1px solid var(--border);
  border-radius:999px;
  background:#fff;
  font-size:13px;
}
.status .dot{
  width:10px;height:10px;
  border-radius:50%;
  background:var(--ok);
}
</style>

/* Tabs */
.tabs{
  display:flex;
  gap:6px;
  background:#fff;
  border-bottom:1px solid var(--border);
  padding:8px 10px;
  position:sticky;
  top:0;
  z-index:5;
}
.tab{
  border:0;
  background:transparent;
  padding:8px 12px;
  cursor:pointer;
  border-radius:6px;
  font-weight:600;
}
.tab.active{background:#e5e7eb}
.tab:hover{background:#f3f4f6}
</style>

<!-- JavaScript: Grid-fallback detector -->
<script>
(function(){
  var noGrid=true;
  try{ if(window.CSS&&CSS.supports&&CSS.supports('display','grid')) noGrid=false; }catch(e){}
  if(noGrid){
    var c=document.documentElement.className;
    document.documentElement.className=c?(c+' no-grid'):'no-grid';
  }
})();
</script>
</head>

<body>
<div class="brand">Plus Pack – Produktionsstop</div>
<div class="tabs">
  <button id="tab-handling" class="tab active">Handling</button>
  <button id="tab-settings" class="tab">Indstillinger</button>
  <div class="status" style="margin-left:auto">
    <span class="dot" id="dot"></span>
    <span id="statxt">Kører</span>
  </div>
</div>

<div class="container">
  <!-- HANDLING -->
  <section id="view-handling">
    <div class="card">
      <h3>Handling</h3>
      <div class="section-flex">
        <button class="btn btn-danger" id="btn-stop" type="button">⏹ STOP</button>
        <button class="btn btn-primary" id="btn-start" type="button" disabled>▶ START</button>
      </div>

      <div style="margin-top:16px">
        <label>Aktuelt stop:</label>
        <div id="liveTimer" style="font-family:Consolas,monospace;font-size:32px;font-weight:700;">—</div>
      </div>

      <div class="section-flex" style="margin-top:16px">
        <div class="field">
          <label>Linje / maskine</label>
          <select id="line">
            <option value="">— Vælg maskine —</option>
            <option>L10 75 t Rhodes special presse</option>
            <option>L11 Mech RF135 serie nr 18-11 Mnr888</option>
            <option>L14 50 t Flexo C50 S20 presse</option>
            <option>L15 30 t Flexo C30 S15 presse</option>
            <option>L16 40 t Schuler PNH 40/250 presse</option>
            <option>L17 30 t Flexo C30 S15 presse</option>
            <option>L20 50 t Bliss 50F MKII presse</option>
          </select>
        </div>

        <div class="field">
          <label>Ordre nr. (krævet)</label>
          <input id="orderNo" type="text">
        </div>

        <div class="field">
          <label>Vare nr. (krævet)</label>
          <input id="itemNo" type="text">
        </div>
      </div>

        <div class="section-flex" style="margin-top:8px">
        <div class="field">
          <label>Operatør (valgfri)</label>
          <input id="operator" type="text" placeholder="Navn/initialer">
        </div>

        <div class="field">
          <label>&nbsp;</label>
          <button class="btn" id="btn-clear-order" type="button">Ryd ordre</button>
        </div>

        <div class="field">
          <label>&nbsp;</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="btn-clear-line" type="button">Ryd linje</button>
            <button class="btn" id="btn-open-rep" type="button">Åbn rep-seddel</button>
          </div>
        </div>
      </div>
    </div> <!-- /card -->

    <!-- STOP MODAL -->
    <div id="ov-stop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);align-items:center;justify-content:center;z-index:999;">
      <div style="background:#fff;border-radius:12px;max-width:600px;width:94%;box-shadow:0 10px 40px rgba(0,0,0,.3);overflow:hidden">
        <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-weight:700;display:flex;justify-content:space-between;align-items:center">
          <span>Registrér stop</span>
          <button class="btn" id="stop-close" type="button">Luk</button>
        </div>

        <div style="padding:14px 16px">
          <div class="field">
            <label>Årsag</label>
            <select id="stop-reason">
              <option value="">— Vælg årsag —</option>
              <option>Presse</option>
              <option>Værktøj</option>
              <option>Folie</option>
              <option>Stakker</option>
              <option>Ordre</option>
              <option>Andet</option>
            </select>
          </div>

          <div class="field">
            <label>Kommentar</label>
            <textarea id="stop-comment" placeholder="Beskriv kort årsagen"></textarea>
          </div>

          <p id="stopValidation" class="muted" style="color:#9ca3af;font-size:13px;"></p>
        </div>

        <div style="border-top:1px solid var(--border);padding:10px;display:flex;justify-content:flex-end;gap:8px">
          <button class="btn" id="stop-cancel" type="button">Annuller</button>
          <button class="btn btn-danger" id="stop-confirm" type="button">Bekræft stop</button>
        </div>
      </div>
    </div> <!-- /ov-stop -->
  </section>

    <!-- INDSTILLINGER -->
  <section id="view-settings" style="display:none">
    <div class="card">
      <h3>Indstillinger</h3>

      <div class="section-flex">
        <div class="field">
          <label>Standard-modtager (mail)</label>
          <input id="defTo" type="email" placeholder="vedligehold@pluspack.com">
        </div>

        <div class="field">
          <label>Brandfarve</label>
          <input id="brandColor" type="text" placeholder="#0a61ae">
        </div>
      </div>

      <div class="section-flex">
        <div class="field">
          <label>Farvetema</label>
          <select id="themeSelect">
            <option value="standard">Standard (lys)</option>
            <option value="dark">Mørk</option>
          </select>
        </div>

        <div class="field">
          <label>&nbsp;</label>
          <button class="btn btn-primary" id="btn-save-settings" type="button">Gem indstillinger</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Årsager</h3>

      <div class="section-flex">
        <div class="field">
          <label>Kode (fx PRES)</label>
          <input id="causeCode" type="text" placeholder="KODE">
        </div>

        <div class="field">
          <label>Navn/label</label>
          <input id="causeLabel" type="text" placeholder="Beskrivelse">
        </div>
      </div>

      <div class="field">
        <label>Uddybning (chips, kommasepareret)</label>
        <input id="causeChips" type="text" placeholder="fx Rensning, Sikkerhed, Opsætning">
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
        <button class="btn" id="btn-add-cause" type="button">Tilføj årsag</button>
        <button class="btn" id="btn-reset-causes" type="button">Nulstil til standard</button>
      </div>

      <div id="causeList" style="margin-top:12px;font-size:14px"></div>
    </div>
  </section>

<script>
/* ======== Hjælpefunktioner og lagring (Edge-kompatibel) ======== */

// Simpelt shorthand
function byId(id){ return document.getElementById(id); }
function show(el){ if(el) el.style.display=''; }
function hide(el){ if(el) el.style.display='none'; }

// Simpel class-styring
function addClass(el,c){ if(el && el.className.indexOf(c)<0){ el.className += (el.className?' ':'')+c; } }
function remClass(el,c){ if(!el) return; el.className = el.className.split(' ').filter(function(x){return x!==c;}).join(' '); }

// Pad med 0
function pad(n){ return (n<10?'0':'')+n; }

// Datoformat
function fmtDate(d){
  var dt=(d instanceof Date)?d:new Date(d);
  try{return dt.toLocaleString('da-DK');}
  catch(e){return dt.toString();}
}

// Varighed format (hh:mm:ss)
function fmtDur(ms){
  var s=Math.floor((ms||0)/1000);
  var h=pad(Math.floor(s/3600));
  var m=pad(Math.floor((s%3600)/60));
  var ss=pad(s%60);
  return h+':'+m+':'+ss;
}

// Simpel UUID
function uuid(){
  return 'id-'+Date.now()+'-'+Math.floor(Math.random()*100000);
}

// Lagringsnøgler
var STORAGE='produktionsstop.events.v3';
var SETTINGS='produktionsstop.settings.v3';

// Load / save data
function loadEvents(){
  try{ return JSON.parse(localStorage.getItem(STORAGE))||[]; }
  catch(e){ return []; }
}
function saveEvents(x){ localStorage.setItem(STORAGE, JSON.stringify(x)); }

function loadSettings(){
  try{ return JSON.parse(localStorage.getItem(SETTINGS))||{}; }
  catch(e){ return {}; }
}
function saveSettings(x){ localStorage.setItem(SETTINGS, JSON.stringify(x)); }

  /* ======== Status & timer (kompatibel med gammel Edge) ======== */

var IS_STOPPED=false;
var STOP_START_ISO=null;
var stopMeta=null;
var timer=null;

// Opdater statusvisning
function setStatus(st){
  IS_STOPPED = st;
  byId('btn-stop').disabled = st;
  byId('btn-start').disabled = !st;
  byId('dot').style.background = st ? 'var(--danger)' : 'var(--ok)';
  byId('statxt').textContent = st ? 'Stoppet' : 'Kører';
  byId('liveTimer').textContent = st ? '00:00:00' : '—';
}

// Opdater kørende stop-timer
function tick(){
  if(!IS_STOPPED || !STOP_START_ISO) return;
  var ms = Date.now() - new Date(STOP_START_ISO).getTime();
  byId('liveTimer').textContent = fmtDur(ms);
}

// Check at krævede felter er udfyldt
function hasRequired(){
  var o=(byId('orderNo').value||'').trim();
  var i=(byId('itemNo').value||'').trim();
  return o && i;
}

// STOP-funktion
function handleStop(){
  if(!hasRequired()){
    byId('stopValidation').textContent='Udfyld Ordre nr. og Vare nr. før du bekræfter.';
    return;
  }
  var reason=(byId('stop-reason').value||'Andet').trim();
  var comment=(byId('stop-comment').value||'').trim();
  stopMeta={reason:reason,comment:comment};
  STOP_START_ISO=new Date().toISOString();
  setStatus(true);
  hide(byId('ov-stop'));
  if(timer) clearInterval(timer);
  timer=setInterval(tick,1000);
  tick();
}

// START-funktion
function handleStart(){
  if(!IS_STOPPED) return;
  var end=new Date();
  var start=new Date(STOP_START_ISO);
  var duration=end-start;

  var rows=loadEvents();
  rows.push({
    id:uuid(),
    start:start.toISOString(),
    end:end.toISOString(),
    durationMs:duration,
    line:(byId('line').value||''),
    orderNo:(byId('orderNo').value||''),
    itemNo:(byId('itemNo').value||''),
    operator:(byId('operator').value||''),
    reason:stopMeta?stopMeta.reason:'',
    comment:stopMeta?stopMeta.comment:''
  });
  saveEvents(rows);

  setStatus(false);
  STOP_START_ISO=null;
  stopMeta=null;
  if(timer){clearInterval(timer); timer=null;}
}


/* ======== Knap- og modalstyring ======== */

// Åbn/luk stopmodal
function openStopModal(){
  byId('stopValidation').textContent='';
  byId('stop-reason').value='';
  byId('stop-comment').value='';
  show(byId('ov-stop'));
  byId('ov-stop').style.display='flex';
}
function closeStopModal(){ hide(byId('ov-stop')); }

// Ryd linje og ordre
function clearOrder(){
  byId('orderNo').value='';
  byId('itemNo').value='';
}
function clearLine(){
  byId('line').value='';
  byId('operator').value='';
}

// Knapbindinger
function bindButtons(){
  var btnStop=byId('btn-stop');
  var btnStart=byId('btn-start');
  var btnClearOrder=byId('btn-clear-order');
  var btnClearLine=byId('btn-clear-line');
  var stopClose=byId('stop-close');
  var stopCancel=byId('stop-cancel');
  var stopConfirm=byId('stop-confirm');

  if(btnStop) btnStop.onclick=function(){ openStopModal(); };
  if(btnStart) btnStart.onclick=function(){ handleStart(); };
  if(btnClearOrder) btnClearOrder.onclick=function(){ clearOrder(); };
  if(btnClearLine) btnClearLine.onclick=function(){ clearLine(); };
  if(stopClose) stopClose.onclick=function(){ closeStopModal(); };
  if(stopCancel) stopCancel.onclick=function(){ closeStopModal(); };
  if(stopConfirm) stopConfirm.onclick=function(){ handleStop(); };

  // Tastaturgenveje (Ctrl+S, Ctrl+A)
  document.addEventListener('keydown', function(ev){
    if(ev.ctrlKey && (ev.key==='s' || ev.key==='S')){
      ev.preventDefault();
      if(!IS_STOPPED){ openStopModal(); }
    }
    if(ev.ctrlKey && (ev.key==='a' || ev.key==='A')){
      ev.preventDefault();
      if(IS_STOPPED){ handleStart(); }
    }
  });
}

 /* ======== Indstillinger (tema & farver) ======== */

function applyTheme(theme){
  if(theme==='dark'){
    document.body.style.background='#0b1220';
    document.body.style.color='#e5e7eb';
  }else{
    document.body.style.background='var(--bg)';
    document.body.style.color='var(--text)';
  }
}

function applyBrand(){
  var s=loadSettings();
  if(s.brandColor){
    document.documentElement.style.setProperty('--brand',s.brandColor);
  }
  var defTo=byId('defTo');
  var brandColor=byId('brandColor');
  var themeSelect=byId('themeSelect');
  if(defTo) defTo.value=s.defaultTo||'vedligehold@pluspack.com';
  if(brandColor) brandColor.value=s.brandColor||'#0a61ae';
  if(themeSelect) themeSelect.value=s.theme||'standard';
  applyTheme(s.theme||'standard');
}

function bindSettings(){
  var btnSave=byId('btn-save-settings');
  if(btnSave){
    btnSave.onclick=function(){
      var s=loadSettings();
      s.defaultTo=(byId('defTo').value||'').trim();
      s.brandColor=(byId('brandColor').value||'#0a61ae').trim();
      s.theme=byId('themeSelect').value||'standard';
      saveSettings(s);
      applyBrand();
      alert('Indstillinger gemt.');
    };
  }
}
 
  /* ======== Årsager – tilføj, vis og nulstil ======== */

function getAllCauses(){
  var s = loadSettings();
  var list = s.customCauses || [];
  return list;
}

function renderCustomList(){
  var container = byId('causeList');
  var s = loadSettings();
  var list = s.customCauses || [];
  if(!container) return;
  if(list.length===0){
    container.innerHTML = '<p class="muted">Ingen brugerdefinerede årsager endnu.</p>';
    return;
  }

  var html = '<table style="width:100%;border-collapse:collapse">';
  html += '<thead><tr style="background:#f9fafb">';
  html += '<th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Kode</th>';
  html += '<th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Label</th>';
  html += '<th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Chips</th>';
  html += '<th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Handling</th>';
  html += '</tr></thead><tbody>';

  for(var i=0;i<list.length;i++){
    var it=list[i];
    html += '<tr>';
    html += '<td style="padding:6px;border-bottom:1px solid #e5e7eb">'+it.code+'</td>';
    html += '<td style="padding:6px;border-bottom:1px solid #e5e7eb">'+it.label+'</td>';
    html += '<td style="padding:6px;border-bottom:1px solid #e5e7eb">'+(it.chips||[]).join(', ')+'</td>';
    html += '<td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right"><button class="btn" data-del="'+it.code+'">Slet</button></td>';
    html += '</tr>';
  }
  html += '</tbody></table>';
  container.innerHTML = html;

  var buttons = container.querySelectorAll('button[data-del]');
  for(var j=0;j<buttons.length;j++){
    buttons[j].onclick=function(){
      var code=this.getAttribute('data-del');
      var s=loadSettings();
      var arr=s.customCauses||[];
      var newArr=[];
      for(var k=0;k<arr.length;k++){
        if(arr[k].code!==code) newArr.push(arr[k]);
      }
      s.customCauses=newArr;
      saveSettings(s);
      renderCustomList();
    };
  }
}

function bindCauseButtons(){
  var btnAdd = byId('btn-add-cause');
  var btnReset = byId('btn-reset-causes');

  if(btnAdd){
    btnAdd.onclick=function(){
      var code=(byId('causeCode').value||'').trim().toUpperCase();
      var label=(byId('causeLabel').value||'').trim();
      var chipsRaw=(byId('causeChips').value||'').split(',');
      var chips=[];
      for(var i=0;i<chipsRaw.length;i++){
        var c=chipsRaw[i].trim();
        if(c) chips.push(c);
      }

      if(!code || !label){ alert('Udfyld både kode og label.'); return; }

      var s=loadSettings();
      if(!s.customCauses) s.customCauses=[];
      s.customCauses.push({code:code,label:label,chips:chips});
      saveSettings(s);
      renderCustomList();

      byId('causeCode').value='';
      byId('causeLabel').value='';
      byId('causeChips').value='';
    };
  }

  if(btnReset){
    btnReset.onclick=function(){
      if(confirm('Vil du nulstille alle egne årsager?')){
        var s=loadSettings();
        s.customCauses=[];
        saveSettings(s);
        renderCustomList();
      }
    };
  }
}

/* ======== Faneskift (Handling <-> Indstillinger) ======== */

function setActiveTab(which){
  var tabHandling = byId('tab-handling');
  var tabSettings = byId('tab-settings');
  var viewHandling = byId('view-handling');
  var viewSettings = byId('view-settings');

  if(which==='handling'){
    addClass(tabHandling,'active');
    remClass(tabSettings,'active');
    show(viewHandling);
    hide(viewSettings);
  }else{
    addClass(tabSettings,'active');
    remClass(tabHandling,'active');
    show(viewSettings);
    hide(viewHandling);
  }
}

function bindTabs(){
  var tabHandling = byId('tab-handling');
  var tabSettings = byId('tab-settings');
  if(tabHandling) tabHandling.onclick=function(){ setActiveTab('handling'); };
  if(tabSettings) tabSettings.onclick=function(){ setActiveTab('settings'); };
}

/* ======== Tema ved første load ======== */
function initThemeOnLoad(){
  var s = loadSettings();
  applyBrand();
  applyTheme(s.theme||'standard');
}

  /* ======== Faneskift (Handling <-> Indstillinger) ======== */

function setActiveTab(which){
  var tabHandling = byId('tab-handling');
  var tabSettings = byId('tab-settings');
  var viewHandling = byId('view-handling');
  var viewSettings = byId('view-settings');

  if(which==='handling'){
    addClass(tabHandling,'active');
    remClass(tabSettings,'active');
    show(viewHandling);
    hide(viewSettings);
  }else{
    addClass(tabSettings,'active');
    remClass(tabHandling,'active');
    show(viewSettings);
    hide(viewHandling);
  }
}

function bindTabs(){
  var tabHandling = byId('tab-handling');
  var tabSettings = byId('tab-settings');
  if(tabHandling) tabHandling.onclick=function(){ setActiveTab('handling'); };
  if(tabSettings) tabSettings.onclick=function(){ setActiveTab('settings'); };
}

/* ======== Tema ved første load ======== */
function initThemeOnLoad(){
  var s = loadSettings();
  applyBrand();
  applyTheme(s.theme||'standard');
}

/* ======== Init – samler alt ======== */

function bindInputSync(){
  var line = byId('line');
  var operator = byId('operator');
  var orderNo = byId('orderNo');
  var itemNo = byId('itemNo');

  function sync(){
    var s=loadSettings();
    s.line = (line && line.value)||'';
    s.operator = (operator && operator.value)||'';
    s.orderNo = (orderNo && orderNo.value)||'';
    s.itemNo = (itemNo && itemNo.value)||'';
    saveSettings(s);
  }

  if(line) line.onchange = sync;
  if(operator) operator.oninput = sync;
  if(orderNo) orderNo.oninput = sync;
  if(itemNo) itemNo.oninput = sync;
}

function restoreFormFromSettings(){
  var s=loadSettings();
  if(byId('line')) byId('line').value = s.line || '';
  if(byId('operator')) byId('operator').value = s.operator || '';
  if(byId('orderNo')) byId('orderNo').value = s.orderNo || '';
  if(byId('itemNo')) byId('itemNo').value = s.itemNo || '';
}

function init(){
  try{
    // Tema & brand
    initThemeOnLoad();
    applyBrand();

    // Faner
    bindTabs();
    setActiveTab('handling');

    // Knapper
    bindButtons();

    // Indstillinger
    bindSettings();
    bindCauseButtons();
    renderCustomList();

    // Formular-værdier
    restoreFormFromSettings();
    bindInputSync();

    // Start-tilstand
    setStatus(false);

    // Genoptag evt. igangværende stop (se DEL 12)
    resumeCurrentStopIfAny();

  }catch(err){
    alert('Init-fejl: '+(err&&err.message?err.message:err));
  }
}
document.addEventListener('DOMContentLoaded', init);
/* ======== Vedvarende aktuelt stop (localStorage) ======== */

var CURRENT_STOP_KEY = 'produktionsstop.current.v1';

function loadCurrentStop(){
  try{ return JSON.parse(localStorage.getItem(CURRENT_STOP_KEY)); }
  catch(e){ return null; }
}
function saveCurrentStop(obj){
  localStorage.setItem(CURRENT_STOP_KEY, JSON.stringify(obj||{}));
}
function clearCurrentStop(){
  localStorage.removeItem(CURRENT_STOP_KEY);
}

function resumeCurrentStopIfAny(){
  var cur = loadCurrentStop();
  if(cur && cur.start){
    STOP_START_ISO = cur.start;
    stopMeta = cur.meta || null;
    setStatus(true);
    if(timer) clearInterval(timer);
    timer = setInterval(tick,1000);
    tick();
  }
}

// Patch STOP/START til at gemme/rydde
var _origHandleStop = handleStop;
handleStop = function(){
  // Kør original
  _origHandleStop();
  // Gem igangværende stop
  if(IS_STOPPED && STOP_START_ISO){
    saveCurrentStop({ start: STOP_START_ISO, meta: stopMeta||{} });
  }
};

var _origHandleStart = handleStart;
handleStart = function(){
  _origHandleStart();
  // Slet igangværende stop
  clearCurrentStop();
};
/* ======== Rep-seddel som mail-kladde ======== */

function defaultEmailSubject(){
  var line=(byId('line').value||'');
  var ord=(byId('orderNo').value||'');
  var d=new Date();
  var dateTxt;
  try{
    dateTxt = d.toLocaleDateString('da-DK');
  }catch(e){
    var dd = pad(d.getDate()), mm = pad(d.getMonth()+1), yy = d.getFullYear();
    dateTxt = dd+'/'+mm+'/'+yy;
  }
  var subj = 'Reparationsseddel';
  if(line) subj += ' – '+line;
  if(ord) subj += ' – Ordre '+ord;
  subj += ' – '+dateTxt;
  return subj;
}

function openRepMailDraft(){
  var s=loadSettings();
  var to = (s.defaultTo||'vedligehold@pluspack.com');
  var subj = defaultEmailSubject();
  var body = ''
    + 'Linje: '+(byId('line').value||'')+'\n'
    + 'Ordre/Vare: '+(byId('orderNo').value||'')+' / '+(byId('itemNo').value||'')+'\n'
    + 'Operatør: '+(byId('operator').value||'')+'\n\n'
    + 'Beskrivelse:\n';

  var href='mailto:'+encodeURIComponent(to)
    + '?subject='+encodeURIComponent(subj)
    + '&body='+encodeURIComponent(body);

  window.location.href = href;
}

(function(){
  var btn = byId('btn-open-rep');
  if(btn){ btn.onclick = function(){ openRepMailDraft(); }; }
})();
/* ======== Hjælp: nulstil validering ved åbning ======== */
(function(){
  var btnStop = byId('btn-stop');
  if(btnStop){
    var old = btnStop.onclick;
    btnStop.onclick = function(){
      byId('stopValidation').textContent='';
      if(old) old();
    };
  }
})();
/* ======== Modal display fix for ældre Edge ======== */
(function(){
  var ov = byId('ov-stop');
  if(!ov) return;
  // Force computed style to flex når vi åbner via show()
  var openStopModalOld = openStopModal;
  openStopModal = function(){
    openStopModalOld();
    ov.style.display='flex';
  };
})();
/* ======== Defensive date formatting (Edge Legacy) ======== */
(function(){
  // Test at toLocaleString findes og 'da-DK' ikke crasher
  try{
    new Date().toLocaleString('da-DK');
  }catch(e){
    // Intet at gøre – vores fmtDate() falder tilbage til toString()
  }
})();
/* ======== Mørkt tema – bedre kontrast ======== */
(function(){
  // Når tema skiftes, applyTheme kaldes; her justerer vi kort/knapper ved mørk
  var oldApplyTheme = applyTheme;
  applyTheme = function(theme){
    oldApplyTheme(theme);
    if(theme==='dark'){
      // Kort & input
      var css = document.createElement('style');
      css.setAttribute('data-dark-extra','1');
      css.textContent = ''
        + '.card{background:#111827;border-color:#1f2937;color:#e5e7eb}'
        + 'input,select,textarea{background:#0f172a;border-color:#1f2937;color:#e5e7eb}'
        + '.tabs{background:#0f172a;border-color:#1f2937}'
        + '.tab.active{background:#111827}'
        + '.btn{background:#0f172a;border-color:#1f2937;color:#e5e7eb}'
        + '.btn:hover{background:#111827}';
      // Fjern eksisterende hvis findes
      var olds=document.querySelectorAll('style[data-dark-extra]');
      for(var i=0;i<olds.length;i++){ olds[i].parentNode.removeChild(olds[i]); }
      document.head.appendChild(css);
    }else{
      var olds=document.querySelectorAll('style[data-dark-extra]');
      for(var j=0;j<olds.length;j++){ olds[j].parentNode.removeChild(olds[j]); }
    }
  };
})();
/* ======== Hjælpetekst for krævede felter ======== */
(function(){
  var order = byId('orderNo');
  var item = byId('itemNo');
  function hint(el){
    if(!el) return;
    el.setAttribute('placeholder', (el===order?'Påkrævet – ':'Påkrævet – ') + (el===order?'Ordre nr.':'Vare nr.'));
  }
  hint(order);
  hint(item);
})();
/* ======== Forhindre implicit form-submit i gammel Edge ======== */
(function(){
  var btns = document.querySelectorAll('button');
  for(var i=0;i<btns.length;i++){
    if(!btns[i].getAttribute('type')){
      btns[i].setAttribute('type','button');
    }
  }
})();
/* ======== Robust localStorage (private mode/fejl) ======== */
(function(){
  try{
    localStorage.setItem('__pp_test__','1');
    localStorage.removeItem('__pp_test__');
  }catch(e){
    // Deaktiver lagring-funktioner hvis localStorage ikke må bruges
    loadEvents = function(){ return []; };
    saveEvents = function(){ /* no-op */ };
    loadSettings = function(){ return {}; };
    saveSettings = function(){ /* no-op */ };
    alert('Bemærk: Lagring er deaktiveret i denne browser/tilstand (localStorage utilgængelig).');
  }
})();
</script>
</div> <!-- /.container -->

</body>
</html>
