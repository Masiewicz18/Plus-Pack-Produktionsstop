<!doctype html>
<html lang="da">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Plus Pack – Produktionsstop (Edge Legacy kompatibel)</title>

<style>
/* ==== BASIS-FARVER OG LAYOUT (samme look) ==== */
:root{
  --brand:#0a61ae; --bg:#f6f8fb; --panel:#fff;
  --divider:#e7edf4; --text:#0f172a; --muted:#64748b;
  --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  --accent:#2563eb; --accent2:#06b6d4;
  --shadow:0 6px 24px rgba(15,23,42,.06);
}
*{box-sizing:border-box;-ms-touch-action:manipulation;}
html,body{height:100%;}
body{
  margin:0;
  font-family:"Segoe UI",Arial,Helvetica,sans-serif;
  background:var(--bg); color:var(--text);
}
.brand{background:var(--brand);color:#fff;padding:12px 18px;
  font-weight:800;letter-spacing:.2px;}
.container{max-width:1160px;margin:0 auto;padding:16px;}
.card{background:var(--panel);border:1px solid var(--divider);
  border-radius:16px;padding:16px;margin-bottom:14px;
  box-shadow:var(--shadow);}
.muted{color:var(--muted);}
.right{text-align:right;}
label{font-size:12px;color:var(--muted);}
input,select,textarea{
  border:1px solid var(--divider);border-radius:10px;
  padding:10px 12px;background:#fff;color:var(--text);
}
textarea{min-height:84px;}
.btn{
  border:1px solid var(--divider);background:#fff;
  padding:12px 16px;border-radius:12px;
  cursor:pointer;font-weight:800;
}
.btn[disabled]{opacity:.5;cursor:not-allowed;}

/* Klassisk flex-fallback (ikke CSS grid) */
.row{display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;flex-wrap:wrap;margin:0 -6px;}
.col{padding:0 6px;-ms-flex:1;flex:1;min-width:0;}

/* Tabs / status */
.tabs{display:-ms-flexbox;display:flex;-ms-flex-wrap:wrap;
  flex-wrap:wrap;gap:8px;background:#fff;border-bottom:1px solid var(--divider);
  padding:8px 10px;align-items:center;position:sticky;top:0;z-index:9;}
.tab{border:0;background:transparent;padding:10px 14px;border-radius:10px;
  cursor:pointer;font-weight:800;}
.tab.active{background:#f8fafc;border:1px solid var(--divider);}
.status{margin-left:auto;display:-ms-inline-flexbox;display:inline-flex;
  -ms-flex-align:center;align-items:center;gap:10px;background:#fff;
  border:1px solid var(--divider);padding:6px 10px;border-radius:999px;}
.dot{width:12px;height:12px;border-radius:999px;background:var(--ok);
  box-shadow:0 0 0 2px rgba(0,0,0,.04) inset;}
.bigTimer{margin:10px 0 0;
  font:700 44px/1.1 Consolas,monospace;letter-spacing:.5px;color:#111827;}
.bigTimer .lbl{display:block;font:600 12px/1 "Segoe UI",Arial;
  color:var(--muted);letter-spacing:.2px;margin-bottom:4px;}

/* Overlays */
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,.35);display:none;
  -ms-flex-align:center;align-items:center;
  -ms-flex-pack:center;justify-content:center;z-index:1000;}
.overlay.open{display:-ms-flexbox;display:flex;}
.modal{background:#fff;border:1px solid var(--divider);border-radius:14px;
  max-width:980px;width:96vw;box-shadow:0 30px 80px rgba(0,0,0,.25);}
.modal-h,.modal-f{display:-ms-flexbox;display:flex;
  -ms-flex-pack:justify;justify-content:space-between;
  -ms-flex-align:center;align-items:center;padding:12px 14px;
  border-color:var(--divider);}
.modal-h{border-bottom:1px solid var(--divider);}
.modal-b{padding:12px 14px;}
.modal-f{border-top:1px solid var(--divider);gap:8px;}

/* Mørkt tema */
html[data-theme="dark"] body{background:#0b1220;color:#e5e7eb;}
html[data-theme="dark"] .card,
html[data-theme="dark"] .tabs,
html[data-theme="dark"] .status{background:#111827;border-color:#1f2937;}
html[data-theme="dark"] input,
html[data-theme="dark"] select,
html[data-theme="dark"] textarea,
html[data-theme="dark"] .btn{background:#0f172a;border-color:#1f2937;color:#e5e7eb;}
html[data-theme="dark"] .muted{color:#9ca3af;}
</style>

<script>
/* ==== POLYFILLS FOR EDGE LEGACY ==== */
if(!Array.prototype.forEach){Array.prototype.forEach=function(cb){for(var i=0;i<this.length;i++)cb(this[i],i,this);};}
if(!Array.prototype.filter){Array.prototype.filter=function(cb){var a=[];for(var i=0;i<this.length;i++){if(cb(this[i],i,this))a.push(this[i]);}return a;};}
if(!Array.prototype.map){Array.prototype.map=function(cb){var a=[];for(var i=0;i<this.length;i++)a.push(cb(this[i],i,this));return a;};}
if(!String.prototype.padStart){String.prototype.padStart=function(len,chr){var s=this;chr=chr||' ';while(s.length<len)s=chr+s;return s;};}
if(!String.prototype.includes){String.prototype.includes=function(x){return this.indexOf(x)!==-1;};}
if(!window.console){window.console={log:function(){},warn:function(){},error:function(){}};}

/* ==== BASALE HJÆLPEFUNKTIONER ==== */
function byId(id){return document.getElementById(id);}
function addClass(el,c){if(!el)return;var a=el.className.split(' ');if(a.indexOf(c)===-1){a.push(c);el.className=a.join(' ');}}
function remClass(el,c){if(!el)return;var a=el.className.split(' ');var i=a.indexOf(c);if(i>-1){a.splice(i,1);}el.className=a.join(' ');}
function show(el){if(el)el.style.display='';}
function hide(el){if(el)el.style.display='none';}
function pad(n){return (n<10?'0':'')+n;}
function fmtDate(d){
  var dt=(d instanceof Date)?d:new Date(d);
  try{return dt.toLocaleString('da-DK');}
  catch(e){return dt.toString();}
}
function fmtDur(ms){
  var s=Math.floor((ms||0)/1000),
      h=pad(Math.floor(s/3600)),
      m=pad(Math.floor((s%3600)/60)),
      ss=pad(s%60);
  return h+':'+m+':'+ss;
}
</script>

</head>
<body>
<div class="brand">Plus Pack – Produktionsstop</div>

<!-- Faner og status -->
<div class="tabs">
  <button class="tab active" id="tab-handling" type="button">Handling</button>
  <button class="tab" id="tab-stats" type="button">Stop-statistik</button>
  <button class="tab" id="tab-hist" type="button">Historik</button>
  <button class="tab" id="tab-share" type="button">Deling</button>
  <button class="tab" id="tab-settings" type="button">Indstillinger</button>

  <div class="status">
    <span class="dot" id="dot"></span>
    <span id="statxt">Kører</span>
  </div>
</div>

<div class="container">

<!-- HANDLING-SEKTION -->
<section id="view-handling">
  <div class="card">
    <div class="row" style="margin-bottom:10px">
      <div class="col">
        <button class="btn btn-stop" id="btn-stop" type="button"
          style="background:linear-gradient(180deg,rgba(220,38,38,.10),rgba(220,38,38,.04));
                 border-color:#f2aaaa;color:#7f1d1d;font-size:22px;padding:18px;width:100%;">
          ⏹ STOP (Ctrl+S)
        </button>
      </div>
      <div class="col">
        <button class="btn btn-start" id="btn-start" type="button" disabled
          style="background:linear-gradient(180deg,rgba(16,185,129,.10),rgba(16,185,129,.04));
                 border-color:#a6e3b9;color:#065f46;font-size:22px;padding:18px;width:100%;">
          ▶ START (Ctrl+A)
        </button>
      </div>
    </div>

    <div class="bigTimer">
      <span class="lbl">Aktuelt stop</span>
      <span id="liveTimer">—</span>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="row">
        <div class="col" style="min-width:240px">
          <label>Linje / maskine</label>
          <select id="line" style="width:100%">
            <option value="">— Vælg maskine —</option>
            <option>L10 75 t Rhodes special presse</option>
            <option>L11 Mech RF135 serie nr 18-11 Mnr888</option>
            <option disabled>L12 30 t Flexo C30 S15 INAKTIV</option>
            <option>L13 Press Beutler PD 40</option>
            <option>L14 50 t Flexo C50 S20 presse</option>
            <option>L15 30 t Flexo C30 S15 presse</option>
            <option>L16 40 t Schuler PNH 40/250 presse</option>
            <option>L17 30 t Flexo C30 S15 presse</option>
            <option>L20 50 t Bliss 50F MKII presse</option>
            <option>L22 50 t Bliss 50F MKII presse</option>
            <option>L23 45 t Bliss 21½ presse</option>
            <option>L24 30 t Flexo C30 S15</option>
            <option>L25 30 t Flexo C30 X presse</option>
            <option>L26 L 36 30 t Flexo C30 S 15 presse</option>
            <option>L27 45 t Bliss 21½ presse</option>
            <option>L28 50 t Flexo presse</option>
            <option>L29 30 t Flexo C30 presse</option>
            <option>L30 ny presse 2012</option>
            <option>L33 50 t Bliss 50F MKII presse</option>
            <option>L34 50 t Bliss 50F MKII presse</option>
            <option>L35 30 t Flexo C30 S15 presse</option>
            <option>L36 30 t Flexo C30 S15 presse Picop</option>
            <option>L40 50 t Flexo C50 S20 presse</option>
            <option>L41 L37, 50 t Bliss 50F MKII presse</option>
            <option>L42 Press Beutler PD 40 alu spez638</option>
            <option>L43 Press Beutler PD 40 alu spez637</option>
            <option>L80 Choko-kapsler</option>
            <option>L81 Lys-manchetter</option>
            <option>L82 Lys-manchetter</option>
          </select>
        </div>

        <div class="col">
          <label>Ordre nr. (krævet)</label>
          <input id="orderNo" type="text" style="width:100%">
        </div>

        <div class="col">
          <label>Vare nr. (krævet)</label>
          <input id="itemNo" type="text" style="width:100%">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Operatør (valgfri)</label>
          <input id="operator" type="text" placeholder="Navn/initialer" style="width:100%">
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <button class="btn" id="btn-clear-order" type="button" style="width:100%">Ryd ordre</button>
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <div style="display:-ms-flexbox;display:flex;gap:8px;-ms-flex-wrap:wrap;flex-wrap:wrap">
            <button class="btn" id="btn-clear-line" type="button">Ryd linje/navn</button>
            <button class="btn" id="btn-open-rep" type="button">Åbn rep-seddel</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

  <!-- AKTIVITET (8 timer) -->
  <div class="card">
    <h3 style="margin:0 0 8px;font-weight:900">Aktivitet – sidste 8 timer</h3>
    <svg class="activity" viewBox="0 0 920 140" id="activity8h"
         style="width:100%;height:140px;border:1px solid var(--divider);
                border-radius:10px;background:#fbfdff;"></svg>
    <p class="muted small" style="margin-top:6px">
      Røde felter = registrerede stop. Højre kant er nu.
    </p>
  </div>

  <!-- LOG-LISTE -->
  <div class="card">
    <h4 style="margin:0 0 8px;font-weight:900">Aktivitetslog (sidste 8 timer)</h4>
    <ul class="loglist" id="log8h"
        style="list-style:none;margin:0;padding:0;
               max-height:180px;overflow:auto;
               border:1px dashed #d8e0eb;border-radius:12px;background:#fff;">
      <!-- Dynamisk indhold indsættes via JS -->
    </ul>
  </div>

  <!-- OVERLEVERING -->
  <div class="card">
    <h4 style="margin:0 0 8px;font-weight:900">Overlevering / skift-noter</h4>

    <div class="row">
      <div class="col">
        <label>Noter til næste skift</label>
        <textarea id="handoverText"
          placeholder="Skriv kort status, åbne punkter, kendte fejl osv."
          style="width:100%;"></textarea>
      </div>
      <div class="col">
        <label>Tag (valgfrit)</label>
        <input id="handoverTag" type="text" placeholder="fx Vedligehold, Kvalitet, Værktøj"
               style="width:100%;">
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="col">
        <button class="btn btn-start" id="handoverSave" type="button" style="width:100%;">
          Gem note
        </button>
      </div>
      <div class="col">
        <button class="btn" id="handoverClear" type="button" style="width:100%;">
          Ryd felt
        </button>
      </div>
    </div>

    <div id="handoverList" style="margin-top:12px;"></div>
  </div>
</section>

  <!-- STOP-MODAL -->
<div class="overlay" id="ov-stop">
  <div class="modal">
    <div class="modal-h">
      <strong>Registrér stop</strong>
      <button class="btn" id="stop-close" type="button">Luk</button>
    </div>

    <div class="modal-b">
      <div class="row">
        <div class="col" style="min-width:260px">
          <label>Årsag</label>
          <div id="reasonTop" style="margin-top:6px;display:-ms-flexbox;display:flex;flex-wrap:wrap;gap:8px;"></div>
          <div id="reasonMore" style="margin-top:8px;display:-ms-flexbox;display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>
        <div class="col" style="min-width:260px">
          <label>Uddybning (chips)</label>
          <div id="reasonChips" style="margin-top:6px;display:-ms-flexbox;display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Andet</label>
          <input id="other" type="text" style="width:100%;">
        </div>
        <div class="col">
          <label>Kommentar</label>
          <input id="comment" type="text" style="width:100%;">
        </div>
      </div>
      <p id="stopValidation" class="muted" style="margin-top:6px;"></p>
    </div>

    <div class="modal-f">
      <button class="btn" id="stop-cancel" type="button">Annuller</button>
      <button class="btn btn-stop" id="stop-confirm" type="button">Bekræft stop</button>
    </div>
  </div>
</div>

<!-- REPARATIONSMODAL -->
<div class="overlay" id="ov-rep">
  <div class="modal">
    <div class="modal-h">
      <strong>Reparationsseddel</strong>
      <button class="btn" id="rep-close" type="button">Luk</button>
    </div>

    <div class="modal-b">
      <div class="row">
        <div class="col">
          <label>Modtager</label>
          <input id="rep-to" type="email" placeholder="vedligehold@pluspack.com" style="width:100%;">
        </div>
        <div class="col">
          <label>CC</label>
          <input id="rep-cc" type="text" placeholder="valgfri, kommasepareret" style="width:100%;">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Emne</label>
          <input id="rep-subj" type="text" placeholder="Reparationsseddel – [Linje] [Ordre]/[Vare]" style="width:100%;">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col">
          <label>Prioritet</label>
          <select id="rep-pri" style="width:100%;">
            <option>Lav</option>
            <option>Mellem</option>
            <option>Høj</option>
            <option>Kritisk</option>
          </select>
        </div>
        <div class="col">
          <label>Fejltype</label>
          <input id="rep-type" type="text" placeholder="fx Mekanisk, Elektrisk" style="width:100%;">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="col" style="width:100%">
          <label>Beskrivelse</label>
          <textarea id="rep-desc"
            placeholder="Kort og præcis beskrivelse (symptomer, hvornår, hvad er prøvet)"
            style="width:100%;"></textarea>
        </div>
      </div>
      <p class="muted" id="repValidation"></p>
    </div>

    <div class="modal-f">
      <button class="btn" id="rep-download" type="button">Download TXT</button>
      <button class="btn btn-start" id="rep-send" type="button">Åbn mail</button>
    </div>
  </div>
</div>
<!-- STOP-STATISTIK -->
<section id="view-stats" style="display:none">
  <div class="card">
    <div class="row" style="margin-bottom:8px;-ms-flex-align:center;align-items:center;">
      <div class="col">
        <h3 style="margin:0">Stop-statistik</h3>
      </div>
      <div class="col" style="text-align:right">
        <label class="small">Skift:</label>
        <select id="shiftSelect" style="min-width:140px;">
          <option value="all">Alle stop</option>
          <option value="current">Nuværende skift</option>
          <option value="day">Dag (06-14)</option>
          <option value="evening">Aften (14-22)</option>
          <option value="night">Nat (22-06)</option>
        </select>
        &nbsp;&nbsp;
        <label class="small">Vis:</label>
        <select id="paretoMode" style="min-width:220px;">
          <option value="freq">Procentfordeling (hyppighed)</option>
          <option value="dur">Procentfordeling (varighed)</option>
        </select>
      </div>
    </div>

    <!-- KPI-FELTER -->
    <div style="display:-ms-flexbox;display:flex;flex-wrap:wrap;gap:14px;">
      <div class="kpi" style="flex:1;min-width:180px;background:#f8fafc;border:1px solid var(--divider);border-radius:12px;padding:10px;">
        <div class="small muted">Antal stop</div>
        <div class="val" id="kpi-count" style="font-weight:900;font-size:24px;">0</div>
        <div class="small muted">Poster i alt</div>
      </div>
      <div class="kpi" style="flex:1;min-width:180px;background:#f8fafc;border:1px solid var(--divider);border-radius:12px;padding:10px;">
        <div class="small muted">Samlet varighed</div>
        <div class="val" id="kpi-dur" style="font-weight:900;font-size:24px;">00:00:00</div>
        <div class="small muted">hh:mm:ss</div>
      </div>
      <div class="kpi" style="flex:1;min-width:180px;background:#f8fafc;border:1px solid var(--divider);border-radius:12px;padding:10px;">
        <div class="small muted">Gns. pr. stop</div>
        <div class="val" id="kpi-avg" style="font-weight:900;font-size:24px;">00:00:00</div>
        <div class="small muted">hh:mm:ss</div>
      </div>
      <div class="kpi" style="flex:1;min-width:180px;background:#f8fafc;border:1px solid var(--divider);border-radius:12px;padding:10px;">
        <div class="small muted">Top-årsag</div>
        <div class="val" id="kpi-top" style="font-weight:900;font-size:24px;">—</div>
        <div class="small muted" id="kpi-top-sub">Hyppigst: —</div>
      </div>
    </div>

    <!-- Cirkeldiagrammer -->
    <div class="row" style="margin-top:14px;">
      <div class="col" style="min-width:300px;">
        <div class="small muted" style="margin-bottom:6px">Hyppighed – andele</div>
        <svg id="pie-freq" viewBox="0 0 240 240" style="width:100%;height:220px;border:1px solid var(--divider);border-radius:10px;"></svg>
        <div class="legend" id="legend-freq" style="margin-top:8px;font-size:12px;"></div>
      </div>
      <div class="col" style="min-width:300px;">
        <div class="small muted" style="margin-bottom:6px">Varighed – andele</div>
        <svg id="pie-dur" viewBox="0 0 240 240" style="width:100%;height:220px;border:1px solid var(--divider);border-radius:10px;"></svg>
        <div class="legend" id="legend-dur" style="margin-top:8px;font-size:12px;"></div>
      </div>
    </div>

    <!-- Bar-grafer -->
    <div class="row" style="margin-top:14px;">
      <div class="col" style="min-width:300px;">
        <div class="small" style="font-weight:800;margin-bottom:8px">Hyppighed (antal pr. årsag)</div>
        <div id="bars-freq" style="font-size:12px;"></div>
      </div>
      <div class="col" style="min-width:300px;">
        <div class="small" style="font-weight:800;margin-bottom:8px">Varighed (sum pr. årsag)</div>
        <div id="bars-dur" style="font-size:12px;"></div>
      </div>
    </div>

    <!-- Pareto -->
    <div class="card" style="margin-top:14px;">
      <div style="display:-ms-flexbox;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="font-weight:800">Pareto</div>
        <div class="small muted">Kumulativ %</div>
      </div>
      <svg id="pareto" viewBox="0 0 760 260" style="width:100%;height:260px;border:1px solid var(--divider);border-radius:10px;"></svg>
    </div>
  </div>
</section>

  <!-- HISTORIK -->
<section id="view-hist" style="display:none">
  <div class="card">
    <div style="display:-ms-flexbox;display:flex;-ms-flex-pack:justify;justify-content:space-between;
                -ms-flex-align:center;align-items:center;margin-bottom:10px;">
      <h3 style="margin:0;font-weight:900;">Historik</h3>
      <div>
        <button class="btn" id="btn-export" type="button">Eksportér (CSV)</button>
        <button class="btn" id="btn-clear-hist" type="button">Ryd historik</button>
      </div>
    </div>

    <div style="overflow:auto;max-height:380px;border:1px solid var(--divider);border-radius:12px;">
      <table id="histTable" style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead style="background:#f9fafb;position:sticky;top:0;">
          <tr>
            <th style="text-align:left;padding:6px;border-bottom:1px solid var(--divider);">Start</th>
            <th style="text-align:left;padding:6px;border-bottom:1px solid var(--divider);">Slut</th>
            <th style="text-align:left;padding:6px;border-bottom:1px solid var(--divider);">Varighed</th>
            <th style="text-align:left;padding:6px;border-bottom:1px solid var(--divider);">Linje</th>
            <th style="text-align:left;padding:6px;border-bottom:1px solid var(--divider);">Ordre</th>
            <th style="text-align:left;padding:6px;border-bottom:1px solid var(--divider);">Vare</th>
            <th style="text-align:left;padding:6px;border-bottom:1px solid var(--divider);">Operatør</th>
            <th style="text-align:left;padding:6px;border-bottom:1px solid var(--divider);">Årsag</th>
            <th style="text-align:left;padding:6px;border-bottom:1px solid var(--divider);">Kommentar</th>
          </tr>
        </thead>
        <tbody id="histBody">
          <!-- Indhold fyldes med JavaScript -->
        </tbody>
      </table>
    </div>

    <div class="muted" style="font-size:12px;margin-top:6px;">
      Historikken gemmes lokalt i browserens hukommelse (localStorage).
    </div>
  </div>
</section>
<!-- DELING -->
<section id="view-share" style="display:none">
  <div class="card">
    <h3 style="margin:0 0 8px;font-weight:900;">Deling</h3>

    <p class="muted" style="font-size:13px;margin-bottom:8px;">
      Del eller eksporter stopdata herfra. I ældre Edge kopieres teksten automatisk via
      <b>markér + Ctrl+C</b> hvis kopiering ikke understøttes direkte.
    </p>

    <div class="row" style="margin-bottom:8px;">
      <div class="col">
        <label>Modtager</label>
        <input id="shareMail" type="email" placeholder="fx vedligehold@pluspack.com" style="width:100%;">
      </div>
      <div class="col">
        <label>Emne</label>
        <input id="shareSubj" type="text" placeholder="Stopdata fra [maskine]" style="width:100%;">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <button class="btn btn-start" id="btn-copy" type="button" style="width:100%;">
          Kopiér data
        </button>
      </div>
      <div class="col">
        <button class="btn" id="btn-mail" type="button" style="width:100%;">
          Åbn mail med data
        </button>
      </div>
      <div class="col">
        <button class="btn" id="btn-export-txt" type="button" style="width:100%;">
          Download TXT
        </button>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>Preview</label>
      <textarea id="sharePreview" readonly
        style="width:100%;height:180px;font-family:Consolas,monospace;font-size:12px;"></textarea>
    </div>
  </div>
</section>

  <!-- INDSTILLINGER -->
<section id="view-settings" style="display:none">
  <div class="card">
    <h3 style="margin:0 0 8px;font-weight:900;">Indstillinger</h3>

    <div class="row">
      <div class="col">
        <label>Standard-modtager (mail)</label>
        <input id="defTo" type="email" placeholder="vedligehold@pluspack.com" style="width:100%;">
      </div>

      <div class="col">
        <label>Brandfarve</label>
        <input id="brandColor" type="text" placeholder="#0a61ae" style="width:100%;">
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="col">
        <label>Farvetema</label>
        <select id="themeSelect" style="width:100%;">
          <option value="standard">Standard (lys)</option>
          <option value="dark">Mørk</option>
        </select>
      </div>

      <div class="col">
        <label>&nbsp;</label>
        <button class="btn btn-start" id="btn-save-settings" type="button" style="width:100%;">
          Gem indstillinger
        </button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px;font-weight:900;">Årsager</h3>

    <div class="row">
      <div class="col">
        <label>Kode (fx PRES)</label>
        <input id="causeCode" type="text" placeholder="KODE" style="width:100%;">
      </div>
      <div class="col">
        <label>Navn/label</label>
        <input id="causeLabel" type="text" placeholder="Beskrivelse" style="width:100%;">
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="col">
        <label>Uddybning (kommasepareret)</label>
        <input id="causeChips" type="text" placeholder="fx Rensning, Sikkerhed, Opsætning" style="width:100%;">
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="col">
        <button class="btn" id="btn-add-cause" type="button" style="width:100%;">
          Tilføj årsag
        </button>
      </div>
      <div class="col">
        <button class="btn" id="btn-reset-causes" type="button" style="width:100%;">
          Nulstil til standard
        </button>
      </div>
    </div>

    <div id="causeList" style="margin-top:12px;font-size:13px;border:1px dashed var(--divider);
                               padding:8px;border-radius:8px;background:#fff;">
      <!-- Dynamisk liste udfyldes af JS -->
      <p class="muted" style="margin:0;">Ingen brugerdefinerede årsager endnu.</p>
    </div>
  </div>
</section>

  <script>
// ===== Polyfills (Edge Legacy venlige) ======================================
(function () {
  // NodeList.forEach fallback
  if (window.NodeList && !NodeList.prototype.forEach) {
    NodeList.prototype.forEach = function (cb, thisArg) {
      thisArg = thisArg || window;
      for (var i = 0; i < this.length; i++) {
        cb.call(thisArg, this[i], i, this);
      }
    };
  }

  // String.prototype.startsWith
  if (!String.prototype.startsWith) {
    String.prototype.startsWith = function (search, pos) {
      pos = pos || 0;
      return this.substr(pos, search.length) === search;
    };
  }

  // Array.isArray
  if (!Array.isArray) {
    Array.isArray = function (arg) {
      return Object.prototype.toString.call(arg) === '[object Array]';
    };
  }
})();

// ===== Konstanter (brug var for ES5) ========================================
var STORAGE_EVENTS   = 'produktionsstop.events.v2';
var STORAGE_SETTINGS = 'produktionsstop.settings.v2';
var STORAGE_HANDOVER = 'produktionsstop.handover.v1';
var STORAGE_DRAFT    = 'produktionsstop.handoverDraft.v1';
var CURRENT_STOP_KEY = 'produktionsstop.current.v1';

// V1 -> V2 migreringsnøgler (hvis du har gamle data i browseren)
var V1_EVENTS_KEY    = 'produktionsstop.events.v1';
var V1_SETTINGS_KEY  = 'produktionsstop.settings.v1';

// Standardårsager (kan udvides i Indstillinger)
var DEFAULT_REASONS = [
  { code: 'PRES',  label: 'Presse',            chips: ['Rensning','Smøring','Opsætning'] },
  { code: 'VAERK', label: 'Værktøj',           chips: ['Skift','Slid','Defekt'] },
  { code: 'STAK',  label: 'Stakker',           chips: ['Fejl','Opsamler','Andet'] },
  { code: 'FOLIE', label: 'Manglende folie',   chips: ['Påfyld','Bestilling'] },
  { code: 'ORDRE', label: 'Manglende ordre',   chips: ['Afventer','Uklar ordre'] },
  { code: 'ANDET', label: 'Andet',             chips: ['Sikkerhed','Rengøring'] }
];

// ===== Hjælpere (ingen moderne syntaks) =====================================
function byId(id) { return document.getElementById(id); }

function hasClass(el, c) {
  if (!el) return false;
  var list = (el.className || '').split(' ');
  for (var i = 0; i < list.length; i++) if (list[i] === c) return true;
  return false;
}

function addClass(el, c) {
  if (!el) return;
  if (!hasClass(el, c)) {
    el.className = (el.className ? el.className + ' ' : '') + c;
  }
}

function remClass(el, c) {
  if (!el) return;
  var list = (el.className || '').split(' ');
  var out = [];
  for (var i = 0; i < list.length; i++) if (list[i] !== c && list[i] !== '') out.push(list[i]);
  el.className = out.join(' ');
}

function show(el) { if (el) el.style.display = ''; }
function hide(el) { if (el) el.style.display = 'none'; }

function openOverlay(id) { addClass(byId(id), 'open'); }
function closeOverlay(id) { remClass(byId(id), 'open'); }

function pad2(n) { return (n < 10 ? '0' : '') + n; }

function fmtDate(d) {
  var dt = (d instanceof Date) ? d : new Date(d);
  try { return dt.toLocaleString('da-DK'); }
  catch (e) { return dt.toString(); }
}

function fmtDur(ms) {
  ms = ms || 0;
  var s = Math.floor(ms / 1000);
  var h = pad2(Math.floor(s / 3600));
  var m = pad2(Math.floor((s % 3600) / 60));
  var ss = pad2(s % 60);
  return h + ':' + m + ':' + ss;
}

function fmtShortDur(ms) {
  ms = ms || 0;
  var s = Math.floor(ms / 1000);
  var h = Math.floor(s / 3600);
  var m = Math.floor((s % 3600) / 60);
  var ss = s % 60;
  var txt = '';
  if (h > 0) txt += h + 't ';
  if (m > 0) txt += m + 'm ';
  txt += (ss < 10 ? '0' : '') + ss + 's';
  return txt;
}

// datetime-local helpers
function toLocalInputValue(iso) {
  if (!iso) return '';
  var d = new Date(iso);
  var Y = d.getFullYear();
  var M = pad2(d.getMonth() + 1);
  var D = pad2(d.getDate());
  var H = pad2(d.getHours());
  var I = pad2(d.getMinutes());
  return Y + '-' + M + '-' + D + 'T' + H + ':' + I;
}
function fromLocalInputValue(val) {
  if (!val) return null;
  // Edge legacy accepterer "YYYY-MM-DDTHH:mm"
  return new Date(val);
}

// Simpelt UUID (til lokale rækker)
function pseudoUuid() {
  return 'id-' + (new Date().getTime()) + '-' + Math.floor(Math.random() * 1000000);
}

// Byte-længde (til "plads" indikator)
function bytesLen(str) {
  try {
    return unescape(encodeURIComponent(str || '')).length;
  } catch (e) {
    return (str || '').length;
  }
}

// ===== Sikker JSON storage helpers ==========================================
function lsGetJSON(key, fallback) {
  try {
    var raw = localStorage.getItem(key);
    if (!raw) return fallback;
    var obj = JSON.parse(raw);
    return (obj == null ? fallback : obj);
  } catch (e) {
    return fallback;
  }
}
function lsSetJSON(key, val) {
  try {
    localStorage.setItem(key, JSON.stringify(val));
  } catch (e) {
    // kan være fuld kvote — vi ignorerer stille og roligt
  }
}
function lsRemove(key) {
  try { localStorage.removeItem(key); } catch (e) {}
}

// ===== Domænefunktioner for data ============================================
function loadEvents()    { return lsGetJSON(STORAGE_EVENTS,   []); }
function saveEvents(a)   { lsSetJSON(STORAGE_EVENTS,   a || []); }
function loadSettings()  { return lsGetJSON(STORAGE_SETTINGS, {}); }
function saveSettings(o) { lsSetJSON(STORAGE_SETTINGS, o || {}); }
function loadHandover()  { return lsGetJSON(STORAGE_HANDOVER, []); }
function saveHandover(a) { lsSetJSON(STORAGE_HANDOVER, a || []); }
function loadDraft()     { return lsGetJSON(STORAGE_DRAFT,    { txt:'', tag:'' }); }
function saveDraft(o)    { lsSetJSON(STORAGE_DRAFT,    o || { txt:'', tag:'' }); }
function clearDraft()    { lsRemove(STORAGE_DRAFT); }

function loadCurrentStop() { return lsGetJSON(CURRENT_STOP_KEY, null); }
function saveCurrentStop(o){ lsSetJSON(CURRENT_STOP_KEY, o); }
function clearCurrentStop(){ lsRemove(CURRENT_STOP_KEY); }

// Saml alle årsager (default + brugerdefinerede fra settings)
function getAllReasons() {
  var s = loadSettings();
  var custom = s && s.customCauses ? s.customCauses : [];
  var map = {};
  var out = [];
  for (var i = 0; i < DEFAULT_REASONS.length; i++) {
    map[DEFAULT_REASONS[i].code] = DEFAULT_REASONS[i];
  }
  for (var j = 0; j < custom.length; j++) {
    var c = custom[j];
    map[c.code] = { code: c.code, label: c.label, chips: c.chips || [] };
  }
  for (var k in map) if (map.hasOwnProperty(k)) out.push(map[k]);
  return out;
}
</script>

  <script>
// ===== Globale variabler =====================================================
var els = {};
var timer = null;
var IS_STOPPED = false;
var STOP_START_ISO = null;
var stopMeta = null;
var EDIT_ID = null;

// ===== Elementreferencer (samles her for Edge-kompatibilitet) ===============
function bindEls() {
  var ids = [
    // Tabs
    'tab-handling','tab-stats','tab-hist','tab-share','tab-settings',
    // Views
    'view-handling','view-stats','view-hist','view-share','view-settings',
    // Status
    'dot','statxt',
    // Handling
    'btn-stop','btn-start','line','operator','orderNo','itemNo',
    'btn-clear-order','btn-clear-line','btn-open-rep','liveTimer',
    'activity8h','log8h',
    // Stop modal
    'ov-stop','stop-close','stop-cancel','stop-confirm',
    'reasonTop','reasonMore','reasonChips','other','comment','stopValidation',
    // Handover
    'handoverText','handoverTag','handoverSave','handoverClear','handoverList',
    // Settings
    'defTo','brandColor','themeSelect','btn-save-settings',
    // Årsager
    'causeCode','causeLabel','causeChips','btn-add-cause','btn-reset-causes','causeList',
    // Share
    'shareMail','shareSubj','btn-copy','btn-mail','btn-export-txt','sharePreview'
  ];
  for (var i = 0; i < ids.length; i++) {
    els[ids[i]] = byId(ids[i]);
  }
}

// ===== Faner / navigation ====================================================
function setActiveTab(tabId) {
  var tabIds = ['tab-handling','tab-stats','tab-hist','tab-share','tab-settings'];
  var viewIds = ['view-handling','view-stats','view-hist','view-share','view-settings'];
  for (var i = 0; i < tabIds.length; i++) remClass(byId(tabIds[i]), 'active');
  for (var j = 0; j < viewIds.length; j++) hide(byId(viewIds[j]));
  addClass(byId(tabId), 'active');

  if (tabId === 'tab-handling') show(byId('view-handling'));
  else if (tabId === 'tab-stats') show(byId('view-stats'));
  else if (tabId === 'tab-hist') show(byId('view-hist'));
  else if (tabId === 'tab-share') show(byId('view-share'));
  else show(byId('view-settings'));
}

// ===== Temaer & brand ========================================================
function applyTheme(theme) {
  if (theme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
  } else {
    document.documentElement.removeAttribute('data-theme');
  }
}

function applyBrand() {
  var s = loadSettings();
  if (s.brandColor) {
    document.documentElement.style.setProperty('--brand', s.brandColor);
  }
  if (els.defTo) els.defTo.value = s.defaultTo || 'vedligehold@pluspack.com';
  if (els.brandColor) els.brandColor.value = s.brandColor || '#0a61ae';
  if (els.themeSelect) els.themeSelect.value = s.theme || 'standard';
  if (s.line && els.line) els.line.value = s.line;
  if (els.operator) els.operator.value = s.operator || '';
  if (els.orderNo) els.orderNo.value = s.orderNo || '';
  if (els.itemNo) els.itemNo.value = s.itemNo || '';
  applyTheme(s.theme || 'standard');
}

// ===== Statusindikator =======================================================
function setStatus(stopped) {
  IS_STOPPED = stopped;
  if (!els.btnStop || !els.btnStart) return;
  els.btnStop.disabled = stopped;
  els.btnStart.disabled = !stopped;
  if (els.dot) els.dot.style.background = stopped ? 'var(--danger)' : 'var(--ok)';
  if (els.statxt) els.statxt.innerHTML = stopped ? 'Stoppet' : 'Kører';
  if (els.liveTimer) els.liveTimer.innerHTML = stopped ? '00:00:00' : '—';
}
</script>
<script>
// ===== Tidsmåling og status ==================================================
function tick() {
  if (!IS_STOPPED || !STOP_START_ISO) return;
  var diff = new Date().getTime() - new Date(STOP_START_ISO).getTime();
  if (els.liveTimer) els.liveTimer.innerHTML = fmtDur(diff);
}

// ===== Krævede felter ========================================================
function hasRequired() {
  var ord = els.orderNo ? (els.orderNo.value || '').trim() : '';
  var item = els.itemNo ? (els.itemNo.value || '').trim() : '';
  return ord !== '' && item !== '';
}

// ===== Synkroniser ordrer i settings =========================================
function syncOrder() {
  var s = loadSettings();
  s.orderNo = els.orderNo ? els.orderNo.value : '';
  s.itemNo  = els.itemNo ? els.itemNo.value  : '';
  s.operator = els.operator ? els.operator.value : '';
  s.line = els.line ? els.line.value : '';
  saveSettings(s);
}

// ===== Start og stop kontrol =================================================
function onStopClick() {
  if (!hasRequired()) {
    alert("Udfyld Ordre nr. og Vare nr. før du registrerer et stop.");
    return;
  }
  // Åbn stopregistrering (simple version)
  STOP_START_ISO = new Date().toISOString();
  stopMeta = { reason: { code: 'MANUAL', label: 'Manuelt stop' }, comment: '', detailChips: [], other: '' };
  setStatus(true);
  clearInterval(timer);
  timer = setInterval(tick, 1000);
  tick();
  saveCurrentStop({ start: STOP_START_ISO, meta: stopMeta });
}

function onStartClick() {
  if (!IS_STOPPED) return;
  var end = new Date();
  var start = new Date(STOP_START_ISO);
  var duration = end.getTime() - start.getTime();

  var rows = loadEvents();
  rows.push({
    id: pseudoUuid(),
    start: start.toISOString(),
    end: end.toISOString(),
    durationMs: duration,
    line: els.line ? els.line.value : '',
    operator: els.operator ? els.operator.value : '',
    orderNo: els.orderNo ? els.orderNo.value : '',
    itemNo: els.itemNo ? els.itemNo.value : '',
    reason: stopMeta ? stopMeta.reason : null,
    detailChips: stopMeta ? stopMeta.detailChips : [],
    other: stopMeta ? stopMeta.other : '',
    comment: stopMeta ? stopMeta.comment : ''
  });
  saveEvents(rows);
  setStatus(false);
  STOP_START_ISO = null;
  stopMeta = null;
  clearInterval(timer);
  timer = null;
  clearCurrentStop();
  alert("Stop afsluttet og gemt.");
}

// ===== Genoptag aktivt stop ved load ========================================
function restoreCurrentStop() {
  var cur = loadCurrentStop();
  if (cur && cur.start) {
    STOP_START_ISO = cur.start;
    stopMeta = cur.meta || null;
    setStatus(true);
    clearInterval(timer);
    timer = setInterval(tick, 1000);
    tick();
  }
}

// ===== Knapbindinger =========================================================
function bindStopStartButtons() {
  if (els.btnStop) els.btnStop.onclick = onStopClick;
  if (els.btnStart) els.btnStart.onclick = onStartClick;

  // Genveje (Ctrl+S og Ctrl+A)
  document.addEventListener('keydown', function (ev) {
    var key = ev.keyCode || ev.which;
    if (ev.ctrlKey && (key === 83)) { // Ctrl+S
      ev.preventDefault();
      if (!IS_STOPPED) onStopClick();
    }
    if (ev.ctrlKey && (key === 65)) { // Ctrl+A
      ev.preventDefault();
      if (IS_STOPPED) onStartClick();
    }
  });
}
</script>
<script>
// ===== 8-timers aktivitet (simplificeret SVG) ================================
function renderActivity8h() {
  var svg = els.activity8h;
  if (!svg) return;

  // Tøm tidligere indhold
  while (svg.firstChild) svg.removeChild(svg.firstChild);

  var W = 920, H = 140;
  var m = { l: 40, r: 10, t: 20, b: 20 };
  var w = W - m.l - m.r, h = H - m.t - m.b;
  var now = new Date();
  var startWindow = new Date(now.getTime() - 8 * 3600 * 1000);

  function xPos(t) {
    return m.l + Math.max(0, Math.min(w, ((t - startWindow) / (8 * 3600 * 1000)) * w));
  }

  // Baggrund
  var bg = document.createElementNS("http://www.w3.org/2000/svg", "rect");
  bg.setAttribute("x", m.l);
  bg.setAttribute("y", m.t);
  bg.setAttribute("width", w);
  bg.setAttribute("height", h);
  bg.setAttribute("fill", "rgba(16,185,129,0.06)");
  svg.appendChild(bg);

  // Gridlinjer hver time
  for (var i = 0; i <= 8; i++) {
    var x = m.l + (w * (i / 8));
    var ln = document.createElementNS("http://www.w3.org/2000/svg", "line");
    ln.setAttribute("x1", x);
    ln.setAttribute("y1", m.t);
    ln.setAttribute("x2", x);
    ln.setAttribute("y2", m.t + h);
    ln.setAttribute("stroke", "#e5e7eb");
    ln.setAttribute("stroke-width", "1");
    svg.appendChild(ln);

    var t = document.createElementNS("http://www.w3.org/2000/svg", "text");
    var dt = new Date(startWindow.getTime() + i * 3600 * 1000);
    t.setAttribute("x", x + 2);
    t.setAttribute("y", H - 4);
    t.setAttribute("fill", "#475569");
    t.setAttribute("font-size", "10");
    t.textContent = pad2(dt.getHours()) + ":00";
    svg.appendChild(t);
  }

  var rows = loadEvents();
  var stops = [];

  for (var r = 0; r < rows.length; r++) {
    var ev = rows[r];
    if (!ev.end) continue;
    var s = new Date(ev.start);
    var e = new Date(ev.end);
    if (e < startWindow || s > now) continue;
    var cs = Math.max(s.getTime(), startWindow.getTime());
    var ce = Math.min(e.getTime(), now.getTime());
    stops.push([cs, ce]);
  }

  if (IS_STOPPED && STOP_START_ISO) {
    var s2 = Math.max(new Date(STOP_START_ISO).getTime(), startWindow.getTime());
    var e2 = now.getTime();
    if (e2 > s2) stops.push([s2, e2]);
  }

  for (var j = 0; j < stops.length; j++) {
    var seg = stops[j];
    var xs = xPos(seg[0]);
    var xe = xPos(seg[1]);
    var rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    rect.setAttribute("x", xs);
    rect.setAttribute("y", m.t + 8);
    rect.setAttribute("width", Math.max(1, xe - xs));
    rect.setAttribute("height", h - 16);
    rect.setAttribute("fill", "rgba(220,38,38,0.28)");
    rect.setAttribute("stroke", "#dc2626");
    rect.setAttribute("stroke-width", "1");
    svg.appendChild(rect);
  }

  var xnow = xPos(now);
  var nowLn = document.createElementNS("http://www.w3.org/2000/svg", "line");
  nowLn.setAttribute("x1", xnow);
  nowLn.setAttribute("y1", m.t - 2);
  nowLn.setAttribute("x2", xnow);
  nowLn.setAttribute("y2", m.t + h + 2);
  nowLn.setAttribute("stroke", "var(--brand)");
  nowLn.setAttribute("stroke-width", "2");
  svg.appendChild(nowLn);
}

// ===== Logliste (seneste 8 timer) ===========================================
function renderLog8h() {
  var el = els.log8h;
  if (!el) return;
  el.innerHTML = "";

  var now = new Date();
  var startWindow = new Date(now.getTime() - 8 * 3600 * 1000);
  var rows = loadEvents();
  var list = [];

  for (var i = 0; i < rows.length; i++) {
    var r = rows[i];
    if (!r.end) continue;
    var end = new Date(r.end);
    if (end > startWindow) list.push(r);
  }

  list.sort(function (a, b) {
    return new Date(b.start).getTime() - new Date(a.start).getTime();
  });

  if (list.length === 0 && !(IS_STOPPED && STOP_START_ISO)) {
    el.innerHTML = '<li class="muted" style="padding:8px 0">Ingen registreringer i perioden</li>';
    return;
  }

  // Aktivt stop (vises øverst)
  if (IS_STOPPED && STOP_START_ISO) {
    var ms = new Date().getTime() - new Date(STOP_START_ISO).getTime();
    var liAct = document.createElement("li");
    liAct.innerHTML = '<span class="ts">NU</span><div><strong>Aktivt stop</strong> ' +
      '<span class="tag">' + fmtDur(ms) + '</span></div>';
    el.appendChild(liAct);
  }

  // Resten af historikken
  for (var j = 0; j < list.length; j++) {
    var ev = list[j];
    var code = ev.reason && ev.reason.code ? ev.reason.code : "";
    var label = ev.reason && ev.reason.label ? ev.reason.label : "Stop";
    var li = document.createElement("li");
    li.innerHTML =
      '<span class="ts">' + fmtDate(ev.start) + '</span>' +
      '<div>' +
      (code ? '<span class="tag">' + code + '</span> ' : '') +
      label +
      ' – <span class="muted">' + fmtDur(ev.durationMs || 0) + '</span>' +
      (ev.comment ? ' · ' + ev.comment : '') +
      '</div>';
    el.appendChild(li);
  }
}
</script>
<script>
// ===== Statistik og historik ================================================
function computeStats(rows) {
  var totalDur = 0;
  for (var i = 0; i < rows.length; i++) {
    totalDur += rows[i].durationMs || 0;
  }
  var avg = rows.length ? Math.round(totalDur / rows.length) : 0;
  return { count: rows.length, dur: totalDur, avg: avg };
}

// ===== Sammenlægning pr. årsag ==============================================
function aggregateByCause(rows) {
  var map = {};
  for (var i = 0; i < rows.length; i++) {
    var r = rows[i];
    var code = (r.reason && r.reason.code) ? r.reason.code : "UKENDT";
    var label = (r.reason && r.reason.label) ? r.reason.label : "Ukendt";
    var key = code + "|" + label;
    if (!map[key]) {
      map[key] = { code: code, label: label, count: 0, dur: 0 };
    }
    map[key].count += 1;
    map[key].dur += (r.durationMs || 0);
  }

  var arr = [];
  for (var k in map) {
    if (map.hasOwnProperty(k)) arr.push(map[k]);
  }

  arr.sort(function (a, b) {
    if (b.count !== a.count) return b.count - a.count;
    return b.dur - a.dur;
  });
  return arr;
}

// ===== Render statistiske KPI'er ============================================
function renderStats() {
  var rows = loadEvents();
  var done = [];
  for (var i = 0; i < rows.length; i++) if (rows[i].end) done.push(rows[i]);

  var agg = aggregateByCause(done);
  var k = computeStats(done);

  var kpiCount = byId('kpi-count');
  var kpiDur = byId('kpi-dur');
  var kpiAvg = byId('kpi-avg');
  var kpiTop = byId('kpi-top');
  var kpiTopSub = byId('kpi-top-sub');

  if (kpiCount) kpiCount.innerHTML = String(k.count);
  if (kpiDur) kpiDur.innerHTML = fmtDur(k.dur);
  if (kpiAvg) kpiAvg.innerHTML = fmtDur(k.avg);

  if (agg.length) {
    if (kpiTop) kpiTop.innerHTML = agg[0].code;
    if (kpiTopSub) kpiTopSub.innerHTML = "Hyppigst: " + agg[0].count + " stk";
  } else {
    if (kpiTop) kpiTop.innerHTML = "—";
    if (kpiTopSub) kpiTopSub.innerHTML = "Hyppigst: —";
  }
}

// ===== Historiktabel ========================================================
function renderTable() {
  var rows = loadEvents();
  rows.sort(function (a, b) {
    return new Date(b.start).getTime() - new Date(a.start).getTime();
  });

  var tblBody = byId('tbl-body');
  if (!tblBody) return;

  var html = '';
  for (var i = 0; i < rows.length; i++) {
    var ev = rows[i];
    var code = ev.reason && ev.reason.code ? ev.reason.code : '';
    var label = ev.reason && ev.reason.label ? ev.reason.label : '';
    html += '<tr>' +
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">' + fmtDate(ev.start) + '</td>' +
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">' + (ev.end ? fmtDate(ev.end) : '—') + '</td>' +
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">' + (ev.durationMs ? fmtDur(ev.durationMs) : '—') + '</td>' +
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">' + (ev.line || '') + '</td>' +
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">' + (ev.orderNo || '') + '</td>' +
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">' + (ev.itemNo || '') + '</td>' +
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">' +
      '<span class="pill">' + code + '</span> ' + label + '</td>' +
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">' + ((ev.detailChips || []).join(", ")) + '</td>' +
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">' + (ev.comment || '') + '</td>' +
      '<td style="padding:8px;border-bottom:1px solid var(--divider)">' + (ev.operator || '') + '</td>' +
      '<td style="padding:8px;border-bottom:1px solid var(--divider);text-align:right">' +
      '<button class="btn" data-action="edit" data-id="' + ev.id + '">Redigér</button> ' +
      '<button class="btn" data-action="delete" data-id="' + ev.id + '">Slet</button>' +
      '</td>' +
      '</tr>';
  }

  tblBody.innerHTML = html;

  // Opdater tællere
  var countPosts = byId('countPosts');
  var usageTxt = byId('usageTxt');
  var usageFill = byId('usageFill');
  if (countPosts) countPosts.innerHTML = String(rows.length);

  var used = bytesLen(localStorage.getItem(STORAGE_EVENTS) || '') +
             bytesLen(localStorage.getItem(STORAGE_SETTINGS) || '') +
             bytesLen(localStorage.getItem(STORAGE_HANDOVER) || '');
  var pct = Math.min(100, Math.round((used / (5 * 1024 * 1024)) * 100));
  if (usageTxt) usageTxt.innerHTML = pct + '% (' + Math.round(used / 1024) + ' KB af 5120 KB)';
  if (usageFill) usageFill.style.width = pct + '%';

  renderActivity8h();
  renderLog8h();
  renderStats();
}
</script>
<script>
// ===== CSV & TXT eksport =====================================================
function makeCsv(rows) {
  var header = [
    'id','start','slut','varighed_ms','varighed_hhmmss',
    'linje','ordre','vare','kode','kode_label','uddybning','andet','kommentar','operatør'
  ].join(';');

  var lines = [];
  for (var i = 0; i < rows.length; i++) {
    var r = rows[i];
    var code = (r.reason && r.reason.code) ? r.reason.code : '';
    var label = (r.reason && r.reason.label) ? r.reason.label : '';
    var line = [
      r.id,
      r.start,
      r.end,
      r.durationMs,
      fmtDur(r.durationMs || 0),
      (r.line || ''),
      (r.orderNo || ''),
      (r.itemNo || ''),
      code,
      label,
      (r.detailChips || []).join('|'),
      (r.other || ''),
      (r.comment || '').replace(/\n/g, ' '),
      (r.operator || '')
    ].join(';');
    lines.push(line);
  }
  return header + '\n' + lines.join('\n');
}

function downloadFile(filename, text) {
  try {
    var blob = new Blob([text], { type: 'text/plain;charset=utf-8;' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.parentNode.removeChild(a);
    setTimeout(function () { URL.revokeObjectURL(url); }, 500);
  } catch (e) {
    alert("Din browser understøtter ikke automatisk download. Kopiér teksten manuelt.");
  }
}

// ===== Mailoprettelse ========================================================
function defaultEmailSubject() {
  var line = els.line ? els.line.value : '';
  var ord = els.orderNo ? els.orderNo.value : '';
  var d = new Date();
  var date = pad2(d.getDate()) + '/' + pad2(d.getMonth() + 1) + '/' + d.getFullYear();
  return 'Produktionsstop' + (line ? ' – ' + line : '') + (ord ? ' – Ordre ' + ord : '') + ' – ' + date;
}

// ===== Kopiering af JSON (fallback for Edge) ================================
function copyJsonFallback() {
  try {
    var data = JSON.stringify(loadEvents(), null, 2);
    if (window.clipboardData && window.clipboardData.setData) {
      // IE/Edge 44
      window.clipboardData.setData("Text", data);
      alert("JSON kopieret til udklipsholder.");
    } else {
      // Fallback: vis prompt
      prompt("Kopiér JSON manuelt:", data);
    }
  } catch (e) {
    alert("Kunne ikke kopiere JSON: " + e.message);
  }
}

// ===== Binding af delingsknapper ============================================
function bindShareButtons() {
  if (els.btnExportTxt) els.btnExportTxt.onclick = function () {
    var rows = loadEvents();
    var txt = makeCsv(rows);
    downloadFile('produktionsstop.txt', txt);
  };

  if (els.btnCopy) els.btnCopy.onclick = copyJsonFallback;

  if (els.btnMail) els.btnMail.onclick = function () {
    var to = (els.shareMail && els.shareMail.value) ? els.shareMail.value : 'vedligehold@pluspack.com';
    var subj = (els.shareSubj && els.shareSubj.value) ? els.shareSubj.value : defaultEmailSubject();
    var rows = loadEvents();
    var csv = makeCsv(rows);
    downloadFile('produktionsstop.csv', csv);

    var body = "Hej,\n\nSe vedhæftede produktionsstop-log.\n\n(Husk at vedhæfte filen manuelt hvis den ikke kom med)\n\nMvh,\nPlus Pack System";
    var mail = 'mailto:' + encodeURIComponent(to) +
      '?subject=' + encodeURIComponent(subj) +
      '&body=' + encodeURIComponent(body);
    window.location.href = mail;
  };

  var btnClear = byId('btn-clear-log');
  if (btnClear) btnClear.onclick = function () {
    if (confirm('Er du sikker på, at du vil slette hele loggen?')) {
      saveEvents([]);
      renderTable();
      alert('Loggen er blevet slettet.');
    }
  };

  // Automatisk forhåndsvisning
  if (els.sharePreview) {
    try {
      els.sharePreview.value = makeCsv(loadEvents());
    } catch (e) {
      els.sharePreview.value = "Ingen data endnu.";
    }
  }
}
</script>
<script>
// ===== Indstillinger & tema ================================================
function saveUserSettings() {
  var s = loadSettings();
  if (!s) s = {};
  s.defaultTo = els.defTo ? els.defTo.value : '';
  s.brandColor = els.brandColor ? els.brandColor.value : '#0a61ae';
  s.theme = els.themeSelect ? els.themeSelect.value : 'standard';
  saveSettings(s);
  applyBrand();
  alert("Indstillinger gemt.");
}

function bindSettingsButtons() {
  if (els.btnSaveSettings) {
    els.btnSaveSettings.onclick = saveUserSettings;
  }
}

// ===== Tilføj årsag ========================================================
function renderCustomList() {
  var s = loadSettings();
  var list = (s && s.customCauses) ? s.customCauses : [];
  var out = '';

  if (!list.length) {
    out = '<p class="muted" style="margin:0;">Ingen brugerdefinerede årsager endnu.</p>';
  } else {
    out = '<table style="width:100%;border-collapse:collapse;">' +
          '<thead><tr>' +
          '<th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb;">Kode</th>' +
          '<th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb;">Label</th>' +
          '<th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb;">Chips</th>' +
          '<th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb;">Handling</th>' +
          '</tr></thead><tbody>';

    for (var i = 0; i < list.length; i++) {
      var it = list[i];
      out += '<tr>' +
             '<td style="padding:6px;border-bottom:1px solid #e5e7eb;">' + it.code + '</td>' +
             '<td style="padding:6px;border-bottom:1px solid #e5e7eb;">' + it.label + '</td>' +
             '<td style="padding:6px;border-bottom:1px solid #e5e7eb;">' + (it.chips || []).join(', ') + '</td>' +
             '<td style="padding:6px;border-bottom:1px solid #e5e7eb;text-align:right;">' +
             '<button class="btn" data-del="' + it.code + '">Slet</button></td></tr>';
    }
    out += '</tbody></table>';
  }

  if (els.causeList) els.causeList.innerHTML = out;

  // Tilføj delete-handling
  if (els.causeList) {
    var btns = els.causeList.getElementsByTagName('button');
    for (var b = 0; b < btns.length; b++) {
      btns[b].onclick = function () {
        var code = this.getAttribute('data-del');
        var s = loadSettings();
        var arr = (s.customCauses || []).filter(function (x) {
          return x.code !== code;
        });
        s.customCauses = arr;
        saveSettings(s);
        renderCustomList();
      };
    }
  }
}

function addCustomCause() {
  var code = els.causeCode ? (els.causeCode.value || '').toUpperCase().trim() : '';
  var label = els.causeLabel ? (els.causeLabel.value || '').trim() : '';
  var raw = els.causeChips ? els.causeChips.value : '';
  var chips = raw ? raw.split(',') : [];
  var cleanChips = [];
  for (var i = 0; i < chips.length; i++) {
    var t = chips[i].trim();
    if (t !== '') cleanChips.push(t);
  }

  if (!code || !label) {
    alert("Udfyld både kode og label.");
    return;
  }

  var all = getAllReasons();
  for (var j = 0; j < all.length; j++) {
    if (all[j].code.toUpperCase() === code) {
      alert("Koden findes allerede. Vælg en anden.");
      return;
    }
  }

  var s = loadSettings();
  if (!s.customCauses) s.customCauses = [];
  s.customCauses.push({ code: code, label: label, chips: cleanChips });
  saveSettings(s);

  if (els.causeCode) els.causeCode.value = '';
  if (els.causeLabel) els.causeLabel.value = '';
  if (els.causeChips) els.causeChips.value = '';

  renderCustomList();
  alert("Ny årsag tilføjet.");
}

function resetCustomCauses() {
  if (confirm("Vil du nulstille alle brugerdefinerede årsager?")) {
    var s = loadSettings();
    s.customCauses = [];
    saveSettings(s);
    renderCustomList();
    alert("Brugerdefinerede årsager nulstillet.");
  }
}

function bindCauseButtons() {
  if (els.btnAddCause) els.btnAddCause.onclick = addCustomCause;
  if (els.btnResetCauses) els.btnResetCauses.onclick = resetCustomCauses;
}
</script>
<script>
// ===== Overlevering / handover ==============================================
function renderHandoverList() {
  var list = loadHandover();
  var el = els.handoverList;
  if (!el) return;

  if (!list.length) {
    el.innerHTML = '<p class="muted" style="margin:0;">Ingen tidligere noter.</p>';
    return;
  }

  var html = '<table style="width:100%;border-collapse:collapse;">' +
             '<thead><tr>' +
             '<th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb;">Tidspunkt</th>' +
             '<th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb;">Tag</th>' +
             '<th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb;">Note</th>' +
             '<th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb;">Handling</th>' +
             '</tr></thead><tbody>';

  for (var i = list.length - 1; i >= 0; i--) {
    var item = list[i];
    html += '<tr>' +
            '<td style="padding:6px;border-bottom:1px solid #e5e7eb;">' + fmtDate(item.time) + '</td>' +
            '<td style="padding:6px;border-bottom:1px solid #e5e7eb;">' + (item.tag || '') + '</td>' +
            '<td style="padding:6px;border-bottom:1px solid #e5e7eb;">' + (item.txt || '') + '</td>' +
            '<td style="padding:6px;text-align:right;border-bottom:1px solid #e5e7eb;">' +
            '<button class="btn" data-del="' + item.id + '">Slet</button></td></tr>';
  }

  html += '</tbody></table>';
  el.innerHTML = html;

  // Tilføj slet-funktion
  var btns = el.getElementsByTagName('button');
  for (var j = 0; j < btns.length; j++) {
    btns[j].onclick = function () {
      var id = this.getAttribute('data-del');
      var arr = loadHandover();
      var filtered = [];
      for (var k = 0; k < arr.length; k++) {
        if (arr[k].id !== id) filtered.push(arr[k]);
      }
      saveHandover(filtered);
      renderHandoverList();
    };
  }
}

function saveHandoverNote() {
  var txt = els.handoverText ? els.handoverText.value : '';
  var tag = els.handoverTag ? els.handoverTag.value : '';
  if (txt.trim() === '') {
    alert('Skriv en note, før du gemmer.');
    return;
  }

  var list = loadHandover();
  var item = {
    id: pseudoUuid(),
    txt: txt,
    tag: tag,
    time: new Date().toISOString()
  };
  list.push(item);
  saveHandover(list);
  clearDraft();
  if (els.handoverText) els.handoverText.value = '';
  if (els.handoverTag) els.handoverTag.value = '';
  renderHandoverList();
  alert('Note gemt.');
}

function clearHandoverDraft() {
  if (els.handoverText) els.handoverText.value = '';
  if (els.handoverTag) els.handoverTag.value = '';
  clearDraft();
}

// ===== Autosave af kladde ====================================================
function autosaveHandoverDraft() {
  if (!els.handoverText || !els.handoverTag) return;
  var draft = {
    txt: els.handoverText.value || '',
    tag: els.handoverTag.value || ''
  };
  saveDraft(draft);
}

function restoreHandoverDraft() {
  var d = loadDraft();
  if (d && (d.txt || d.tag)) {
    if (els.handoverText) els.handoverText.value = d.txt;
    if (els.handoverTag) els.handoverTag.value = d.tag;
  }
}

function bindHandoverButtons() {
  if (els.handoverSave) els.handoverSave.onclick = saveHandoverNote;
  if (els.handoverClear) els.handoverClear.onclick = clearHandoverDraft;
  if (els.handoverText) els.handoverText.onkeyup = autosaveHandoverDraft;
  if (els.handoverTag) els.handoverTag.onkeyup = autosaveHandoverDraft;
}
</script>
<script>
// ===== Eksport af historik (CSV) ============================================
function exportHistoryCSV() {
  var rows = loadEvents();
  if (!rows.length) {
    alert("Der er ingen data at eksportere.");
    return;
  }
  var csv = makeCsv(rows);
  downloadFile("produktionsstop_historik.csv", csv);
}

// ===== Rydning af historik ===================================================
function clearHistory() {
  if (confirm("Er du sikker på, at du vil slette hele historikken?")) {
    saveEvents([]);
    renderTable();
    renderActivity8h();
    renderLog8h();
    renderStats();
    alert("Historikken er slettet.");
  }
}

// ===== Pareto-diagram (simpel version) ======================================
function renderPareto() {
  var svg = byId("pareto");
  if (!svg) return;

  while (svg.firstChild) svg.removeChild(svg.firstChild);

  var W = 760, H = 260;
  var m = { l: 40, r: 30, t: 20, b: 40 };
  var w = W - m.l - m.r;
  var h = H - m.t - m.b;

  var rows = loadEvents();
  var done = [];
  for (var i = 0; i < rows.length; i++) if (rows[i].end) done.push(rows[i]);
  if (!done.length) {
    var t = document.createElementNS("http://www.w3.org/2000/svg", "text");
    t.setAttribute("x", W / 2 - 60);
    t.setAttribute("y", H / 2);
    t.setAttribute("fill", "#64748b");
    t.textContent = "Ingen data";
    svg.appendChild(t);
    return;
  }

  var agg = aggregateByCause(done);
  if (!agg.length) return;

  var totalCount = 0;
  for (var j = 0; j < agg.length; j++) totalCount += agg[j].count;

  var maxCount = agg[0].count;
  var cumPct = 0;

  for (var k = 0; k < agg.length; k++) {
    var x = m.l + (k * (w / agg.length));
    var bw = (w / agg.length) - 6;
    var bh = (agg[k].count / maxCount) * h;
    var rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    rect.setAttribute("x", x + 3);
    rect.setAttribute("y", H - m.b - bh);
    rect.setAttribute("width", bw);
    rect.setAttribute("height", bh);
    rect.setAttribute("fill", "rgba(220,38,38,0.4)");
    rect.setAttribute("stroke", "#dc2626");
    svg.appendChild(rect);

    // Label
    var txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
    txt.setAttribute("x", x + 4);
    txt.setAttribute("y", H - 8);
    txt.setAttribute("font-size", "10");
    txt.setAttribute("fill", "#334155");
    txt.textContent = agg[k].code;
    svg.appendChild(txt);
  }

  // Kumulativ kurve
  var pathD = "";
  var prevX = 0, prevY = 0;
  for (var p = 0; p < agg.length; p++) {
    cumPct += (agg[p].count / totalCount) * 100;
    var xp = m.l + (p * (w / agg.length)) + (w / agg.length) / 2;
    var yp = m.t + (h * (1 - cumPct / 100));
    if (p === 0) pathD = "M" + xp + "," + yp;
    else pathD += " L" + xp + "," + yp;
    prevX = xp; prevY = yp;
  }

  var line = document.createElementNS("http://www.w3.org/2000/svg", "path");
  line.setAttribute("d", pathD);
  line.setAttribute("stroke", "var(--brand)");
  line.setAttribute("stroke-width", "2");
  line.setAttribute("fill", "none");
  svg.appendChild(line);

  // Højre akse-label
  var pctTxt = document.createElementNS("http://www.w3.org/2000/svg", "text");
  pctTxt.setAttribute("x", W - 70);
  pctTxt.setAttribute("y", m.t + 12);
  pctTxt.setAttribute("fill", "#64748b");
  pctTxt.setAttribute("font-size", "11");
  pctTxt.textContent = "Kumulativ %";
  svg.appendChild(pctTxt);
}

// ===== Historik knapper =====================================================
function bindHistoryButtons() {
  var btnExport = byId("btn-export");
  if (btnExport) btnExport.onclick = exportHistoryCSV;
  var btnClear = byId("btn-clear-hist");
  if (btnClear) btnClear.onclick = clearHistory;
}
</script>
<script>
// ===== Initialisering =======================================================
function initApp() {
  bindEls();            // Saml alle elementreferencer
  bindStopStartButtons();
  bindHistoryButtons();
  bindShareButtons();
  bindSettingsButtons();
  bindCauseButtons();
  bindHandoverButtons();

  restoreCurrentStop();
  restoreHandoverDraft();
  applyBrand();
  renderCustomList();
  renderHandoverList();
  renderTable();
  renderActivity8h();
  renderLog8h();
  renderPareto();
  renderStats();

  // Faner (tabs)
  var tabs = ['tab-handling','tab-stats','tab-hist','tab-share','tab-settings'];
  for (var i = 0; i < tabs.length; i++) {
    (function (id) {
      var t = byId(id);
      if (t) {
        t.onclick = function () {
          setActiveTab(id);
        };
      }
    })(tabs[i]);
  }

  // Start på "Handling"
  setActiveTab('tab-handling');

  // Live opdatering af aktivitet og log
  setInterval(function () {
    renderActivity8h();
    renderLog8h();
  }, 60000); // hvert minut
}

// ===== Når DOM er klar ======================================================
if (document.readyState === "complete" || document.readyState === "interactive") {
  setTimeout(initApp, 50);
} else {
  document.onreadystatechange = function () {
    if (document.readyState === "complete") {
      initApp();
    }
  };
}
</script>
<style>
/* ========== DEL 19: Klassisk design & Edge-fallbacks =======================
   - Holder samme struktur/klasser som du allerede bruger
   - Giver klassisk, fladt look + robuste defaults hvis CSS custom props mangler
   - Tilføjer -ms- flex/grid fallback, simple sticky fallback og knap-tryk-styles
============================================================================ */

/* ---- Farve-defaults (bruges hvis var() mangler) ------------------------- */
html, body {
  background: #f6f8fb;
  color: #0f172a;
}
.brand { background: #0a61ae; color: #fff; }

/* ---- Klassisk kort/panel-look (fladere + tydelig kant) ------------------ */
.card,
.panel,
.kpi {
  background: #ffffff;
  border: 1px solid #e5e9f0;
  border-radius: 10px;
  box-shadow: none;            /* klassisk fladt */
}
.kpi .val { font-weight: 800; }

/* ---- Klassiske knapper --------------------------------------------------- */
.btn {
  background: #ffffff;
  border: 1px solid #d1d9e6;
  border-radius: 10px;
  font-weight: 700;
  transition: background .12s ease, border-color .12s ease;
}
.btn:hover { background: #f3f6fb; border-color: #c8d2e3; }
.btn:active { background: #e9eef7; }
.btn[disabled] { opacity: .6; }

.btn-start {
  background: #f3fbf7;
  border-color: #bfe8ce;
  color: #065f46;
}
.btn-start:hover { background: #e8f7ef; }

.btn-stop {
  background: #fdf3f3;
  border-color: #f1c1c1;
  color: #7f1d1d;
}
.btn-stop:hover { background: #fdeaea; }

/* ---- Tabs klassisk ------------------------------------------------------- */
.tabs {
  background: #ffffff;
  border-bottom: 1px solid #e5e9f0;
}
.tab {
  border: 1px solid transparent;
  border-radius: 8px;
}
.tab.active {
  background: #f5f8fd;
  border-color: #dbe4f2;
}

/* ---- Formularfelter klassisk -------------------------------------------- */
input, select, textarea {
  background: #ffffff;
  border: 1px solid #d8e0eb;
  border-radius: 8px;
}
label { color: #667892; }

/* ---- Logliste og chips --------------------------------------------------- */
.loglist {
  border: 1px dashed #d8e0eb;
  background: #fff;
}
.pill {
  background: #fff;
  border: 1px solid #d8e0eb;
}

/* ---- Aktivitet (SVG) synlighed ------------------------------------------- */
.activity .gridline      { stroke: #e5e7eb; }
.activity .gridline.sub  { stroke: #e5e7eb; opacity: .6; }
.activity .now           { stroke: #0a61ae; }
.activity .stop          { fill: rgba(220,38,38,.25); stroke: #dc2626; }

/* ---- Sticky fallback: hvis Edge-version ikke holder sticky stabilt ------- */
.tabs { position: -ms-sticky; top: 0; }  /* ældre Edge tolererer dette som no-op */
html.no-sticky .tabs { position: static; } /* JS i Del 20 sætter evt. .no-sticky */

/* ---- Grid fallback (Edge Legacy/MS Flexbox) ------------------------------ */
/* Grund-grid */
.grid {
  display: -ms-flexbox;      /* Edge legacy fallback */
  display: flex;
  -ms-flex-wrap: wrap;
      flex-wrap: wrap;
  gap: 12px;
}

/* 2 kolonner */
.grid-2 > * {
  -ms-flex: 1 1 48%;
      flex: 1 1 48%;
  min-width: 260px;
}

/* 3 kolonner */
.grid-3 > * {
  -ms-flex: 1 1 30%;
      flex: 1 1 30%;
  min-width: 220px;
}

/* Stats 12-kolonne – fallback: to kolonner på brede skærme, én på smalle */
.stats-grid {
  display: -ms-flexbox;
  display: flex;
  -ms-flex-wrap: wrap;
      flex-wrap: wrap;
  gap: 14px;
}
.stats-grid > * {
  -ms-flex: 1 1 48%;
      flex: 1 1 48%;
  min-width: 320px;
}
@media (max-width: 820px) {
  .stats-grid > * {
    -ms-flex: 1 1 100%;
        flex: 1 1 100%;
    min-width: 0;
  }
}

/* KPI i klassisk fremtoning */
.kpi { background: #fafcff; }

/* ---- Diagrammer (svg) størrelser sikres --------------------------------- */
.chart { width: 100%; height: 220px; }

/* ---- Overlays/modals klassisk kant -------------------------------------- */
.overlay .modal {
  border: 1px solid #dfe6f2;
  border-radius: 10px;
  box-shadow: 0 12px 40px rgba(0,0,0,.18);
}
.modal-h, .modal-f {
  border-color: #e5e9f0;
}

/* ---- Dark tema fallback (hvis data-theme='dark' uden prefers-color-scheme) */
html[data-theme="dark"] body { background: #0b1220; color: #e5e7eb; }
html[data-theme="dark"] .card,
html[data-theme="dark"] .panel,
html[data-theme="dark"] .kpi,
html[data-theme="dark"] .tabs,
html[data-theme="dark"] .status {
  background: #111827;
  border-color: #1f2937;
}
html[data-theme="dark"] .btn,
html[data-theme="dark"] input,
html[data-theme="dark"] select,
html[data-theme="dark"] textarea {
  background: #0f172a;
  border-color: #1f2937;
  color: #e5e7eb;
}
html[data-theme="dark"] .pill { background:#0f172a; border-color:#1f2937; }
html[data-theme="dark"] .tab.active { background:#0f172a; border-color:#1f2937; }

/* ---- Små typografirettelser (klassisk) ---------------------------------- */
.brand {
  font-weight: 800;
  letter-spacing: .2px;
}
.bigTimer { color: #111827; }
.small { color: #475569; }

/* ---- Emails & tabel scroll ------------------------------------------------ */
#ov-email .modal, #ov-edit .modal {
  max-width: 960px;
}
#view-hist table th, #view-hist table td {
  vertical-align: top;
  font-size: 13px;
}

/* ---- Fallback for gradient hvis browser ikke understøtter moderne syntax -- */
.btn-start, .btn-stop, .bar {
  background-image: none; /* klassisk fladt hvis gradient glipper */
}

/* ---- Aktiv status-dot fallback ------------------------------------------- */
.dot { background: #22c55e; }
html[data-theme="dark"] .dot { background: #16a34a; }
</style>
<script>
/* ========== DEL 20: Edge Legacy-kompatibilitet ============================
   Indeholder polyfills, fallback-funktioner og detection for ældre Edge.
   Gør hele systemet robust på Windows 10 (20H2) og Edge v44 (Legacy).
========================================================================== */

// ----- Polyfill: Element.classList ---------------------------------------
if (!("classList" in document.documentElement)) {
  Object.defineProperty(Element.prototype, "classList", {
    get: function () {
      var self = this;
      return {
        add: function (c) { if (self.className.indexOf(c) < 0) self.className += (self.className ? " " : "") + c; },
        remove: function (c) { self.className = self.className.replace(new RegExp("\\b" + c + "\\b", "g"), "").trim(); },
        contains: function (c) { return self.className.indexOf(c) >= 0; }
      };
    }
  });
}

// ----- Polyfill: Element.closest ----------------------------------------
if (!Element.prototype.closest) {
  Element.prototype.closest = function (s) {
    var el = this;
    while (el && el.nodeType === 1) {
      if (el.msMatchesSelector ? el.msMatchesSelector(s) : el.webkitMatchesSelector(s)) return el;
      el = el.parentElement || el.parentNode;
    }
    return null;
  };
}

// ----- Polyfill: String.startsWith ---------------------------------------
if (!String.prototype.startsWith) {
  String.prototype.startsWith = function (search, pos) {
    return this.substr(!pos || pos < 0 ? 0 : +pos, search.length) === search;
  };
}

// ----- Polyfill: Array.from ----------------------------------------------
if (!Array.from) {
  Array.from = function (obj) {
    return [].slice.call(obj);
  };
}

// ----- Polyfill: Object.assign -------------------------------------------
if (!Object.assign) {
  Object.assign = function (target) {
    if (target == null) throw new TypeError("Cannot convert undefined or null to object");
    target = Object(target);
    for (var i = 1; i < arguments.length; i++) {
      var src = arguments[i];
      if (src != null) {
        for (var key in src) if (Object.prototype.hasOwnProperty.call(src, key)) target[key] = src[key];
      }
    }
    return target;
  };
}

// ----- Polyfill: JSON og localStorage sikkerhed ---------------------------
try {
  if (!window.localStorage) window.localStorage = { getItem: function(){}, setItem: function(){}, removeItem: function(){} };
  if (!window.JSON) window.JSON = { parse: function(s){return eval("(" + s + ")");}, stringify: function(o){return o.toString();} };
} catch (e) {}

// ----- Sticky detection ---------------------------------------------------
(function () {
  try {
    var test = document.createElement("div");
    test.style.position = "sticky";
    if (!test.style.position || test.style.position.indexOf("sticky") === -1) {
      document.documentElement.className += " no-sticky";
    }
  } catch (err) {
    document.documentElement.className += " no-sticky";
  }
})();

// ----- Safe console -------------------------------------------------------
if (!window.console) window.console = { log: function(){}, warn: function(){}, error: function(){} };

// ----- DOMContentLoaded fallback (for gammel Edge load) ------------------
if (!document.addEventListener) {
  document.onreadystatechange = function () {
    if (document.readyState === "complete") {
      try { initApp(); } catch (e) { alert("Fejl under init: " + e.message); }
    }
  };
}

console.log("✅ Edge Legacy polyfills indlæst");
</script>
<script>
/* ========== DEL 21 / 21 — Final load-order check & safe startup ============
   ES5-venlig kontrol for gammel Edge (v44 / Windows 10 20H2).
   - Logger om kernefunktioner findes (initApp, render* m.fl.)
   - Sætter html.ready-app hvis alt er OK
   - Viser simple advarsler i konsollen hvis noget mangler
============================================================================ */

(function () {
  function exists(fnName) {
    try { return typeof window[fnName] === "function"; } catch (e) { return false; }
  }
  function el(id) {
    try { return document.getElementById(id); } catch (e) { return null; }
  }

  var checks = [
    "initApp",
    "bindEls",
    "renderTable",
    "renderActivity8h",
    "renderLog8h",
    "renderStats",
    "renderPareto",
    "applyBrand",
    "renderCustomList",
    "renderHandoverList",
    "restoreCurrentStop",
    "restoreHandoverDraft",
    "bindStopStartButtons",
    "bindHistoryButtons",
    "bindShareButtons",
    "bindSettingsButtons",
    "bindCauseButtons",
    "bindHandoverButtons",
    "setActiveTab"
  ];

  var missing = [];
  for (var i = 0; i < checks.length; i++) {
    if (!exists(checks[i])) missing.push(checks[i]);
  }

  // Tjek et par nøgle-elementer i DOM
  var elChecks = [
    "tab-handling","tab-stats","tab-hist","tab-share","tab-settings",
    "view-handling","view-stats","view-hist","view-share","view-settings",
    "btn-stop","btn-start","pie-freq","pie-dur","pareto","tbl-body"
  ];
  var missingEls = [];
  for (var j = 0; j < elChecks.length; j++) {
    if (!el(elChecks[j])) missingEls.push(elChecks[j]);
  }

  if (missing.length === 0 && missingEls.length === 0) {
    // Markér “klar”
    try {
      var html = document.documentElement;
      if (html && html.className.indexOf("ready-app") === -1) {
        html.className += (html.className ? " " : "") + "ready-app";
      }
    } catch (e) {}
    if (window.console && console.log) {
      console.log("✅ DEL 21: Alt ser fint ud. App er klar (Edge legacy kompatibel).");
    }
  } else {
    if (window.console && console.warn) {
      if (missing.length)  console.warn("⚠️ DEL 21: Manglende funktioner:", missing.join(", "));
      if (missingEls.length) console.warn("⚠️ DEL 21: Manglende DOM-elementer:", missingEls.join(", "));
      console.warn("Tjek at alle dele 1–20 er indsat i korrekt rækkefølge før denne del.");
    }
  }

  // Ekstra sikkerhed: Start app hvis den ikke allerede er startet.
  // (Gør ingenting hvis initApp allerede har kørt)
  if (exists("initApp")) {
    // Hvis vi ikke allerede har markeret “ready-app”, så prøv at starte
    var htmlOk = (document.documentElement.className || "").indexOf("ready-app") !== -1;
    if (!htmlOk) {
      try { initApp(); } catch (e) { if (console && console.error) console.error("Fejl ved initApp i DEL 21:", e); }
    }
  }
})();
</script>
