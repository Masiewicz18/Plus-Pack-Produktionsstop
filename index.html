<!doctype html>
<html lang="da">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Plus Pack – Produktionsstop (kombineret + skift + migration)</title>

    <style>
    :root{
      --brand:#0a61ae; --bg:#f6f8fb; --panel:#fff; --divider:#e7edf4;
      --text:#0f172a; --muted:#64748b; --ok:#22c55e; --warn:#f59e0b;
      --danger:#ef4444; --accent:#2563eb; --accent2:#06b6d4;
      --shadow:0 6px 24px rgba(15,23,42,.06)
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;font-family:Segoe UI,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
    .brand{background:var(--brand);color:#fff;padding:12px 18px;font-weight:800;letter-spacing:.2px}
    .container{max-width:1160px;margin:0 auto;padding:16px}
    .card{background:var(--panel);border:1px solid var(--divider);border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:var(--shadow)}
    .muted{color:var(--muted)} .right{text-align:right}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{border:1px solid var(--divider);border-radius:10px;padding:10px 12px;background:#fff;color:var(--text)}
    textarea{min-height:84px}
    .btn{border:1px solid var(--divider);background:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:800}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .grid{display:grid;gap:12px}.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}
    .field{display:grid;gap:6px}
    .pill{padding:2px 8px;border:1px solid #d8e0eb;border-radius:999px;background:#fff;font-size:12px}

          /* Tabs/status */
    .tabs{display:flex;gap:8px;background:#fff;border-bottom:1px solid var(--divider);padding:8px 10px;align-items:center;position:sticky;top:0;z-index:9}
    .tab{border:0;background:transparent;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:800}
    .tab.active{background:#f8fafc;border:1px solid var(--divider)}
    .status{margin-left:auto;display:inline-flex;gap:10px;align-items:center;background:#fff;border:1px solid var(--divider);padding:6px 10px;border-radius:999px}
    .dot{width:12px;height:12px;border-radius:999px;background:var(--ok);box-shadow:0 0 0 2px rgba(0,0,0,.04) inset}
    /* Handling CTA */
    .actions{display:grid;gap:16px}.cta{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn-stop{background:linear-gradient(180deg, rgba(220,38,38,.10), rgba(220,38,38,.04));border-color:#f2aaaa;color:#7f1d1d;font-size:22px;padding:18px}
    .btn-start{background:linear-gradient(180deg, rgba(16,185,129,.10), rgba(16,185,129,.04));border-color:#a6e3b9;color:#065f46;font-size:22px;padding:18px}
    .details{border:1px dashed #d8e0eb;border-radius:14px;padding:12px;background:#fbfdff}
    /* BIG timer */
    .bigTimer{margin:10px 0 0;font:700 44px/1.1 ui-monospace,Consolas,monospace;letter-spacing:.5px;color:#111827}
    .bigTimer .lbl{display:block;font:600 12px/1 Segoe UI,Arial;color:var(--muted);letter-spacing:.2px;margin-bottom:4px}
    /* Aktivitet (8t) */
    .activity{width:100%;height:140px}
    .activity .gridline{stroke:#e5e7eb;stroke-width:1}.activity .gridline.sub{opacity:.5}
    .activity .now{stroke:var(--brand);stroke-width:2}
    .activity .runbg{fill:rgba(16,185,129,.06)}
    .activity .label{fill:#475569;font-size:10px}
    .activity .stop{fill:rgba(220,38,38,.28);stroke:#dc2626;stroke-width:1}

          /* Chips */
    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:10px;border:1px solid #d8e0eb;background:#f2f6fb;padding:10px 12px;border-radius:999px;font-size:13px;cursor:pointer}
    .chip input{width:16px;height:16px}
    .chip-radio.selected{background:#e8f1ff;border-color:var(--accent);font-weight:700}
    .chip-check.selected{background:#ecfdf5;border-color:var(--accent2);font-weight:700}
    /* Log */
    .logcard h4{margin:0 0 8px;font-weight:900}
    .loglist{list-style:none;margin:0;padding:0;max-height:180px;overflow:auto;border:1px dashed #d8e0eb;border-radius:12px;background:#fff}
    .loglist li{display:grid;grid-template-columns:140px 1fr;gap:10px;padding:8px 10px;border-bottom:1px solid #eef2f7}
    .loglist li:last-child{border-bottom:0}.loglist .ts{color:var(--muted);font-size:12px}.loglist .tag{display:inline-block;border:1px solid #e2e8f0;background:#f8fafc;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}
    /* Overlays/modals */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000;pointer-events:none}
    .overlay.open{display:flex;pointer-events:auto}
    .modal{background:#fff;border:1px solid var(--divider);border-radius:14px;max-width:980px;width:96vw;box-shadow:0 30px 80px rgba(0,0,0,.25)}
    .modal-h,.modal-f{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-color:var(--divider)}
    .modal-h{border-bottom:1px solid var(--divider)} .modal-b{padding:12px 14px}
    .modal-f{border-top:1px solid var(--divider);gap:8px}
    /* Dark & temaer */
    html[data-theme="dark"] body{background:#0b1220;color:#e5e7eb}
    html[data-theme="dark"] .tabs,html[data-theme="dark"] .card,html[data-theme="dark"] .status{background:#111827;border-color:#1f2937}
    html[data-theme="dark"] .btn,html[data-theme="dark"] input,html[data-theme="dark"] select,html[data-theme="dark"] textarea{background:#0f172a;border-color:#1f2937;color:#e5e7eb}
    html[data-theme="dark"] .muted{color:#9ca3af}
    /* Stats */
    .stats-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .kpi{background:#f8fafc;border:1px solid var(--divider);border-radius:12px;padding:10px}.kpi .val{font-weight:900;font-size:24px}
    .panel{border:1px solid var(--divider);border-radius:12px;padding:12px}
    .chart{width:100%;height:220px}
    .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}.legend .pill{display:inline-flex;align-items:center;gap:6px}
    .barlist{display:grid;gap:8px}.barrow{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
    .bar{height:10px;border-radius:999px;background:linear-gradient(90deg,#c7d2fe,#93c5fd)}
    .small{font-size:12px}.select{min-width:220px}
  </style>

    <!-- Vedvarende timer + CURRENT_STOP -->
  <script>
    const CURRENT_STOP = 'produktionsstop.current.v1';
    const loadCurrentStop = () => {
      try { return JSON.parse(localStorage.getItem(CURRENT_STOP)); } catch(e){ return null; }
    };
    const saveCurrentStop = (obj) => localStorage.setItem(CURRENT_STOP, JSON.stringify(obj));
    const clearCurrentStop = () => localStorage.removeItem(CURRENT_STOP);
  </script>
</head>

<body>
  <div class="brand">Plus Pack – Produktionsstop</div>

  <div class="tabs">
    <button class="tab active" id="tab-handling" type="button">Handling</button>
    <button class="tab" id="tab-stats" type="button">Stop-statistik</button>
    <button class="tab" id="tab-hist" type="button">Historik</button>
    <button class="tab" id="tab-share" type="button">Deling</button>
    <button class="tab" id="tab-settings" type="button">Indstillinger</button>
    <div class="status"><span class="dot" id="dot"></span><span id="statxt">Kører</span></div>
  </div>

  <div class="container">

        <!-- Handling -->
    <section id="view-handling">
      <div class="card">
        <div class="actions">
          <div class="cta">
            <button class="btn btn-stop" id="btn-stop" type="button">⏹ STOP (Ctrl+S)</button>
            <button class="btn btn-start" id="btn-start" type="button" disabled>▶ START (Ctrl+A)</button>
          </div>
          <div class="bigTimer"><span class="lbl">Aktuelt stop</span><span id="liveTimer">—</span></div>
          <div class="details">
            <div class="grid grid-3">
              <div class="field"><label>Linje / maskine</label>
                <select id="line">
                  <option value="">— Vælg maskine —</option>
                  <option>L10 75 t Rhodes special presse</option>
                  <option>L11 Mech RF135 serie nr 18-11 Mnr888</option>
                  <option disabled>L12 30 t Flexo C30 S15 INAKTIV</option>
                  <option>L13 Press Beutler PD 40</option>
                  <option>L14 50 t Flexo C50 S20 presse</option>
                  <option>L15 30 t Flexo C30 S15 presse</option>
                  <option>L16 40 t Schuler PNH 40/250 presse</option>
                  <option>L17 30 t Flexo C30 S15 presse</option>
                  <option>L20 50 t Bliss 50F MKII presse</option>
                  <option>L22 50 t Bliss 50F MKII presse</option>
                  <option>L23 45 t Bliss 21½ presse</option>
                  <option>L24 30 t Flexo C30 S15</option>
                  <option>L25 30 t Flexo C30 X presse</option>
                  <option>L26 L 36 30 t Flexo C30 S 15 presse</option>
                  <option>L27 45 t Bliss 21½ presse</option>
                  <option>L28 50 t Flexo presse</option>
                  <option>L29 30 t Flexo C30 presse</option>
                  <option>L30 ny presse 2012</option>
                  <option>L33 50 t Bliss 50F MKII presse</option>
                  <option>L34 50 t Bliss 50F MKII presse</option>
                  <option>L35 30 t Flexo C30 S15 presse</option>
                  <option>L36 30 t Flexo C30 S15 presse Picop</option>
                  <option>L40 50 t Flexo C50 S20 presse</option>
                  <option>L41 L37, 50 t Bliss 50F MKII presse</option>
                  <option>L42 Press Beutler PD 40 alu spez638</option>
                  <option>L43 Press Beutler PD 40 alu spez637</option>
                  <option>L80 Choko-kapsler</option>
                  <option>L81 Lys-manchetter</option>
                  <option>L82 Lys-manchetter</option>
                </select>
              </div>
              <div class="field"><label>Ordre nr. (krævet)</label><input id="orderNo" type="text"/></div>
              <div class="field"><label>Vare nr. (krævet)</label><input id="itemNo" type="text"/></div>
            </div>

            <div class="grid grid-3" style="margin-top:8px">
              <div class="field"><label>Operatør (valgfri)</label><input id="operator" type="text" placeholder="Navn/initialer"/></div>
              <div class="field"><label>&nbsp;</label><button class="btn" id="btn-clear-order" type="button">Ryd ordre</button></div>
              <div class="field"><label>&nbsp;</label>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <button class="btn" id="btn-clear-line" type="button">Ryd linje/navn</button>
                  <button class="btn" id="btn-open-rep" type="button">Åbn rep-seddel</button>
                </div>
              </div>
            </div>
          </div><!-- /.details -->
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px;font-weight:900">Aktivitet – sidste 8 timer</h3>
        <svg class="activity" viewBox="0 0 920 140" id="activity8h"></svg>
        <p class="muted small" style="margin-top:6px">Røde felter = registrerede stop. Højre kant er nu.</p>
      </div>

      <div class="card logcard">
        <h4>Aktivitetslog (sidste 8 timer)</h4>
        <ul class="loglist" id="log8h"></ul>
      </div>

      <div class="card handover">
        <h4 style="margin:0 0 8px;font-weight:900">Overlevering / skift-noter</h4>
        <div class="grid grid-2">
          <div class="field"><label>Noter til næste skift</label>
            <textarea id="handoverText" placeholder="Skriv kort status, åbne punkter, kendte fejl osv."></textarea></div>
          <div class="field"><label>Tag (valgfrit)</label>
            <input id="handoverTag" type="text" placeholder="fx Vedligehold, Kvalitet, Værktøj"/></div>
        </div>
        <div class="actions" style="margin-top:8px">
          <button class="btn btn-start" id="handoverSave" type="button">Gem note</button>
          <button class="btn" id="handoverClear" type="button">Ryd felt</button>
        </div>
        <div class="handover list" id="handoverList" style="margin-top:12px"></div>
      </div>
    </section>

        <!-- Stop modal -->
    <div class="overlay" id="ov-stop">
      <div class="modal">
        <div class="modal-h"><strong>Registrér stop</strong><button class="btn" id="stop-close" type="button">Luk</button></div>
        <div class="modal-b">
          <div class="grid grid-2">
            <div><label>Årsag</label><div class="chips" id="reasonTop"></div><div class="chips" id="reasonMore" style="margin-top:8px"></div></div>
            <div><label>Uddybning (chips)</label><div class="chips" id="reasonChips"></div></div>
          </div>
          <div class="grid grid-2" style="margin-top:8px">
            <div class="field"><label>Andet</label><input id="other" type="text"/></div>
            <div class="field"><label>Kommentar</label><input id="comment" type="text"/></div>
          </div>
          <p id="stopValidation" class="muted"></p>
        </div>
        <div class="modal-f">
          <button class="btn" id="stop-cancel" type="button">Annuller</button>
          <button class="btn btn-stop" id="stop-confirm" type="button">Bekræft stop</button>
        </div>
      </div>
    </div>

    <!-- Rep modal -->
    <div class="overlay" id="ov-rep">
      <div class="modal">
        <div class="modal-h"><strong>Reparationsseddel</strong><button class="btn" id="rep-close" type="button">Luk</button></div>
        <div class="modal-b">
          <div class="grid grid-2">
            <div class="field"><label>Modtager</label><input id="rep-to" type="email" placeholder="vedligehold@pluspack.com"/></div>
            <div class="field"><label>CC</label><input id="rep-cc" type="text" placeholder="valgfri, kommasepareret"/></div>
          </div>
          <div class="field" style="margin-top:8px"><label>Emne</label><input id="rep-subj" type="text" placeholder="Reparationsseddel – [Linje] [Ordre]/[Vare]"/></div>
          <div class="grid grid-2" style="margin-top:8px">
            <div class="field"><label>Prioritet</label><select id="rep-pri"><option>Lav</option><option>Mellem</option><option>Høj</option><option>Kritisk</option></select></div>
            <div class="field"><label>Fejltype</label><input id="rep-type" type="text" placeholder="fx Mekanisk, Elektrisk"/></div>
          </div>
          <div class="grid grid-1" style="margin-top:8px">
            <div class="field"><label>Beskrivelse</label><textarea id="rep-desc" placeholder="Kort og præcis beskrivelse (symptomer, hvornår, hvad er prøvet)"></textarea></div>
          </div>
          <p class="muted" id="repValidation"></p>
        </div>
        <div class="modal-f">
          <button class="btn" id="rep-download" type="button">Download TXT</button>
          <button class="btn btn-start" id="rep-send" type="button">Åbn mail</button>
        </div>
      </div>
    </div>

      <!-- Stats -->
    <section id="view-stats" style="display:none">
      <div class="card">
        <div class="grid" style="grid-template-columns:1fr auto;align-items:center;margin-bottom:8px">
          <h3 style="margin:0">Stop-statistik</h3>
          <div style="display:flex;gap:8px;align-items:center">
            <label class="small">Skift:</label>
            <select id="shiftSelect" class="select">
              <option value="all">Alle stop</option>
              <option value="current">Nuværende skift</option>
              <option value="day">Dag (06-14)</option>
              <option value="evening">Aften (14-22)</option>
              <option value="night">Nat (22-06)</option>
            </select>
            <label class="small">Vis:</label>
            <select id="paretoMode" class="select">
              <option value="freq">Procentfordeling (hyppighed)</option>
              <option value="dur">Procentfordeling (varighed)</option>
            </select>
          </div>
        </div>

        <div class="stats-grid">
          <div class="kpi" style="grid-column:span 3"><div class="small muted">Antal stop</div><div class="val" id="kpi-count">0</div><div class="small muted">Poster i alt</div></div>
          <div class="kpi" style="grid-column:span 3"><div class="small muted">Samlet varighed</div><div class="val" id="kpi-dur">00:00:00</div><div class="small muted">hh:mm:ss</div></div>
          <div class="kpi" style="grid-column:span 3"><div class="small muted">Gns. pr. stop</div><div class="val" id="kpi-avg">00:00:00</div><div class="small muted">hh:mm:ss</div></div>
          <div class="kpi" style="grid-column:span 3"><div class="small muted">Top-årsag</div><div class="val" id="kpi-top">—</div><div class="small muted" id="kpi-top-sub">Hyppigst: —</div></div>

          <div class="panel" style="grid-column:span 6">
            <div class="small muted" style="margin-bottom:6px">Hyppighed – andele</div>
            <svg class="chart" id="pie-freq" viewBox="0 0 240 240"></svg>
            <div class="legend" id="legend-freq"></div>
          </div>
          <div class="panel" style="grid-column:span 6">
            <div class="small muted" style="margin-bottom:6px">Varighed – andele</div>
            <svg class="chart" id="pie-dur" viewBox="0 0 240 240"></svg>
            <div class="legend" id="legend-dur"></div>
          </div>

          <div class="panel" style="grid-column:span 6">
            <div class="small" style="font-weight:800;margin-bottom:8px">Hyppighed (antal pr. årsag)</div>
            <div class="barlist" id="bars-freq"></div>
          </div>
          <div class="panel" style="grid-column:span 6">
            <div class="small" style="font-weight:800;margin-bottom:8px">Varighed (sum pr. årsag)</div>
            <div class="barlist" id="bars-dur"></div>
          </div>

          <div class="panel" style="grid-column:span 12">
            <div class="grid" style="grid-template-columns:1fr auto;align-items:center;margin-bottom:8px">
              <div style="font-weight:800">Pareto</div>
              <div class="small muted">Kumulativ %</div>
            </div>
            <svg class="chart" id="pareto" viewBox="0 0 760 260"></svg>
          </div>
        </div>
      </div>
    </section>

        <!-- Historik -->
    <section id="view-hist" style="display:none">
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
          <strong>Poster:</strong><span id="countPosts">0</span>
          <strong style="margin-left:12px">Plads:</strong><span id="usageTxt">0%</span>
          <div class="usage" style="height:8px;background:#eef2f7;border:1px solid var(--divider);border-radius:999px;overflow:hidden;width:180px;display:inline-block;vertical-align:middle;margin-left:6px">
            <div id="usageFill" style="height:100%;width:0;background:linear-gradient(90deg,#c7d2fe,#93c5fd)"></div>
          </div>
          <button class="btn" id="btn-archive" type="button" style="margin-left:auto">Arkivér & nulstil</button>
        </div>
        <div style="overflow:auto;max-height:60vh;border:1px solid var(--divider);border-radius:10px">
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="background:#f8fafc">
                <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Start</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Slut</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Varighed</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Linje</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Ordre</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Vare</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Kode</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Uddybning</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Kommentar</th>
                <th style="text-align:left;padding:8px;border-bottom:1px solid var(--divider)">Operatør</th>
                <th style="text-align:right;padding:8px;border-bottom:1px solid var(--divider)">Handling</th>
              </tr>
            </thead>
            <tbody id="tbl-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Deling -->
    <section id="view-share" style="display:none">
      <div class="card">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btn-csv" type="button">Eksporter CSV</button>
          <button class="btn" id="btn-json" type="button">Kopiér JSON</button>
          <button class="btn" id="btn-email" type="button">Send til mail</button>
          <button class="btn" id="btn-clear-log" type="button">Nulstil log</button>
        </div>
        <p class="muted small">Data gemmes lokalt i browseren (localStorage).</p>
      </div>
    </section>

        <!-- Indstillinger -->
    <section id="view-settings" style="display:none">
      <div class="card">
        <div class="grid grid-2">
          <div class="field"><label>Standard-modtager</label><input id="defTo" type="email" placeholder="vedligehold@pluspack.com"/></div>
          <div class="field"><label>Brandfarve</label><input id="brandColor" type="text" placeholder="#0a61ae"/></div>
        </div>
        <div class="grid grid-2" style="margin-top:8px">
          <div class="field"><label>Farvetema</label>
            <select id="themeSelect">
              <option value="standard">Standard (pasteller)</option>
              <option value="mono">Mono-blå</option>
              <option value="dark">Mørk</option>
            </select>
          </div>
          <div class="field"><label>&nbsp;</label><button class="btn" id="btn-save-settings" type="button">Gem indstillinger</button></div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Årsager</h3>
        <div class="grid grid-2">
          <div class="field"><label>Kode (fx PRES)</label><input id="causeCode" type="text" placeholder="KODE"/></div>
          <div class="field"><label>Navn/label</label><input id="causeLabel" type="text" placeholder="Beskrivelse"/></div>
        </div>
        <div class="field" style="margin-top:8px"><label>Uddybning (chips, kommasepareret)</label><input id="causeChips" type="text" placeholder="fx Rensning, Sikkerhed, Opsætning"/></div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="btn-add-cause" type="button">Tilføj årsag</button>
          <button class="btn" id="btn-reset-causes" type="button">Nulstil til standard</button>
        </div>
        <div id="causeList" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- EMAIL MODAL -->
    <div class="overlay" id="ov-email">
      <div class="modal">
        <div class="modal-h"><strong>Send til e-mail</strong><button class="btn" id="email-close" type="button">Luk</button></div>
        <div class="modal-b">
          <div class="grid grid-2">
            <div class="field"><label>Til</label><input id="email-to" type="email"/></div>
            <div class="field"><label>Cc</label><input id="email-cc" type="text"/></div>
          </div>
          <div class="grid grid-2">
            <div class="field"><label>Emne</label><input id="email-subj" type="text"/></div>
            <div class="field"><label>Vedhæft</label>
              <select id="email-attach"><option value="csv">CSV</option><option value="json">JSON</option></select>
            </div>
          </div>
          <div class="field"><label>Besked</label><textarea id="email-body">Se vedhæftede produktionsstop-log.</textarea></div>
        </div>
        <div class="modal-f">
          <button class="btn" id="email-cancel" type="button">Annuller</button>
          <button class="btn" id="email-send" type="button">Send</button>
        </div>
      </div>
    </div>

    <!-- EDIT MODAL (til historik-redigering) -->
    <div class="overlay" id="ov-edit">
      <div class="modal">
        <div class="modal-h">
          <strong>Redigér registrering</strong>
          <button class="btn" id="edit-close" type="button">Luk</button>
        </div>
        <div class="modal-b">
          <div class="grid grid-2">
            <div class="field"><label>Start</label><input id="edit-start" type="datetime-local"/></div>
            <div class="field"><label>Slut</label><input id="edit-end" type="datetime-local"/></div>
          </div>
          <div class="grid grid-3" style="margin-top:8px">
            <div class="field"><label>Varighed</label><input id="edit-dur" type="text" readonly/></div>
            <div class="field"><label>Linje</label><input id="edit-line" type="text"/></div>
            <div class="field"><label>Operatør</label><input id="edit-operator" type="text"/></div>
          </div>
          <div class="grid grid-3" style="margin-top:8px">
            <div class="field"><label>Ordre nr.</label><input id="edit-order" type="text"/></div>
            <div class="field"><label>Vare nr.</label><input id="edit-item" type="text"/></div>
            <div class="field"><label>Kode</label><input id="edit-code" type="text" placeholder="fx PRES"/></div>
          </div>
          <div class="grid grid-2" style="margin-top:8px">
            <div class="field"><label>Kode label</label><input id="edit-label" type="text" placeholder="fx Presse"/></div>
            <div class="field"><label>Uddybning (chips, kommasepareret)</label><input id="edit-chips" type="text" placeholder="fx Rensning, Opsætning"/></div>
          </div>
          <div class="grid grid-2" style="margin-top:8px">
            <div class="field"><label>Andet</label><input id="edit-other" type="text"/></div>
            <div class="field"><label>Kommentar</label><input id="edit-comment" type="text"/></div>
          </div>
          <p class="muted" id="editValidation" style="margin-top:6px"></p>
        </div>
        <div class="modal-f">
          <button class="btn" id="edit-cancel" type="button">Annuller</button>
          <button class="btn btn-start" id="edit-save" type="button">Gem ændringer</button>
        </div>
      </div>
    </div>

      <script>
    /* ==== Helpers & storage ==================================================== */
    const byId = id => document.getElementById(id);
    const addClass = (el,c)=>{ if(!el) return; if(!el.className.split(' ').includes(c)) el.className+=(el.className?' ':'')+c; };
    const remClass = (el,c)=>{ if(!el) return; el.className=el.className.split(' ').filter(x=>x!==c).join(' '); };
    const show = el => { if(el) el.style.display=''; };
    const hide = el => { if(el) el.style.display='none'; };
    const openOv = id => addClass(byId(id),'open');
    const closeOv = id => remClass(byId(id),'open');

    const pad = n => (n<10?'0':'')+n;
    const fmtDate = d => {
      const dt = (d instanceof Date)? d : new Date(d);
      try { return dt.toLocaleString('da-DK'); } catch(e){ return dt.toString(); }
    };
    const fmtDur = ms => {
      const s = Math.floor((ms||0)/1000);
      const h = pad(Math.floor(s/3600));
      const m = pad(Math.floor((s%3600)/60));
      const ss = pad(s%60);
      return `${h}:${m}:${ss}`;
    };
    const fmtShortDur = ms => {
      const s = Math.floor((ms||0)/1000);
      const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), ss = s%60;
      if(h>0) return `${h}t ${String(m).padStart(2,'0')}m`;
      if(m>0) return `${m}m ${String(ss).padStart(2,'0')}s`;
      return `${String(ss).padStart(2,'0')}s`;
    };
    const toLocalInputValue = iso => {
      if(!iso) return '';
      const d = new Date(iso), p=n=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
    };
    const fromLocalInputValue = val => val? new Date(val) : null;
    const uuid = () => `id-${Date.now()}-${Math.floor(Math.random()*1e6)}`;
    const bytesLen = str => unescape(encodeURIComponent(str||'')).length;

    const STORAGE='produktionsstop.events.v2';
    const SETTINGS='produktionsstop.settings.v2';
    const HANDOVER='produktionsstop.handover.v1';
    const HANDOVER_DRAFT='produktionsstop.handoverDraft.v1';
    const V1_EVENTS_KEY='produktionsstop.events.v1';
    const V1_SETTINGS_KEY='produktionsstop.settings.v1';

            const DEFAULT_REASONS=[
      {code:'PRES', label:'Presse',   chips:['Rensning','Smøring','Opsætning']},
      {code:'VAERK',label:'Værktøj',  chips:['Skift','Slid','Defekt']},
      {code:'STAK' ,label:'Stakker',  chips:['Fejl','Opsamler','Andet']},
      {code:'FOLIE',label:'Manglende folie', chips:['Påfyld','Bestilling']},
      {code:'ORDRE',label:'Manglende ordre', chips:['Afventer','Uklar ordre']},
      {code:'ANDET',label:'Andet',    chips:['Sikkerhed','Rengøring']}
    ];

    const loadEvents=()=>{ try{return JSON.parse(localStorage.getItem(STORAGE))||[]}catch(e){return[]} };
    const saveEvents=x=>localStorage.setItem(STORAGE,JSON.stringify(x));
    const loadSettings=()=>{ try{return JSON.parse(localStorage.getItem(SETTINGS))||{}}catch(e){return{}} };
    const saveSettings=x=>localStorage.setItem(SETTINGS,JSON.stringify(x));
    const loadHandover=()=>{ try{return JSON.parse(localStorage.getItem(HANDOVER))||[]}catch(e){return[]} };
    const saveHandover=x=>localStorage.setItem(HANDOVER,JSON.stringify(x));
    const loadDraft=()=>{ try{return JSON.parse(localStorage.getItem(HANDOVER_DRAFT))||{txt:'',tag:''}}catch(e){return{txt:'',tag:''}} };
    const saveDraft=obj=>localStorage.setItem(HANDOVER_DRAFT,JSON.stringify(obj));
    const clearDraft=()=>localStorage.removeItem(HANDOVER_DRAFT);

    const getAllReasons=()=>{
      const s=loadSettings(), custom=s.customCauses||[], map={}, out=[];
      DEFAULT_REASONS.forEach(r=>map[r.code]=r);
      custom.forEach(c=>map[c.code]={code:c.code,label:c.label,chips:c.chips||[]});
      for(const k in map) out.push(map[k]);
      return out;
    };

    /* ==== Migration V1 -> V2 =================================================== */
    function migrateFromV1IfNeeded(){
      try{
        const v2s=loadSettings();
        if(v2s && v2s.__migratedFromV1) return;
        const v1EventsRaw=localStorage.getItem(V1_EVENTS_KEY);
        const v1SettingsRaw=localStorage.getItem(V1_SETTINGS_KEY);
        let did=false;

        if(v1EventsRaw){
          let v1=[]; try{v1=JSON.parse(v1EventsRaw)||[]}catch(e){v1=[]}
          if(Array.isArray(v1)&&v1.length){
            const v2=loadEvents();
            const ids=new Set(v2.map(r=>r.id));
            const merged=v2.concat(v1.filter(r=>r&&r.id&&!ids.has(r.id)));
            if(merged.length!==v2.length){ saveEvents(merged); did=true; }
          }
        }

        if(v1SettingsRaw){
          let v1s={}; try{v1s=JSON.parse(v1SettingsRaw)||{}}catch(e){v1s={}}
          const newS={...loadSettings()};
          for(const k of ['defaultTo','brandColor','theme','orderNo','itemNo','operator','line'])
            if(v1s[k]) newS[k]=v1s[k];
          if(Array.isArray(v1s.customCauses)) newS.customCauses=v1s.customCauses;
          newS.__migratedFromV1=true; saveSettings(newS); did=true;
        }

        if(did){ console.log('[Migrering] V1 -> V2 gennemført'); }
      }catch(err){ console.warn('Migration error:', err); }
    }

            /* ==== Elements ============================================================= */
    const els={
      tabHandling:byId('tab-handling'), tabStats:byId('tab-stats'), tabHist:byId('tab-hist'),
      tabShare:byId('tab-share'), tabSettings:byId('tab-settings'),
      viewHandling:byId('view-handling'), viewStats:byId('view-stats'), viewHist:byId('view-hist'),
      viewShare:byId('view-share'), viewSettings:byId('view-settings'),
      dot:byId('dot'), statxt:byId('statxt'),
      btnStop:byId('btn-stop'), btnStart:byId('btn-start'),
      line:byId('line'), operator:byId('operator'), orderNo:byId('orderNo'), itemNo:byId('itemNo'),
      btnClearOrder:byId('btn-clear-order'), btnClearLine:byId('btn-clear-line'), btnOpenRep:byId('btn-open-rep'),
      liveTimer:byId('liveTimer'), activity:byId('activity8h'), log8h:byId('log8h'),
      ovStop:byId('ov-stop'), stopClose:byId('stop-close'), stopCancel:byId('stop-cancel'), stopConfirm:byId('stop-confirm'),
      reasonTop:byId('reasonTop'), reasonMore:byId('reasonMore'), reasonChips:byId('reasonChips'),
      other:byId('other'), comment:byId('comment'), stopValidation:byId('stopValidation'),
      ovRep:byId('ov-rep'), repClose:byId('rep-close'), repTo:byId('rep-to'), repCc:byId('rep-cc'),
      repSubj:byId('rep-subj'), repPri:byId('rep-pri'), repType:byId('rep-type'), repDesc:byId('rep-desc'),
      repValidation:byId('repValidation'), repSend:byId('rep-send'), repDl:byId('rep-download'),
      tableBody:byId('tbl-body'), countPosts:byId('countPosts'), usageTxt:byId('usageTxt'), usageFill:byId('usageFill'),
      btnArchive:byId('btn-archive'),
      kpiCount:byId('kpi-count'), kpiDur:byId('kpi-dur'), kpiAvg:byId('kpi-avg'), kpiTop:byId('kpi-top'), kpiTopSub:byId('kpi-top-sub'),
      handoverText:byId('handoverText'), handoverTag:byId('handoverTag'), handoverSave:byId('handoverSave'),
      handoverClear:byId('handoverClear'), handoverList:byId('handoverList'),
      defTo:byId('defTo'), brandColor:byId('brandColor'), themeSelect:byId('themeSelect'), btnSaveSettings:byId('btn-save-settings'),
      shiftSelect:byId('shiftSelect'), paretoMode:byId('paretoMode'),
      pieFreq:byId('pie-freq'), pieDur:byId('pie-dur'), legendFreq:byId('legend-freq'), legendDur:byId('legend-dur'),
      barsFreq:byId('bars-freq'), barsDur:byId('bars-dur'), pareto:byId('pareto'),
      ovEmail:byId('ov-email'), emailClose:byId('email-close'), emailCancel:byId('email-cancel'),
      emailSend:byId('email-send'), emailTo:byId('email-to'), emailCc:byId('email-cc'),
      emailSubj:byId('email-subj'), emailBody:byId('email-body'), emailAttach:byId('email-attach'),
      btnCsv:byId('btn-csv'), btnJson:byId('btn-json'), btnEmail:byId('btn-email'), btnClearLog:byId('btn-clear-log')
    };

    /* ==== Status & timer ======================================================= */
    let timer=null, IS_STOPPED=false, STOP_START_ISO=null, stopMeta=null;

    const setStatus = st => {
      IS_STOPPED=st;
      els.btnStop.disabled=st;
      els.btnStart.disabled=!st;
      els.dot.style.background = st?'var(--danger)':'var(--ok)';
      els.statxt.textContent = st?'Stoppet':'Kører';
      els.liveTimer.textContent = st?'00:00:00':'—';
    };

    const tick = () => {
      if(!IS_STOPPED) return;
      const ms = Date.now() - new Date(STOP_START_ISO);
      els.liveTimer.textContent = fmtDur(ms);
      renderActivity8h();
      renderLog8h();
    };

    const hasRequired = ()=> (els.orderNo.value||'').trim() && (els.itemNo.value||'').trim();
    const syncOrder = ()=>{
      const s=loadSettings();
      s.orderNo=els.orderNo.value||'';
      s.itemNo=els.itemNo.value||'';
      s.operator=els.operator.value||'';
      s.line=els.line.value||'';
      saveSettings(s);
    };

    const reasonList = ()=> getAllReasons().slice().sort((a,b)=>a.label.localeCompare(b.label));
    const getReasonByCode = code => getAllReasons().find(r=>r.code===code)||null;

    const renderChipsByCode = code => {
      const r=getReasonByCode(code)||{chips:[]};
      els.reasonChips.innerHTML = (r.chips||[]).map(c=>
        `<label class="pill" style="display:inline-flex;align-items:center;gap:8px"><input type="checkbox" value="${c}">${c}</label>`
      ).join('');
    };
    const selectedChips = ()=> Array.from(els.reasonChips.querySelectorAll('input[type="checkbox"]')).filter(i=>i.checked).map(i=>i.value);

            const onReasonAreaClick = e => {
      const t=e.target;
      if(t && t.name==='reasonRadio'){ renderChipsByCode(t.value); els.stopValidation.textContent=''; }
    };

    const renderReasonButtons = () => {
      const list=reasonList(), top=list.slice(0,8), more=list.slice(8);
      const mk=(c,l)=> `<label class="pill" style="display:inline-flex;align-items:center;gap:8px"><input type="radio" name="reasonRadio" value="${c}"><span>${c} — ${l}</span></label>`;
      els.reasonTop.innerHTML = top.map(r=>mk(r.code,r.label)).join('');
      els.reasonMore.innerHTML = more.map(r=>mk(r.code,r.label)).join('');
      const first = els.reasonTop.querySelector('input[name="reasonRadio"]') || els.reasonMore.querySelector('input[name="reasonRadio"]');
      if(first){ first.checked=true; renderChipsByCode(first.value); }
      els.reasonTop.onclick=onReasonAreaClick;
      els.reasonMore.onclick=onReasonAreaClick;
    };

    /* ==== Aktivitet og log ===================================================== */
    function renderActivity8h(){
      const svg=els.activity; if(!svg) return;
      svg.innerHTML='';
      const W=920,H=140,m={l:40,r:10,t:20,b:20},w=W-m.l-m.r,h=H-m.t-m.b;
      const now=new Date();
      const startWindow=new Date(now.getTime()-8*3600*1000);
      const xPos=t=> m.l + Math.max(0,Math.min(w, ((t-startWindow)/(8*3600*1000))*w ));

      const rectBg=document.createElementNS('http://www.w3.org/2000/svg','rect');
      rectBg.setAttribute('x',m.l); rectBg.setAttribute('y',m.t);
      rectBg.setAttribute('width',w); rectBg.setAttribute('height',h);
      rectBg.setAttribute('class','runbg'); svg.appendChild(rectBg);

      for(let i=0;i<=8;i++){
        const x=m.l+(w*(i/8));
        const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
        ln.setAttribute('x1',x); ln.setAttribute('y1',m.t);
        ln.setAttribute('x2',x); ln.setAttribute('y2',m.t+h);
        ln.setAttribute('class','gridline'); svg.appendChild(ln);

        const t=document.createElementNS('http://www.w3.org/2000/svg','text');
        const dt=new Date(startWindow.getTime()+i*3600*1000);
        t.setAttribute('x',x+2); t.setAttribute('y',H-4);
        t.setAttribute('class','label'); t.textContent=`${pad(dt.getHours())}:00`;
        svg.appendChild(t);

        if(i<8){
          const xh=x+(w/8)/2;
          const ln2=document.createElementNS('http://www.w3.org/2000/svg','line');
          ln2.setAttribute('x1',xh); ln2.setAttribute('y1',m.t);
          ln2.setAttribute('x2',xh); ln2.setAttribute('y2',m.t+h);
          ln2.setAttribute('class','gridline sub'); svg.appendChild(ln2);
        }
      }

      const rows=loadEvents(); const stops=[];
      rows.forEach(r=>{
        if(!r.end) return;
        const s=new Date(r.start), e=new Date(r.end);
        if(e<startWindow||s>now) return;
        const cs=Math.max(s.getTime(),startWindow.getTime());
        const ce=Math.min(e.getTime(),now.getTime());
        if(ce>cs) stops.push([cs,ce]);
      });
      if(IS_STOPPED && STOP_START_ISO){
        const s2=Math.max(new Date(STOP_START_ISO).getTime(),startWindow.getTime());
        const e2=now.getTime();
        if(e2>s2) stops.push([s2,e2]);
      }

      stops.forEach(seg=>{
        const xs=xPos(seg[0]), xe=xPos(seg[1]);
        const r=document.createElementNS('http://www.w3.org/2000/svg','rect');
        r.setAttribute('x',xs); r.setAttribute('y',m.t+8);
        r.setAttribute('width',Math.max(1,xe-xs)); r.setAttribute('height',h-16);
        r.setAttribute('class','stop'); svg.appendChild(r);
      });

      const xnow=xPos(now);
      const nowLn=document.createElementNS('http://www.w3.org/2000/svg','line');
      nowLn.setAttribute('x1',xnow); nowLn.setAttribute('y1',m.t-2);
      nowLn.setAttribute('x2',xnow); nowLn.setAttribute('y2',m.t+h+2);
      nowLn.setAttribute('class','now'); svg.appendChild(nowLn);
    }

    function renderLog8h(){
      const el=els.log8h; if(!el) return;
      el.innerHTML='';
      const now=new Date();
      const startWindow=new Date(now.getTime()-8*3600*1000);
      const rows=loadEvents().filter(r=>r.end && new Date(r.end)>startWindow).sort((a,b)=>new Date(b.start)-new Date(a.start));

      if(rows.length===0 && !(IS_STOPPED && STOP_START_ISO)){
        el.innerHTML='<li class="muted" style="padding:8px 0">Ingen registreringer i perioden</li>';
        return;
      }
      if(IS_STOPPED && STOP_START_ISO){
        const ms=Date.now()-new Date(STOP_START_ISO);
        const li=document.createElement('li');
        li.innerHTML=`<span class="ts">NU</span><div><strong>Aktivt stop</strong> <span class="tag">${fmtDur(ms)}</span></div>`;
        el.appendChild(li);
      }
      rows.forEach(r=>{
        const li=document.createElement('li');
        const code=(r.reason&&r.reason.code)||'';
        li.innerHTML=`<span class="ts">${fmtDate(r.start)}</span><div>${code?`<span class="tag">${code}</span>`:''}${(r.reason&&r.reason.label)||'Stop'} – <span class="muted">${fmtDur(r.durationMs||0)}</span>${r.comment?(' · '+r.comment):''}</div>`;
        el.appendChild(li);
      });
    }

         /* ==== Handover + autosave ================================================ */
    function renderHandover(){
      const list=loadHandover().sort((a,b)=>new Date(b.ts)-new Date(a.ts));
      const c=els.handoverList; c.innerHTML='';
      if(!list.length){ c.innerHTML='<div class="item"><div class="muted small">Ingen noter endnu</div></div>'; return; }
      list.forEach((row,idx)=>{
        const d=document.createElement('div');
        d.className='item';
        d.style.border='1px solid var(--divider)';
        d.style.borderRadius='12px';
        d.style.padding='10px';
        d.style.background='#fff';
        d.innerHTML=
          `<div class="muted small">${fmtDate(row.ts)}${row.tag?(' · '+row.tag):''}</div>
           <div>${row.txt}</div>
           <div class="right" style="margin-top:6px"><button class="btn" data-i="${idx}" type="button">Slet</button></div>`;
        c.appendChild(d);
      });
      c.querySelectorAll('button').forEach(b=>b.onclick=function(){
        const i=parseInt(this.getAttribute('data-i'),10);
        const arr=loadHandover(); arr.splice(i,1); saveHandover(arr); renderHandover();
      });
    }
    function restoreHandoverDraft(){
      const d=loadDraft();
      if(!els.handoverText.value) els.handoverText.value=d.txt||'';
      if(!els.handoverTag.value) els.handoverTag.value=d.tag||'';
    }
    function bindDraftAutosave(){
      const onDraftChange=()=>saveDraft({ txt:els.handoverText.value||'', tag:els.handoverTag.value||'' });
      els.handoverText.addEventListener('input', onDraftChange);
      els.handoverTag.addEventListener('input', onDraftChange);
    }

    /* ==== Stats (skift + aggregering) ======================================== */
    function getShiftRange(type, ref=new Date()){
      const d=new Date(ref); const y=d.getFullYear(), m=d.getMonth(), day=d.getDate();
      const at=h=>new Date(y,m,day,h,0,0);
      if(type==='day') return [at(6), at(14)];
      if(type==='evening') return [at(14), at(22)];
      if(type==='night'){ const s=at(22), e=new Date(y,m,day+1,6,0,0); return [s,e]; }
      if(type==='current'){
        const now=d, ranges=[getShiftRange('day',d),getShiftRange('evening',d),getShiftRange('night',d)];
        for(const [s,e] of ranges){ if(now>=s && now<e) return [s,e]; }
        return getShiftRange('night', new Date(y,m,day-1,23,0,0));
      }
      return [null,null];
    }
    function filteredEvents(){
      const mode=(els.shiftSelect && els.shiftSelect.value) || 'all';
      if(mode==='all') return loadEvents();
      const [s,e]=getShiftRange(mode);
      return loadEvents().filter(r=>{
        const rs=new Date(r.start), re=new Date(r.end||Date.now());
        return (!s || re>=s) && (!e || rs<e);
      });
    }
    function aggregateByCause(rows){
      const map=new Map();
      rows.forEach(r=>{
        const code=(r.reason&&r.reason.code)||'UKENDT';
        const label=(r.reason&&r.reason.label)||'Ukendt';
        const key=code+'|'+label;
        if(!map.has(key)) map.set(key,{code,label,count:0,dur:0});
        const x=map.get(key);
        x.count+=1; x.dur+=(r.durationMs||0);
      });
      return Array.from(map.values()).sort((a,b)=> (b.count-a.count) || (b.dur-a.dur) );
    }

         /* ==== Charts (SVG) ======================================================== */
    function renderDonut(svgEl, data, getVal){
      svgEl.innerHTML='';
      const cx=120, cy=120, r=80, th=28;
      const total=data.reduce((a,x)=>a+getVal(x),0) || 1;
      let start=-Math.PI/2;
      const cols=['#22c55e','#93c5fd','#cbd5e1','#a7f3d0','#fca5a5','#fde68a','#ddd','#60a5fa','#34d399','#a78bfa'];
      data.forEach((d,i)=>{
        const val=getVal(d); const ang=(val/total)*Math.PI*2; const end=start+ang; const large=ang>Math.PI?1:0;
        const x1=cx+Math.cos(start)*r, y1=cy+Math.sin(start)*r;
        const x2=cx+Math.cos(end)*r,   y2=cy+Math.sin(end)*r;
        const x3=cx+Math.cos(end)*(r-th), y3=cy+Math.sin(end)*(r-th);
        const x4=cx+Math.cos(start)*(r-th), y4=cy+Math.sin(start)*(r-th);
        const p=document.createElementNS('http://www.w3.org/2000/svg','path');
        p.setAttribute('d', `M ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2} L ${x3} ${y3} A ${r-th} ${r-th} 0 ${large} 0 ${x4} ${y4} Z`);
        p.setAttribute('fill', cols[i%cols.length]);
        svgEl.appendChild(p);
        start=end;
      });
      const sumTxt=document.createElementNS('http://www.w3.org/2000/svg','text');
      sumTxt.setAttribute('x',cx); sumTxt.setAttribute('y',cy+4);
      sumTxt.setAttribute('text-anchor','middle'); sumTxt.setAttribute('font-size','20'); sumTxt.setAttribute('font-weight','700');
      sumTxt.textContent = data.reduce((a,x)=>a+getVal(x),0);
      svgEl.appendChild(sumTxt);
    }

    function renderLegend(el,data,fmt){
      const cols=['#22c55e','#93c5fd','#cbd5e1','#a7f3d0','#fca5a5','#fde68a','#ddd','#60a5fa','#34d399','#a78bfa'];
      el.innerHTML = data.map((d,i)=>
        `<span class="pill"><span style="display:inline-block;width:10px;height:10px;border-radius:999px;background:${cols[i%cols.length]}"></span>${d.code} — ${d.label} <span class="small muted">${fmt(d)}</span></span>`
      ).join(' ');
    }

    function renderBars(container,data,fmtVal,relKey){
      const max=Math.max(...data.map(x=>x[relKey]||0),1);
      container.innerHTML = data.map(d=>{
        const w=Math.round((d[relKey]/max)*100);
        return `<div class="barrow">
          <div class="small muted" style="min-width:80px">${d.code}</div>
          <div class="bar" style="position:relative">
            <div style="position:absolute;left:0;top:0;bottom:0;width:${w}%;background:linear-gradient(90deg,#60a5fa,#2563eb);border-radius:999px"></div>
          </div>
          <div class="small" style="min-width:60px;text-align:right">${fmtVal(d)}</div>
        </div>`;
      }).join('');
    }

    function renderPareto(svgEl,data,mode){
      svgEl.innerHTML='';
      const W=760,H=260,m={l:40,r:40,t:20,b:28}, w=W-m.l-m.r, h=H-m.t-m.b;
      const g=document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('transform', `translate(${m.l},${m.t})`); svgEl.appendChild(g);

      const vals=data.map(d=> mode==='freq'?d.count:d.dur);
      const total=vals.reduce((a,b)=>a+b,0)||1;
      const cum=[]; let s=0; vals.forEach(v=>{s+=v; cum.push(s/total);});
      const max=Math.max(...vals,1);

      const ax=document.createElementNS('http://www.w3.org/2000/svg','line');
      ax.setAttribute('x1',0); ax.setAttribute('y1',h); ax.setAttribute('x2',w); ax.setAttribute('y2',h);
      ax.setAttribute('stroke','#e5e7eb'); g.appendChild(ax);

      const step=w/Math.max(vals.length,1);
      vals.forEach((v,i)=>{
        const bh=(v/max)*h;
        const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x',i*step+10); rect.setAttribute('y',h-bh);
        rect.setAttribute('width',Math.max(18,step-20)); rect.setAttribute('height',bh);
        rect.setAttribute('fill','#93c5fd'); g.appendChild(rect);

        const tx=document.createElementNS('http://www.w3.org/2000/svg','text');
        tx.setAttribute('x',i*step+step/2); tx.setAttribute('y',h+16);
        tx.setAttribute('text-anchor','middle'); tx.setAttribute('font-size','10');
        tx.textContent=data[i].code; g.appendChild(tx);
      });

      const path=document.createElementNS('http://www.w3.org/2000/svg','path');
      let dPath=`M 0 ${h}`;
      cum.forEach((p,i)=>{ const x=i*step+step/2; const y=h-(p*h); dPath+=` L ${x} ${y}`; });
      path.setAttribute('d', dPath);
      path.setAttribute('fill','none'); path.setAttribute('stroke','#2563eb'); path.setAttribute('stroke-width','2'); g.appendChild(path);

      for(let i=0;i<=5;i++){
        const yy=h-(i*0.2*h);
        const t=document.createElementNS('http://www.w3.org/2000/svg','text');
        t.setAttribute('x',w+6); t.setAttribute('y',yy+4); t.setAttribute('font-size','10');
        t.textContent=(i*20)+'%'; g.appendChild(t);
      }
    }

            /* ==== Stats render & historik ============================================= */
    function computeStats(rows){
      const totalDur=rows.reduce((a,r)=>a+(r.durationMs||0),0);
      return {count:rows.length, dur:totalDur, avg: rows.length? Math.round(totalDur/rows.length):0};
    }

    function renderStats(){
      const rows=filteredEvents().filter(r=>r.end);
      const agg=aggregateByCause(rows);
      const k=computeStats(rows);
      els.kpiCount.textContent=String(k.count);
      els.kpiDur.textContent=fmtDur(k.dur);
      els.kpiAvg.textContent=fmtDur(k.avg);
      if(agg.length){
        els.kpiTop.textContent=agg[0].code;
        els.kpiTopSub.textContent=`Hyppigst: ${agg[0].count} stk`;
      } else {
        els.kpiTop.textContent='—'; els.kpiTopSub.textContent='Hyppigst: —';
      }
      renderDonut(els.pieFreq, agg, x=>x.count);
      renderLegend(els.legendFreq, agg, x=>`${x.count} stk`);
      renderDonut(els.pieDur, agg, x=>x.dur||0);
      renderLegend(els.legendDur, agg, x=>fmtShortDur(x.dur||0));
      renderBars(els.barsFreq, agg, x=>`${x.count} stk`, 'count');
      renderBars(els.barsDur, agg, x=>fmtDur(x.dur||0), 'dur');
      const mode = (els.paretoMode && els.paretoMode.value) || 'freq';
      renderPareto(els.pareto, agg, mode);
    }

    function renderTable(){
      const rows=loadEvents().sort((a,b)=>new Date(b.start)-new Date(a.start));
      els.tableBody.innerHTML = rows.map(ev=>`
        <tr>
          <td style="padding:8px;border-bottom:1px solid var(--divider)"><span class="muted">${fmtDate(ev.start)}</span></td>
          <td style="padding:8px;border-bottom:1px solid var(--divider)"><span class="muted">${ev.end?fmtDate(ev.end):'—'}</span></td>
          <td style="padding:8px;border-bottom:1px solid var(--divider)">${ev.durationMs?fmtDur(ev.durationMs):'—'}</td>
          <td style="padding:8px;border-bottom:1px solid var(--divider)">${ev.line||''}</td>
          <td style="padding:8px;border-bottom:1px solid var(--divider)">${ev.orderNo||''}</td>
          <td style="padding:8px;border-bottom:1px solid var(--divider)">${ev.itemNo||''}</td>
          <td style="padding:8px;border-bottom:1px solid var(--divider)"><span class="pill">${(ev.reason&&ev.reason.code)||''}</span> ${(ev.reason&&ev.reason.label)||''}</td>
          <td style="padding:8px;border-bottom:1px solid var(--divider)">${(ev.detailChips||[]).join(', ')} ${ev.other||''}</td>
          <td style="padding:8px;border-bottom:1px solid var(--divider)">${ev.comment||''}</td>
          <td style="padding:8px;border-bottom:1px solid var(--divider)">${ev.operator||''}</td>
          <td style="padding:8px;border-bottom:1px solid var(--divider);text-align:right">
            <button class="btn" data-action="edit" data-id="${ev.id}" type="button">Redigér</button>
            <button class="btn" data-action="delete" data-id="${ev.id}" type="button">Slet</button>
          </td>
        </tr>
      `).join('');

      els.countPosts.textContent=String(rows.length);
      const used=[STORAGE,SETTINGS,HANDOVER].reduce((a,k)=>a+bytesLen(localStorage.getItem(k)||''),0);
      const pct=Math.min(100,Math.round((used/(5*1024*1024))*100));
      els.usageTxt.textContent=`${pct}% (${Math.round(used/1024)} KB af 5120 KB)`;
      els.usageFill.style.width=pct+'%';

      renderActivity8h();
      renderLog8h();
      renderStats();
    }

    /* ==== Download/CSV & email subject ======================================== */
    const makeCsv=rows=>{
      const repl=s=>String(s||'').split(';').join(',');
      const clean=s=>String(s||'').replace(/\n/g,' ');
      const header=['id','start','slut','varighed_ms','varighed_hhmmss','linje','ordre','vare','kode','kode_label','uddybning','andet','kommentar','operatør'].join(';');
      const body=rows.map(r=>{
        const code=(r.reason&&r.reason.code)||'', label=(r.reason&&r.reason.label)||'';
        return [r.id,r.start,r.end,r.durationMs,fmtDur(r.durationMs||0),repl(r.line),repl(r.orderNo),repl(r.itemNo),code,label,repl((r.detailChips||[]).join('|')),repl(r.other),repl(clean(r.comment)),repl(r.operator)].join(';');
      });
      return header+'\n'+body.join('\n');
    };

    const download=(filename,text)=>{
      const blob=new Blob([text],{type:'text/plain;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url),500);
    };

    const defaultEmailSubject=()=>{
      const line=(els.line.value||''), ord=(els.orderNo.value||'');
      const d=new Date();
      const date = (d.toLocaleDateString? d.toLocaleDateString('da-DK') : `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`);
      return `Produktionsstop${line?` – ${line}`:''}${ord?` – Ordre ${ord}`:''} – ${date}`;
    };

            let EDIT_ID=null;

    function setActiveTab(which){
      [els.tabHandling,els.tabStats,els.tabHist,els.tabShare,els.tabSettings].forEach(t=>remClass(t,'active'));
      addClass(which,'active');
      [els.viewHandling,els.viewStats,els.viewHist,els.viewShare,els.viewSettings].forEach(hide);
      if(which===els.tabHandling) show(els.viewHandling);
      else if(which===els.tabStats) { show(els.viewStats); renderStats(); }
      else if(which===els.tabHist) show(els.viewHist);
      else if(which===els.tabShare) show(els.viewShare);
      else show(els.viewSettings);
    }

    function applyTheme(theme){
      if(theme==='dark'){ document.documentElement.setAttribute('data-theme','dark'); }
      else { document.documentElement.removeAttribute('data-theme'); }
    }
    function applyBrand(){
      const s=loadSettings();
      if(s.brandColor){ document.documentElement.style.setProperty('--brand', s.brandColor); }
      els.defTo.value=s.defaultTo||'vedligehold@pluspack.com';
      els.brandColor.value=s.brandColor||'#0a61ae';
      els.themeSelect.value=s.theme||'standard';
      if(s.line) els.line.value=s.line;
      els.operator.value=s.operator||'';
      els.orderNo.value=s.orderNo||'';
      els.itemNo.value=s.itemNo||'';
      applyTheme(s.theme||'standard');
    }

    function bindEvents(){
      // Tabs
      els.tabHandling.onclick=()=>setActiveTab(els.tabHandling);
      els.tabStats.onclick=()=>{ setActiveTab(els.tabStats); };
      els.tabHist.onclick=()=>setActiveTab(els.tabHist);
      els.tabShare.onclick=()=>setActiveTab(els.tabShare);
      els.tabSettings.onclick=()=>setActiveTab(els.tabSettings);

      // Filters
      if(els.shiftSelect) els.shiftSelect.onchange=renderStats;
      if(els.paretoMode) els.paretoMode.onchange=renderStats;

      // Inputs sync
      els.line.onchange=syncOrder; els.operator.oninput=syncOrder;
      els.orderNo.oninput=syncOrder; els.itemNo.oninput=syncOrder;
      els.btnClearOrder.onclick=()=>{ els.orderNo.value=''; els.itemNo.value=''; syncOrder(); };
      els.btnClearLine.onclick=()=>{ els.line.value=''; els.operator.value=''; syncOrder(); };

      // Stop/Start
      els.btnStop.onclick=()=>{ openOv('ov-stop'); els.stopValidation.textContent=''; renderReasonButtons(); };
      els.stopClose.onclick=()=>closeOv('ov-stop');
      els.stopCancel.onclick=()=>closeOv('ov-stop');

      const confirmStop = ()=>{
        if(!hasRequired()){ els.stopValidation.textContent='Udfyld Ordre nr. og Vare nr. før du bekræfter.'; return false; }
        const sel=document.querySelector('input[name="reasonRadio"]:checked');
        const reason=getReasonByCode(sel?sel.value:null)||{code:'ANDET',label:'Andet'};
        stopMeta={
          reason:{code:reason.code,label:reason.label},
          detailChips:selectedChips(),
          other:(els.other.value||'').trim(),
          comment:(els.comment.value||'').trim()
        };
        STOP_START_ISO=new Date().toISOString();
        setStatus(true);
        if(timer) clearInterval(timer);
        timer=setInterval(tick,1000);
        tick();
        closeOv('ov-stop');
        return true;
      };

      els.stopConfirm.onclick=()=>{
        if(confirmStop()){
          saveCurrentStop({ start: STOP_START_ISO, meta: stopMeta });
        }
      };

      els.btnStart.onclick=()=>{
        if(!IS_STOPPED) return;
        const end=new Date(), start=new Date(STOP_START_ISO), duration=end-start;
        const rows=loadEvents();
        rows.push({
          id:uuid(), start:start.toISOString(), end:end.toISOString(), durationMs:duration,
          line:els.line.value||'', operator:els.operator.value||'',
          orderNo:els.orderNo.value||'', itemNo:els.itemNo.value||'',
          reason:stopMeta?stopMeta.reason:null, detailChips:stopMeta?stopMeta.detailChips:[],
          other:stopMeta?stopMeta.other:'', comment:stopMeta?stopMeta.comment:''
        });
        saveEvents(rows);
        setStatus(false); STOP_START_ISO=null; stopMeta=null;
        if(timer){clearInterval(timer); timer=null;}
        renderTable();
        clearCurrentStop();
      };

      // Genveje
      document.addEventListener('keydown',ev=>{
        if(ev.ctrlKey && (ev.key==='s' || ev.key==='S')){ ev.preventDefault(); if(!IS_STOPPED) els.btnStop.click(); }
        if(ev.ctrlKey && (ev.key==='a' || ev.key==='A')){ ev.preventDefault(); if(IS_STOPPED) els.btnStart.click(); }
      });

      // Historik / edit
      els.tableBody.onclick=e=>{
        let t=e.target;
        while(t && t.tagName!=='BUTTON' && t!==els.tableBody){ t=t.parentNode; }
        if(!t||t===els.tableBody) return;
        const id=t.getAttribute('data-id'), act=t.getAttribute('data-action'), rows=loadEvents();
        if(act==='delete'){
          if(!confirm('Slet denne registrering?')) return;
          saveEvents(rows.filter(r=>r.id!==id)); renderTable(); return;
        }
        if(act==='edit'){
          const rows2=loadEvents(), ev=rows2.find(r=>r.id===id);
          if(!ev){ alert('Kunne ikke finde posten.'); return; }
          EDIT_ID=id;
          byId('edit-start').value=toLocalInputValue(ev.start);
          byId('edit-end').value=toLocalInputValue(ev.end);
          byId('edit-dur').value=fmtDur(ev.durationMs||0);
          byId('edit-line').value=ev.line||'';
          byId('edit-order').value=ev.orderNo||'';
          byId('edit-item').value=ev.itemNo||'';
          byId('edit-operator').value=ev.operator||'';
          byId('edit-code').value=(ev.reason&&ev.reason.code)||'';
          byId('edit-label').value=(ev.reason&&ev.reason.label)||'';
          byId('edit-chips').value=(ev.detailChips||[]).join(', ');
          byId('edit-other').value=ev.other||'';
          byId('edit-comment').value=ev.comment||'';
          byId('editValidation').textContent='';
          openOv('ov-edit');
        }
      };

      const recalcEditDur=()=>{
        const s=fromLocalInputValue(byId('edit-start').value), e=fromLocalInputValue(byId('edit-end').value);
        if(s&&e&&e>=s) byId('edit-dur').value=fmtDur(e-s);
      };
      byId('edit-start').onchange=recalcEditDur;
      byId('edit-end').onchange=recalcEditDur;
      byId('edit-close').onclick=()=>{ EDIT_ID=null; closeOv('ov-edit'); };
      byId('edit-cancel').onclick=()=>{ EDIT_ID=null; closeOv('ov-edit'); };
      byId('edit-save').onclick=()=>{
        if(!EDIT_ID) return;
        const rows=loadEvents(), idx=rows.findIndex(r=>r.id===EDIT_ID);
        const s=fromLocalInputValue(byId('edit-start').value), e=fromLocalInputValue(byId('edit-end').value);
        if(!s||!e||e<s){ byId('editValidation').textContent='Angiv gyldig start/slut (slut ≥ start).'; return; }
        const r=rows[idx];
        r.start=s.toISOString(); r.end=e.toISOString(); r.durationMs=e-s;
        r.line=byId('edit-line').value||''; r.orderNo=byId('edit-order').value||''; r.itemNo=byId('edit-item').value||'';
        r.reason={code:(byId('edit-code').value||'').trim().toUpperCase(), label:(byId('edit-label').value||'').trim()||(byId('edit-code').value||'').trim().toUpperCase()};
        r.detailChips=(byId('edit-chips').value||'').split(',').map(x=>x.trim()).filter(Boolean);
        r.other=byId('edit-other').value||''; r.comment=byId('edit-comment').value||''; r.operator=byId('edit-operator').value||'';
        saveEvents(rows); EDIT_ID=null; closeOv('ov-edit'); renderTable(); alert('Ændringer gemt.');
      };

      // Deling
      els.btnCsv.onclick=()=>download('produktionsstop.csv', makeCsv(loadEvents()));
      els.btnJson.onclick=()=>{
        const json=JSON.stringify(loadEvents(),null,2);
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(json).then(()=>alert('JSON kopieret')).catch(()=>prompt('Kopiér JSON:', json));
        } else { prompt('Kopiér JSON:', json); }
      };
      els.btnClearLog.onclick=()=>{ if(confirm('Slet hele loggen?')){ saveEvents([]); renderTable(); } };
      els.btnArchive.onclick=()=>{
        const rows=loadEvents(); if(!rows.length){ alert('Ingen data at arkivere.'); return; }
        const d=new Date(), y=d.getFullYear(), mo=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'), hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
        const name=`produktionsstop_${y}${mo}${da}_${hh}${mm}.csv`;
        download(name, makeCsv(rows));
        if(confirm('Log blev eksporteret. Vil du nulstille loggen nu?')){ saveEvents([]); renderTable(); }
      };

      // Email (share)
      els.btnEmail.onclick=()=>{
        const s=loadSettings();
        els.emailTo.value=s.defaultTo||'vedligehold@pluspack.com';
        els.emailCc.value='';
        els.emailSubj.value=defaultEmailSubject();
        els.emailBody.value='Se vedhæftede produktionsstop-log.';
        els.emailAttach.value='csv';
        openOv('ov-email');
      };
      els.emailClose.onclick=()=>closeOv('ov-email');
      els.emailCancel.onclick=()=>closeOv('ov-email');
      els.emailSend.onclick=()=>{
        const to=(els.emailTo.value||'').trim();
        if(!to){ alert('Angiv modtager'); return; }
        const attach=els.emailAttach.value;
        const rows=loadEvents();
        const filename=(attach==='csv')?'produktionsstop.csv':'produktionsstop.json';
        const content=(attach==='csv')?makeCsv(rows):JSON.stringify(rows,null,2);
        download(filename,content);
        const subj=(els.emailSubj.value||'');
        const body=(els.emailBody.value||'')+"\n\n(Husk at vedhæfte filen)";
        const cc=(els.emailCc.value||'');
        let href='mailto:'+encodeURIComponent(to)+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body);
        if(cc) href+='&cc='+encodeURIComponent(cc);
        window.location.href=href;
        closeOv('ov-email');
      };

      // Rep-seddel
      const openRep=()=>{
        const s=loadSettings();
        els.repTo.value=s.defaultTo||'vedligehold@pluspack.com';
        els.repCc.value=''; els.repType.value=''; els.repPri.value='Mellem';
        els.repSubj.value=`Reparationsseddel – ${els.line.value||'Linje ?'} – Ordre ${els.orderNo.value||'?'} / ${els.itemNo.value||'?'}`;
        els.repDesc.value='';
        openOv('ov-rep');
      };
      els.btnOpenRep.onclick=openRep;
      els.repClose.onclick=()=>closeOv('ov-rep');
      els.repDl.onclick=()=>download('rep_seddel.txt',
        `[Reparationsseddel]\nLinje: ${els.line.value||''}\nOrdre/Vare: ${els.orderNo.value||''} / ${els.itemNo.value||''}\nOperatør: ${els.operator.value||''}\nPrioritet: ${els.repPri.value||''}\nFejltype: ${els.repType.value||''}\nBeskrivelse:\n${els.repDesc.value||''}\n`
      );
      els.repSend.onclick=()=>{
        const to=(els.repTo.value||'').trim(); if(!to){ els.repValidation.textContent='Angiv modtager'; return; }
        const cc=(els.repCc.value||'').trim(), subj=(els.repSubj.value||'').trim();
        const body=`Linje: ${els.line.value||''}\nOrdre/Vare: ${els.orderNo.value||''} / ${els.itemNo.value||''}\nOperatør: ${els.operator.value||''}\nPrioritet: ${els.repPri.value||''}\nFejltype: ${els.repType.value||''}\n\n${els.repDesc.value||''}`;
        let href=`mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
        if(cc) href+=`&cc=${encodeURIComponent(cc)}`;
        window.location.href=href;
      };

      // Årsager – indstillinger
      function renderCustomList(){
        const s=loadSettings(), list=s.customCauses||[];
        if(!list.length){ byId('causeList').innerHTML='<p class="muted">Ingen brugerdefinerede årsager endnu.</p>'; return; }
        let html='<table style="width:100%;border-collapse:collapse"><thead><tr><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Kode</th><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Label</th><th style="text-align:left;padding:6px;border-bottom:1px solid #e5e7eb">Chips</th><th style="text-align:right;padding:6px;border-bottom:1px solid #e5e7eb">Handling</th></tr></thead><tbody>';
        for(const it of list){
          html+=`<tr><td style="padding:6px;border-bottom:1px solid #e5e7eb">${it.code}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb">${it.label}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb">${(it.chips||[]).join(', ')}</td><td style="padding:6px;border-bottom:1px solid #e5e7eb" class="right"><button class="btn" data-del="${it.code}">Slet</button></td></tr>`;
        }
        html+='</tbody></table>';
        byId('causeList').innerHTML=html;
        byId('causeList').querySelectorAll('button').forEach(btn=>{
          btn.onclick=function(){
            const code=this.getAttribute('data-del');
            const s=loadSettings(), arr=s.customCauses||[];
            s.customCauses=arr.filter(x=>x.code!==code);
            saveSettings(s); renderCustomList();
          };
        });
      }

      byId('btn-add-cause').onclick=function(){
        const code=(byId('causeCode').value||'').trim().toUpperCase();
        const label=(byId('causeLabel').value||'').trim();
        const raw=(byId('causeChips').value||'').split(','), chips=raw.map(t=>t.trim()).filter(Boolean);
        if(!code||!label){ alert('Udfyld både kode og label'); return; }
        const all=getAllReasons();
        if(all.some(r=>r.code.toUpperCase()===code)){ alert('Koden findes allerede. Vælg en anden.'); return; }
        const s=loadSettings(); if(!s.customCauses) s.customCauses=[];
        s.customCauses.push({code,label,chips}); saveSettings(s);
        byId('causeCode').value=''; byId('causeLabel').value=''; byId('causeChips').value='';
        renderCustomList(); alert('Årsag tilføjet');
      };
      byId('btn-reset-causes').onclick=function(){
        if(confirm('Nulstil egne årsager og statistik?')){
          const s=loadSettings(); s.customCauses=[]; saveSettings(s); renderCustomList(); alert('Årsager nulstillet.');
        }
      };

      // Gem indstillinger
      els.btnSaveSettings.onclick=()=>{
        const s=loadSettings();
        s.defaultTo=(els.defTo.value||'').trim();
        s.brandColor=(els.brandColor.value||'').trim()||'#0a61ae';
        s.theme=els.themeSelect.value||'standard';
        saveSettings(s); applyBrand(); renderStats(); alert('Indstillinger gemt.');
      };

      // Init liste
      (function initCauseList(){ // sikre visning
        const s=loadSettings(); if(!Array.isArray(s.customCauses)) s.customCauses=[];
        saveSettings(s);
        // definer renderCustomList i scope
        (typeof renderCustomList==='function') && renderCustomList();
      })();
    }
    /* ==== Init ================================================================ */
    function init(){
      try{
        migrateFromV1IfNeeded();
        setActiveTab(els.tabHandling);
        setStatus(false);
        applyBrand();
        renderTable();
        renderHandover();
        bindEvents();
        restoreHandoverDraft(); // gendan udkast
        bindDraftAutosave();    // autosave ved input

        // Genoptag aktivt stop fra CURRENT_STOP
        const cur = loadCurrentStop();
        if (cur && cur.start) {
          STOP_START_ISO = cur.start;
          stopMeta = cur.meta || null;
          setStatus(true);
          if (timer) clearInterval(timer);
          timer = setInterval(() => {
            if (IS_STOPPED && STOP_START_ISO) {
              const ms = Date.now() - new Date(STOP_START_ISO);
              els.liveTimer.textContent = fmtDur(ms);
            }
            renderActivity8h();
            renderLog8h();
          }, 1000);
        }

        // Handover knapper
        els.handoverSave.onclick=()=>{
          const txt=(els.handoverText.value||'').trim();
          if(!txt){ alert('Skriv en note.'); return; }
          const tag=(els.handoverTag.value||'').trim();
          const arr=loadHandover(); arr.unshift({ts:new Date().toISOString(), txt, tag});
          saveHandover(arr); clearDraft(); els.handoverText.value=''; els.handoverTag.value=''; renderHandover();
        };
        els.handoverClear.onclick=()=>{ els.handoverText.value=''; els.handoverTag.value=''; clearDraft(); };
      }catch(err){
        console.error(err);
        alert('JavaScript-fejl under init: '+err.message);
      }
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
  </div><!-- /.container -->
</body>
</html>
