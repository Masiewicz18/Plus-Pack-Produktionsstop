<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Plus Pack â€“ Produktionsstop v4</title>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;font-family:"Segoe UI",Arial,sans-serif;background:#f5f7fa;color:#0f172a}

/* --- StatusbjÃ¦lke --- */
#statusbar{
 position:fixed;top:0;left:0;right:0;height:48px;
 display:flex;align-items:center;justify-content:space-between;
 padding:0 16px;color:#fff;font-weight:700;
 background:#17833e;transition:background .3s;
 z-index:1000;
}
#statusText{font-size:15px;}
#timerBox{font:700 20px/1 ui-monospace,Consolas,monospace}

/* --- Layout --- */
.container{max-width:1100px;margin:64px auto 40px;padding:0 16px}
.card{
 background:#fff;border:1px solid #e2e8f0;border-radius:12px;
 box-shadow:0 4px 14px rgba(0,0,0,.05);padding:14px 18px;margin-bottom:14px;
}
h2{margin:0 0 10px;font-size:18px;color:#0a3a67}
label{display:block;font-size:12px;color:#555;margin-bottom:4px}
input,select,textarea{
 width:100%;padding:8px 10px;border:1px solid #cfd8e3;border-radius:8px;
 font-size:14px;background:#fff;
}
textarea{min-height:80px}
.row{display:flex;flex-wrap:wrap;gap:8px}
.field{flex:1 1 220px}
.btn{
 border:1px solid #cfd8e3;border-radius:10px;padding:9px 12px;
 background:#fff;cursor:pointer;font-weight:700;font-size:14px;
}
.btn-primary{background:#0a61ae;color:#fff;border-color:#0a61ae}
.btn-danger{background:#fef2f2;border-color:#fca5a5;color:#7f1d1d}
.btn-ok{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}

/* --- Chips / Ã¥rsager --- */
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{
 display:inline-flex;align-items:center;gap:6px;
 border:1px solid #cfd8e3;border-radius:999px;
 background:#f9fafb;padding:5px 10px;font-size:13px;cursor:pointer;
}
.chip input{width:16px;height:16px}
.chip:hover{background:#e6efff;border-color:#93c5fd}

/* --- Feed --- */
#feedList{list-style:none;margin:0;padding:0;max-height:280px;overflow-y:auto}
#feedList li{border-bottom:1px solid #e5e7eb;padding:8px 4px}
#feedList li:last-child{border-bottom:none}
.tag{
 display:inline-block;margin-right:6px;border-radius:999px;
 padding:3px 8px;font-size:12px;color:#fff;
}
.tag.stop{background:#dc2626}
.tag.rep{background:#f97316}
.tag.note{background:#3b82f6}
.hint{color:#64748b;font-size:12px}

/* --- Paneler --- */
.panel{display:none;margin-top:6px}
.panel .active{display:block}
</style>
</head>
<body>

<!-- StatusbjÃ¦lke -->
<div id="statusbar">
  <div id="statusText">KÃ¸rer normalt</div>
  <div id="timerBox">â€”:â€”:â€”</div>
</div>

<div class="container">

  <!-- Basisoplysninger -->
  <div class="card">
    <h2>Basisoplysninger</h2>
    <div class="row">
      <div class="field"><label>Linje</label><input id="line"></div>
      <div class="field"><label>Ordre nr.</label><input id="orderNo"></div>
      <div class="field"><label>Vare nr.</label><input id="itemNo"></div>
      <div class="field"><label>OperatÃ¸r</label><input id="operator"></div>
    </div>
  </div>

  <!-- Handling knapper -->
  <div class="card">
    <div class="row">
      <button id="btnNewStop" class="btn btn-danger" style="flex:1">RegistrÃ©r stop</button>
      <button id="btnNewRep" class="btn btn-primary" style="flex:1">Opret rep-seddel</button>
      <button id="btnNewNote" class="btn" style="flex:1">TilfÃ¸j note</button>
    </div>
  </div>

  <!-- STOP panel -->
  <div id="stopPanel" class="card panel">
    <h2>RegistrÃ©r stop</h2>
    <div class="row">
      <div class="field" style="flex:1 1 100%">
        <label>Ã…rsag</label>
        <div id="reasonList" class="chips"></div>
      </div>
    </div>
    <div id="detailList" class="chips" style="margin-top:6px"></div>
    <div class="row">
      <div class="field"><label>Andet</label><input id="other"></div>
      <div class="field"><label>Kommentar</label><input id="comment"></div>
    </div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button id="btn-cancel-stop" class="btn">Annuller</button>
      <button id="btn-confirm-stop" class="btn btn-danger">BekrÃ¦ft stop</button>
    </div>
  </div>

  <!-- REP panel -->
  <div id="repPanel" class="card panel">
    <h2>Opret rep-seddel</h2>
    <div class="row">
      <div class="field"><label>Prioritet</label><select id="rep-pri"><option>Lav</option><option>Mellem</option><option>HÃ¸j</option><option>Kritisk</option></select></div>
      <div class="field"><label>Fejltype</label><input id="rep-type" placeholder="fx mekanisk, el."></div>
    </div>
    <div class="field"><label>Beskrivelse</label><textarea id="rep-desc"></textarea></div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button id="btn-cancel-rep" class="btn">Annuller</button>
      <button id="btn-send-rep" class="btn btn-primary">Gem rep-seddel</button>
    </div>
  </div>

  <!-- NOTE panel -->
  <div id="notePanel" class="card panel">
    <h2>TilfÃ¸j note</h2>
    <div class="field"><textarea id="noteText" placeholder="Skriv kort note eller status"></textarea></div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button id="btn-cancel-note" class="btn">Annuller</button>
      <button id="btn-save-note" class="btn btn-ok">Gem note</button>
    </div>
  </div>

  <!-- Feed -->
  <div class="card">
    <h2>Aktivitet</h2>
    <ul id="feedList"></ul>
    <div class="hint">Farver: ðŸ”´ Stop  ðŸŸ  Rep-seddel  ðŸ”µ Note</div>
  </div>

</div>

 <script>
/* =======================
   Plus Pack â€“ v4 Core JS
   (Edge Legacy / Win10)
   ======================= */

/* ---- HjÃ¦lpere (ES5) ---- */
function $(id){return document.getElementById(id)}
function show(el){if(el) el.style.display=''}
function hide(el){if(el) el.style.display='none'}
function pad(n){return (n<10?'0':'')+n}
function fmtDur(ms){var s=Math.floor((ms||0)/1000),h=pad(Math.floor(s/3600)),m=pad(Math.floor((s%3600)/60)),ss=pad(s%60);return h+':'+m+':'+ss}
function fmtDate(d){var dt=(d instanceof Date)?d:new Date(d); try{return dt.toLocaleString('da-DK')}catch(e){return dt.toString()}}
function uuid(){return 'id-'+Date.now()+'-'+Math.floor(Math.random()*1e6)}
function saveJSON(k,v){localStorage.setItem(k, JSON.stringify(v))}
function loadJSON(k,def){try{var v=JSON.parse(localStorage.getItem(k)); return (v===null||v===undefined)?def:v}catch(e){return def}}
function postJSON(url,payload,cb){
  if(!url || url.indexOf('http')!==0){ if(cb) cb(false); return }
  try{
    var xhr=new XMLHttpRequest();
    xhr.open('POST', url, true);
    xhr.setRequestHeader('Content-Type','application/json;charset=UTF-8');
    xhr.onreadystatechange=function(){ if(xhr.readyState===4){ if(cb) cb(xhr.status>=200&&xhr.status<300) } };
    xhr.send(JSON.stringify(payload));
  }catch(e){ if(cb) cb(false) }
}

/* ---- Storage keys ---- */
var KEY_BASICS   = 'pp.v4.basics';
var KEY_FEED     = 'pp.v4.feed';
var KEY_STOPCUR  = 'pp.v4.currentStop';
var KEY_TEMPL    = 'pp.v4.stopTemplates';
var KEY_REPTEMPL = 'pp.v4.repTemplates';

/* ---- SharePoint / Flow (udskift disse med dine HTTP-triggers) ---- */
var ENDPOINT_EVENT='https://<din-flow-url>/event';
var ENDPOINT_REP  ='https://<din-flow-url>/rep';
var ENDPOINT_NOTE ='https://<din-flow-url>/note';

/* ---- UI refs ---- */
var els={
  statusbar:$('statusbar'), statusText:$('statusText'), timerBox:$('timerBox'),
  line:$('line'), orderNo:$('orderNo'), itemNo:$('itemNo'), operator:$('operator'),
  btnNewStop:$('btnNewStop'), btnNewRep:$('btnNewRep'), btnNewNote:$('btnNewNote'),
  stopPanel:$('stopPanel'), repPanel:$('repPanel'), notePanel:$('notePanel'),
  reasonList:$('reasonList'), detailList:$('detailList'),
  other:$('other'), comment:$('comment'),
  btnCancelStop:$('btn-cancel-stop'), btnConfirmStop:$('btn-confirm-stop'),
  repPri:$('rep-pri'), repType:$('rep-type'), repDesc:$('rep-desc'),
  btnCancelRep:$('btn-cancel-rep'), btnSendRep:$('btn-send-rep'),
  noteText:$('noteText'), btnCancelNote:$('btn-cancel-note'), btnSaveNote:$('btn-save-note'),
  feedList:$('feedList'),
  btnStart:$('btn-start') // fra DEL1 â€“ "Start"
};

/* ---- Ã…rsager (stabile farver) ---- */
var REASONS=[
  {code:'PRES', label:'Presse',   chips:['Rensning','SmÃ¸ring','OpsÃ¦tning'], color:'#b91c1c'},
  {code:'VAERK',label:'VÃ¦rktÃ¸j',  chips:['Skift','Slid','Defekt'],          color:'#7c3aed'},
  {code:'STAK', label:'Stakker',  chips:['Fejl','Opsamler','Andet'],        color:'#0ea5e9'},
  {code:'FOLIE',label:'Folie',    chips:['PÃ¥fyld','Bestilling'],            color:'#f59e0b'},
  {code:'ORDRE',label:'Ordre',    chips:['Afventer','Uklar ordre'],         color:'#16a34a'},
  {code:'ANDET',label:'Andet',    chips:['Sikkerhed','RengÃ¸ring'],          color:'#475569'}
];

/* ==== App state ==== */
var IS_STOPPED=false;
var STOP_START_ISO=null;
var STOP_META=null;
var TICKER=null;

/* ==== Basics persist ==== */
function readBasics(){
  var b=loadJSON(KEY_BASICS,{line:'',orderNo:'',itemNo:'',operator:''});
  els.line.value=b.line||''; els.orderNo.value=b.orderNo||'';
  els.itemNo.value=b.itemNo||''; els.operator.value=b.operator||'';
}
function saveBasics(){
  var b={line:els.line.value||'', orderNo:els.orderNo.value||'', itemNo:els.itemNo.value||'', operator:els.operator.value||''};
  saveJSON(KEY_BASICS,b);
}
function bindBasics(){
  var inputs=[els.line,els.orderNo,els.itemNo,els.operator];
  for(var i=0;i<inputs.length;i++){
    inputs[i].onchange=saveBasics; inputs[i].oninput=saveBasics;
  }
}

/* ==== Statusbar / timer ==== */
function setBar(mode){
  // mode: 'run' (grÃ¸n), 'stop' (rÃ¸d), 'rep' (orange)
  var bg='#17833e', txt='KÃ¸rer normalt';
  if(mode==='stop'){ bg='#b91c1c'; txt='Aktivt stop' }
  if(mode==='rep'){  bg='#c2410c'; txt='Rep-seddel oprettet' }
  els.statusbar.style.background=bg; els.statusText.innerHTML=txt;
}
function startTicker(){
  if(TICKER) clearInterval(TICKER);
  TICKER=setInterval(function(){
    if(IS_STOPPED && STOP_START_ISO){
      var ms=Date.now()-new Date(STOP_START_ISO).getTime();
      els.timerBox.innerHTML=fmtDur(ms);
      // autosave "current stop" hver 10s
      if(Math.floor(ms/1000)%10===0){ saveJSON(KEY_STOPCUR,{start:STOP_START_ISO,meta:STOP_META}) }
    }else{
      els.timerBox.innerHTML='â€”:â€”:â€”';
    }
  },1000);
}

/* ==== Feed ==== */
function getFeed(){ return loadJSON(KEY_FEED,[]) }
function setFeed(list){ saveJSON(KEY_FEED,list) }
function renderFeed(){
  var list=getFeed();
  var html='';
  for(var i=0;i<list.length;i++){
    var it=list[i];
    var tagCls='tag note';
    if(it.type==='stop') tagCls='tag stop';
    if(it.type==='rep')  tagCls='tag rep';
    var title=(it.type==='stop'?'Stop':(it.type==='rep'?'Rep-seddel':'Note'));
    var base=' [Linje: '+(it.line||'-')+', Ordre: '+(it.orderNo||'-')+', Vare: '+(it.itemNo||'-')+', OperatÃ¸r: '+(it.operator||'-')+']';
    var sub='';
    if(it.type==='stop'){
      var code=(it.reason&&it.reason.code)?it.reason.code:'?';
      var lab=(it.reason&&it.reason.label)?it.reason.label:'';
      sub=' â€” '+code+' Â· '+lab+' Â· '+fmtDur(it.durationMs||0);
      if(it.comment){ sub+=' Â· '+it.comment }
    }
    if(it.type==='rep'){
      sub=' â€” '+(it.priority||'Mellem')+', '+(it.faultType||'')+(it.description?(' Â· '+it.description):'');
    }
    if(it.type==='note'){
      sub=' â€” '+(it.text||'');
    }
    html+='<li><span class="'+tagCls+'">'+title+'</span>'+
          '<strong>'+fmtDate(it.ts)+'</strong> '+base+sub+
          '</li>';
  }
  els.feedList.innerHTML=html||'<li class="hint">Ingen poster endnu</li>';
}

/* ==== Ã…rsag & chips UI ==== */
function renderReasons(){
  var html=''; var i;
  for(i=0;i<REASONS.length;i++){
    var r=REASONS[i];
    html+= '<label class="chip" style="border-color:'+r.color+';background:#ffffff;">'
         + '<input type="radio" name="reasonRadio" value="'+r.code+'">'
         + '<b style="color:'+r.color+'">'+r.code+'</b> â€“ '+r.label
         + '</label>';
  }
  els.reasonList.innerHTML=html;
  // default vÃ¦lg fÃ¸rste
  var first=els.reasonList.querySelector('input[name="reasonRadio"]');
  if(first){ first.checked=true; renderChipsFor(first.value) }
  els.reasonList.onclick=function(e){
    var t=e.target||e.srcElement;
    if(t && t.name==='reasonRadio'){ renderChipsFor(t.value) }
  };
}
function findReason(code){
  for(var i=0;i<REASONS.length;i++){ if(REASONS[i].code===code) return REASONS[i] }
  return null;
}
function renderChipsFor(code){
  var r=findReason(code)||{chips:[]};
  var html=''; var i;
  for(i=0;i<r.chips.length;i++){
    html+='<label class="chip"><input type="checkbox" value="'+r.chips[i]+'">'+r.chips[i]+'</label>';
  }
  els.detailList.innerHTML=html;
}

/* ===== Templates (genbrug tidl. beskrivelser) ===== */
function getStopTemplates(){ return loadJSON(KEY_TEMPL,[]) }
function setStopTemplates(arr){ saveJSON(KEY_TEMPL,arr) }
function getRepTemplates(){ return loadJSON(KEY_REPTEMPL,[]) }
function setRepTemplates(arr){ saveJSON(KEY_REPTEMPL,arr) }

function captureCurrentStopForm(){
  var sel=document.querySelector('input[name="reasonRadio"]:checked');
  var r=findReason(sel?sel.value:null)||{code:'ANDET',label:'Andet'};
  // chips -> array
  var chips=[]; var boxes=els.detailList.getElementsByTagName('input');
  for(var i=0;i<boxes.length;i++){ if(boxes[i].checked) chips.push(boxes[i].value) }
  return {
    reason:{code:r.code,label:r.label},
    detailChips:chips,
    other:(els.other.value||''),
    comment:(els.comment.value||'')
  };
}
function applyStopTemplate(t){
  if(!t) return;
  // vÃ¦lg reason
  var radios=document.getElementsByName('reasonRadio'), i;
  for(i=0;i<radios.length;i++){
    if(radios[i].value===t.reason.code){ radios[i].checked=true; renderChipsFor(radios[i].value); }
  }
  // sÃ¦t chips
  var nodes=els.detailList.getElementsByTagName('input');
  for(i=0;i<nodes.length;i++){ nodes[i].checked=(t.detailChips.indexOf(nodes[i].value)>=0) }
  els.other.value=t.other||''; els.comment.value=t.comment||'';
}

/* Lille dropdown som JS indsÃ¦tter under kommentarfeltet (genbrug) */
function injectReuseRow(){
  var row=document.createElement('div'); row.className='row'; row.style.marginTop='6px';
  var wrap=document.createElement('div'); wrap.className='field'; wrap.style.flex='1 1 320px';
  var label=document.createElement('label'); label.innerHTML='Genbrug fra tidligere';
  var sel=document.createElement('select'); sel.id='reuseStop';
  wrap.appendChild(label); wrap.appendChild(sel); row.appendChild(wrap);
  els.stopPanel.appendChild(row);

  refreshReuseSelect();

  sel.onchange=function(){
    var id=this.value; if(!id) return;
    var list=getStopTemplates(); var i, t=null;
    for(i=0;i<list.length;i++){ if(list[i].id===id){ t=list[i]; break } }
    applyStopTemplate(t);
  };

  // ogsÃ¥ en "Gem som skabelon" knap
  var wrap2=document.createElement('div'); wrap2.className='field'; wrap2.style.flex='0 0 200px';
  var lbl2=document.createElement('label'); lbl2.innerHTML='&nbsp;';
  var btn=document.createElement('button'); btn.className='btn'; btn.type='button'; btn.innerHTML='Gem som skabelon';
  wrap2.appendChild(lbl2); wrap2.appendChild(btn); row.appendChild(wrap2);
  btn.onclick=function(){
    var name=prompt('Navn pÃ¥ skabelon?'); if(!name) return;
    var t=captureCurrentStopForm(); t.id=uuid(); t.name=name;
    var arr=getStopTemplates(); arr.unshift(t); setStopTemplates(arr); refreshReuseSelect(); alert('Skabelon gemt.');
  };

  function refreshReuseSelect(){
    var last=getFeed().filter(function(x){return x.type==='stop'}).slice(0,10);
    var templ=getStopTemplates();
    var html='<option value="">â€” VÃ¦lg tidligere/skrabelon â€”</option>';
    // seneste 10 stops giver "engangsskabeloner"
    for(var i=0;i<last.length;i++){
      var it=last[i]; var code=(it.reason&&it.reason.code)||'?';
      html+='<option value="'+(it.id||('last-'+i))+'" data-kind="last">'+code+' Â· '+(it.comment||'-')+'</option>';
    }
    // faste skabeloner
    for(var j=0;j<templ.length;j++){
      html+='<option value="'+templ[j].id+'">'+templ[j].name+'</option>';
    }
    sel.innerHTML=html;

    // map engangsvalg -> temporary template objekt
    sel.onchange=function(){
      var v=sel.value; if(!v) return;
      // er det en "last" post?
      if(v.indexOf('last-')===0){
        var idx=parseInt(v.split('-')[1],10);
        var ev=last[idx];
        if(ev){
          var temp={ reason: ev.reason || {code:'ANDET',label:'Andet'},
                     detailChips: ev.detailChips||[],
                     other: ev.other||'',
                     comment: ev.comment||'' };
          applyStopTemplate(temp);
        }
      }else{
        // rigtig skabelon
        var list=getStopTemplates(), k, t=null;
        for(k=0;k<list.length;k++){ if(list[k].id===v){ t=list[k]; break } }
        applyStopTemplate(t);
      }
    };
  }
}

/* ==== STOP flow ==== */
function openStopPanel(){
  hide(els.repPanel); hide(els.notePanel); show(els.stopPanel);
}
function closeStopPanel(){ hide(els.stopPanel) }

function confirmStop(){
  // krÃ¦ver basisfelter (ordre + vare)
  if(!(els.orderNo.value||'').trim() || !(els.itemNo.value||'').trim()){
    alert('Udfyld Ordre nr. og Vare nr. fÃ¸r du registrerer stoppet.');
    return;
  }
  var sel=document.querySelector('input[name="reasonRadio"]:checked');
  var r=findReason(sel?sel.value:null)||{code:'ANDET',label:'Andet'};
  var chips=[], boxes=els.detailList.getElementsByTagName('input');
  for(var i=0;i<boxes.length;i++){ if(boxes[i].checked) chips.push(boxes[i].value) }

  STOP_META={
    reason:{code:r.code,label:r.label},
    detailChips:chips,
    other:(els.other.value||''),
    comment:(els.comment.value||'')
  };
  STOP_START_ISO=new Date().toISOString();
  IS_STOPPED=true;
  setBar('stop');
  saveJSON(KEY_STOPCUR,{start:STOP_START_ISO,meta:STOP_META}); // sikrer genoptag ved refresh
  startTicker();
  closeStopPanel();

  // Vis i feed (midlertidig "startet stop"-post)
  // Den endelige registrering skabes ved "Start"-knappen senere.
}

function endStopAndSave(){
  if(!IS_STOPPED || !STOP_START_ISO){ return }
  var end=new Date();
  var start=new Date(STOP_START_ISO);
  var dur=end-start;

  // Endelig POST
  var row={
    id:uuid(),
    ts:new Date().toISOString(),
    type:'stop',
    start: start.toISOString(),
    end:   end.toISOString(),
    durationMs: dur,
    line: els.line.value||'',
    orderNo: els.orderNo.value||'',
    itemNo: els.itemNo.value||'',
    operator: els.operator.value||'',
    reason: STOP_META?STOP_META.reason:null,
    detailChips: STOP_META?STOP_META.detailChips:[],
    other: STOP_META?STOP_META.other:'',
    comment: STOP_META?STOP_META.comment:''
  };

  // til SharePoint
  var payloadEvent={
    id:row.id, start:row.start, end:row.end, duration_ms:row.durationMs,
    line:row.line, order:row.orderNo, item:row.itemNo, operator:row.operator,
    cause_code:(row.reason&&row.reason.code)||'', cause_label:(row.reason&&row.reason.label)||'',
    details:(row.detailChips||[]).join(', '), other:row.other||'', comment:row.comment||''
  };
  postJSON(ENDPOINT_EVENT, payloadEvent, function(){});

  // til feed
  var feed=getFeed(); feed.unshift(row); setFeed(feed);
  renderFeed();

  // reset status
  IS_STOPPED=false; STOP_START_ISO=null; STOP_META=null;
  saveJSON(KEY_STOPCUR,null);
  setBar('run'); startTicker();
}

/* ==== REP flow ==== */
function openRep(){ hide(els.stopPanel); hide(els.notePanel); show(els.repPanel) }
function closeRep(){ hide(els.repPanel) }
function saveRep(){
  var row={
    id:uuid(),
    ts:new Date().toISOString(),
    type:'rep',
    line: els.line.value||'',
    orderNo: els.orderNo.value||'',
    itemNo: els.itemNo.value||'',
    operator: els.operator.value||'',
    priority: els.repPri.value||'Mellem',
    faultType: els.repType.value||'',
    description: els.repDesc.value||''
  };
  // POST til SharePoint
  postJSON(ENDPOINT_REP, {
    related_event_id: null, // kan evt. udfyldes, hvis I binder til sidste stop
    line:row.line, order:row.orderNo, item:row.itemNo, operator:row.operator,
    priority:row.priority, type:row.faultType, description:row.description
  }, function(){});

  var feed=getFeed(); feed.unshift(row); setFeed(feed);
  renderFeed(); setBar('rep');
  // gem som rep-skabelon (hurtig genbrug) hvis Ã¸nsket
  var templ=getRepTemplates(); // (ikke UI nu; men persist for evt. senere)
  templ.unshift({id:row.id, priority:row.priority, faultType:row.faultType, description:row.description});
  setRepTemplates(templ);

  els.repType.value=''; els.repDesc.value='';
  closeRep(); setTimeout(function(){ setBar('run'); }, 1200);
}

/* ==== NOTES ==== */
function openNote(){ hide(els.stopPanel); hide(els.repPanel); show(els.notePanel) }
function closeNote(){ hide(els.notePanel) }
function saveNote(){
  var txt=(els.noteText.value||'').trim(); if(!txt){ alert('Skriv en note.'); return }
  var row={
    id:uuid(),
    ts:new Date().toISOString(),
    type:'note',
    line: els.line.value||'',
    orderNo: els.orderNo.value||'',
    itemNo: els.itemNo.value||'',
    operator: els.operator.value||'',
    text: txt
  };
  postJSON(ENDPOINT_NOTE, row, function(){});
  var feed=getFeed(); feed.unshift(row); setFeed(feed);
  renderFeed();
  els.noteText.value=''; closeNote();
}

/* ==== Init ==== */
window.addEventListener('DOMContentLoaded', function(){
  // basics
  readBasics(); bindBasics();

  // panels starter skjult
  hide(els.stopPanel); hide(els.repPanel); hide(els.notePanel);

  // feed
  renderFeed();

  // reasons + chips + genbrug-dropdown
  renderReasons();
  injectReuseRow();

  // knapper
  els.btnNewStop.onclick=openStopPanel;
  els.btnNewRep.onclick=openRep;
  els.btnNewNote.onclick=openNote;

  els.btnCancelStop.onclick=closeStopPanel;
  els.btnConfirmStop.onclick=confirmStop;

  els.btnCancelRep.onclick=closeRep;
  els.btnSendRep.onclick=saveRep;

  els.btnCancelNote.onclick=closeNote;
  els.btnSaveNote.onclick=saveNote;

  // "Start" afslutter et aktivt stop og gemmer posten
  els.btnStart.onclick=endStopAndSave;

  // genoptag aktivt stop efter refresh
  var cur=loadJSON(KEY_STOPCUR,null);
  if(cur && cur.start){
    STOP_START_ISO=cur.start; STOP_META=cur.meta||null; IS_STOPPED=true; setBar('stop');
  }else{
    setBar('run');
  }
  startTicker();

  // fail-safe autosave af aktuel stop-status hver 10 sek i ticker
});
</script>
/* ======== Power Automate / SharePoint integration ======== */
/*
   Disse tre endpoints skal pege pÃ¥ dine
   HTTP-triggerede Power Automate-flows.
   Ã‰t flow for hver type: Stop, Rep, Note.
*/
var ENDPOINT_EVENT = "https://<din-flow-url>/event";
var ENDPOINT_REP   = "https://<din-flow-url>/rep";
var ENDPOINT_NOTE  = "https://<din-flow-url>/note";

/* ======== Afsendelse via XHR (Edge-kompatibel) ======== */
function safeSend(url,payload,label){
  try{
    var xhr=new XMLHttpRequest();
    xhr.open("POST",url,true);
    xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8");
    xhr.onreadystatechange=function(){
      if(xhr.readyState===4){
        if(xhr.status>=200&&xhr.status<300){
          console.log(label+" sendt âœ…");
        }else{
          console.log(label+" fejl âŒ",xhr.status);
        }
      }
    };
    xhr.send(JSON.stringify(payload));
  }catch(e){console.log(label+" fejl",e);}
}

/* ======== Automatisk resending (offline â†’ online) ======== */
function resendQueued(){
  var feed=loadJSON(KEY_FEED,[]);
  var unsent=[];
  for(var i=0;i<feed.length;i++){
    var r=feed[i];
    if(r.sent){continue;}
    var payload={};
    if(r.type==="stop"){
      payload={
        id:r.id,start:r.start,end:r.end,duration_ms:r.durationMs,
        line:r.line,order:r.orderNo,item:r.itemNo,operator:r.operator,
        cause_code:(r.reason&&r.reason.code)||"",cause_label:(r.reason&&r.reason.label)||"",
        details:(r.detailChips||[]).join(", "),other:r.other||"",comment:r.comment||""
      };
      safeSend(ENDPOINT_EVENT,payload,"STOP");
    }
    if(r.type==="rep"){
      payload={
        id:r.id,line:r.line,order:r.orderNo,item:r.itemNo,operator:r.operator,
        priority:r.priority,type:r.faultType,description:r.description
      };
      safeSend(ENDPOINT_REP,payload,"REP");
    }
    if(r.type==="note"){
      payload={
        id:r.id,line:r.line,order:r.orderNo,item:r.itemNo,operator:r.operator,
        text:r.text
      };
      safeSend(ENDPOINT_NOTE,payload,"NOTE");
    }
    r.sent=true; unsent.push(r);
  }
  saveJSON(KEY_FEED,feed);
}

/* Resender alt hver 5. min og ved opstart */
window.addEventListener("DOMContentLoaded",function(){
  resendQueued();
  setInterval(resendQueued,5*60*1000);
});

