<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Plus Pack – Produktionsstop (Kompakt, Edge-kompatibel)</title>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;font-family:Segoe UI,Arial,Helvetica,sans-serif;background:#f4f6f9;color:#0f172a}

/* top statusbar */
.topbar{background:#0a61ae;color:#fff;padding:8px 12px;font-weight:800}
.statuspill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.35);
border-radius:999px;padding:4px 10px;background:rgba(255,255,255,.08)}
.dot{width:10px;height:10px;border-radius:999px;background:#17833e}
.dot.stop{background:#dc2626}

  .container{max-width:1180px;margin:0 auto;padding:12px}
.card{background:#fff;border:1px solid #e6ecf3;border-radius:12px;
box-shadow:0 6px 20px rgba(15,23,42,.06);padding:12px;margin-bottom:10px}
h3{margin:0 0 6px}
label{font-size:11px;color:#6b7280;display:block;margin-bottom:3px}
input,select,textarea{width:100%;border:1px solid #dfe7f2;border-radius:10px;
padding:8px 10px;background:#fff;font-size:14px}
textarea{min-height:72px}
.row{display:flex;flex-wrap:wrap;gap:8px}
.sm .field{flex:1 1 220px}
.field{margin-bottom:8px}
.hint{font-size:12px;color:#6b7280}
.sep{height:1px;background:#e6ecf3;margin:8px 0}

/* knapper */
.btn{border:1px solid #dbe4ef;background:#fff;border-radius:10px;padding:10px 12px;
font-weight:800;cursor:pointer;font-size:14px}
.btn:disabled{opacity:.55;cursor:not-allowed}
.btn-primary{background:#e8f1ff;border-color:#cfe2ff;color:#0a3d91}
.btn-danger{background:#fff1f1;border-color:#f3b3b3;color:#7f1d1d}
.btn-success{background:#ebfff2;border-color:#b7e6c7;color:#0b5a3c}
.timer{font:700 34px/1.1 ui-monospace,Consolas,monospace}
.timer small{display:block;font:600 11px/1 Segoe UI,Arial;color:#6b7280;margin-bottom:3px}

/* chips/valg */
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #dbe4ef;
background:#f5f9ff;border-radius:999px;padding:6px 8px;font-size:13px;cursor:pointer}
.chip input{width:16px;height:16px}

/* aktivitet */
.activity{width:100%;height:120px}
.activity .gridline{stroke:#e5e7eb;stroke-width:1}
.activity .gridline.sub{opacity:.5}
.activity .now{stroke:#0a61ae;stroke-width:2}
.activity .runbg{fill:rgba(16,185,129,.06)}
.activity .label{fill:#475569;font-size:10px}
.activity .stop{fill:rgba(220,38,38,.28);stroke:#dc2626;stroke-width:1}
.loglist{list-style:none;margin:0;padding:0;border:1px dashed #dbe4ef;border-radius:10px;
background:#fff;max-height:260px;overflow:auto}
.logitem{display:flex;gap:8px;padding:8px;border-bottom:1px solid #eef2f7}
.logitem:last-child{border-bottom:0}
.log-ts{min-width:130px;color:#6b7280;font-size:12px}
.badge{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;
border:1px solid #e2e8f0;background:#f8fafc}
.badge.stop{background:#ffe4e6;border-color:#fecdd3;color:#7f1d1d}
.badge.rep{background:#ede9fe;border-color:#ddd6fe;color:#4c1d95}
.badge.note{background:#dbeafe;border-color:#bfdbfe;color:#1e3a8a}

.legend{display:flex;gap:10px;flex-wrap:wrap}
.legend .dotl{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
.l-stop{background:#ef4444}.l-rep{background:#8b5cf6}.l-note{background:#3b82f6}
@media(max-width:900px){.row{display:block}}
</style>
</head>
<body>
<div class="topbar"><span class="statuspill"><span id="dot" class="dot"></span><span id="statxt">Kører normalt</span></span></div>
<div class="container">
<div class="card sm">
<h3>Basisoplysninger</h3>
<div class="row">
<div class="field"><label>Linje / maskine</label>
<select id="line">
<option value="">— Vælg —</option>
<option>L10 75 t Rhodes special presse</option>
<option>L11 Mech RF135 serie nr 18-11 Mnr888</option>
<option>L13 Press Beutler PD 40</option>
<option>L14 50 t Flexo C50 S20 presse</option>
<option>L15 30 t Flexo C30 S15 presse</option>
<option>L16 40 t Schuler PNH 40/250 presse</option>
<option>L17 30 t Flexo C30 S15 presse</option>
<option>L20 50 t Bliss 50F MKII presse</option>
<option>L22 50 t Bliss 50F MKII presse</option>
<option>L23 45 t Bliss 21½ presse</option>
<option>L24 30 t Flexo C30 S15</option>
<option>L25 30 t Flexo C30 X presse</option>
<option>L26 L 36 30 t Flexo C30 S 15 presse</option>
<option>L27 45 t Bliss 21½ presse</option>
<option>L28 50 t Flexo presse</option>
<option>L29 30 t Flexo C30 presse</option>
<option>L30 ny presse 2012</option>
<option>L33 50 t Bliss 50F MKII presse</option>
<option>L34 50 t Bliss 50F MKII presse</option>
<option>L35 30 t Flexo C30 S15 presse</option>
<option>L36 30 t Flexo C30 S15 presse Picop</option>
<option>L40 50 t Flexo C50 S20 presse</option>
<option>L41 L37, 50 t Bliss 50F MKII presse</option>
<option>L42 Press Beutler PD 40 alu spez638</option>
<option>L43 Press Beutler PD 40 alu spez637</option>
<option>L80 Choko-kapsler</option>
<option>L81 Lys-manchetter</option>
<option>L82 Lys-manchetter</option>
</select></div>
<div class="field"><label>Ordre nr. (krævet)</label><input id="orderNo" type="text"></div>
<div class="field"><label>Vare nr. (krævet)</label><input id="itemNo" type="text"></div>
<div class="field"><label>Operatør (valgfri)</label><input id="operator" type="text" placeholder="Navn/initialer"></div>
<div class="field"><label>&nbsp;</label><button id="btn-clear-order" class="btn">Ryd ordre/varenr</button></div>
<div class="field"><label>&nbsp;</label><button id="btn-clear-line" class="btn">Ryd linje/navn</button></div>
</div>
<div class="hint">Felter huskes i denne browser (selv efter refresh) indtil du rydder dem.</div>
</div>
<!-- Registrér stop (åbnes når man vil registrere) -->
<div class="card" id="stopPanel" style="display:none">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h3>Registrér stop</h3>
    <div id="stopHint" class="hint">Udfyld Ordre nr. og Vare nr., vælg årsag og bekræft.</div>
  </div>
  <div class="sep"></div>
  <div class="row">
    <div class="field" style="flex:1 1 320px">
      <label>Hurtig udfyldning – seneste 10</label>
      <select id="quick-last">
        <option value="">— Vælg tidligere registrering —</option>
      </select>
    </div>
    <div class="field" style="flex:1 1 320px">
      <label>Skabeloner (egne favoritter)</label>
      <div class="row" style="gap:6px">
        <select id="tpl-select" style="flex:1">
          <option value="">— Vælg skabelon —</option>
        </select>
        <button id="tpl-save" class="btn">Gem</button>
        <button id="tpl-del" class="btn">Slet</button>
      </div>
    </div>
  </div>
<div class="sep"></div>
<div class="row sm">
  <div class="field" style="flex:1 1 360px">
    <label>Årsag</label>
    <div id="reasonTop" class="chips"></div>
    <div id="reasonMore" class="chips" style="margin-top:6px"></div>
  </div>
  <div class="field" style="flex:1 1 360px">
    <label>Uddybning</label>
    <div id="reasonChips" class="chips"></div>
    <div class="row" style="gap:6px;margin-top:6px">
      <button id="btn-copy-last" class="btn" style="display:none">Kopier sidste</button>
      <button id="btn-clear-detail" class="btn">Ryd felter</button>
    </div>
  </div>
</div>
<div class="row sm">
  <div class="field"><label>Andet</label><input id="other" type="text"></div>
  <div class="field"><label>Kommentar</label><input id="comment" type="text"></div>
</div>

<div class="sep"></div>
<div class="row sm">
  <div class="field" style="flex:1 1 240px">
    <label>Rep-seddel</label>
    <select id="rep-mode">
      <option value="none">Ingen rep-seddel</option>
      <option value="create">Opret rep-seddel</option>
    </select>
  </div>
</div>
<div id="rep-fields" style="display:none">
  <div class="row sm">
    <div class="field"><label>Modtager</label><input id="rep-to" type="email" placeholder="vedligehold@pluspack.com"></div>
    <div class="field"><label>CC</label><input id="rep-cc" type="text" placeholder="valgfri"></div>
    <div class="field"><label>Prioritet</label><select id="rep-pri"><option>Lav</option><option>Mellem</option><option>Høj</option><option>Kritisk</option></select></div>
    <div class="field"><label>Fejltype</label><input id="rep-type" type="text" placeholder="fx Mekanisk / El"></div>
  </div>
  <div class="field"><label>Beskrivelse</label><textarea id="rep-desc" placeholder="Kort og præcis beskrivelse"></textarea></div>
</div>
<div class="row" style="justify-content:flex-end;gap:8px">
  <button id="stop-cancel" class="btn">Annuller</button>
  <button id="stop-confirm" class="btn btn-danger">Bekræft stop</button>
</div>
</div>
<div class="card">
  <div class="row" style="align-items:center;gap:10px">
    <div class="timer" style="min-width:160px">
      <small>Aktuelt stop</small><span id="liveTimer">—</span>
    </div>
    <div class="row" style="gap:8px">
      <button id="btn-open-stop" class="btn btn-primary">Registrér stop</button>
      <button id="btn-open-rep" class="btn">Opret rep-seddel</button>
      <button id="btn-add-note" class="btn">Tilføj note</button>
    </div>
    <div style="margin-left:auto">
      <button id="btn-start" class="btn btn-success" disabled>Start (afslut stop)</button>
    </div>
  </div>
</div>
<div class="row" style="gap:10px">
  <div class="card" style="flex:1">
    <h3>Aktivitet – sidste 8 timer</h3>
    <svg class="activity" id="activity8h" viewBox="0 0 920 120"></svg>
    <div class="hint">Røde felter = registrerede stop. Højre kant = “nu”.</div>
  </div>
  <div class="card" style="flex:1">
    <h3>Registreringer</h3>
    <div class="legend" style="margin:4px 0 8px">
      <span><span class="dotl l-stop"></span>Stop</span>
      <span><span class="dotl l-rep"></span>Rep-seddel</span>
      <span><span class="dotl l-note"></span>Note</span>
    </div>
    <ul id="mixList" class="loglist"></ul>
  </div>
</div>
</div><!-- /container -->
<script>
function $(id){return document.getElementById(id)}
function show(e){if(e)e.style.display=''}
function hide(e){if(e)e.style.display='none'}
function pad(n){return (n<10?'0':'')+n}
function fmtDate(d){var t=(d instanceof Date)?d:new Date(d);return t.toLocaleString('da-DK')}
function fmtDur(ms){var s=Math.floor(ms/1000),h=pad(Math.floor(s/3600)),m=pad(Math.floor((s%3600)/60)),ss=pad(s%60);return h+':'+m+':'+ss}
function uuid(){return 'id-'+Date.now()+'-'+Math.floor(Math.random()*1e6)}
function loadJSON(k,def){try{return JSON.parse(localStorage.getItem(k))||def}catch(e){return def}}
function saveJSON(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}
var KEY_EVENTS='produktionsstop.events.v2';
var KEY_SETTINGS='produktionsstop.settings.v2';
var KEY_CURRENT='produktionsstop.current.v1';
var KEY_TEMPLATES='produktionsstop.templates.v1';
var KEY_NOTES='produktionsstop.notes.v1';
var KEY_FEED='produktionsstop.feed.v1';
var DEFAULT_REASONS=[
 {code:'PRES',label:'Presse',chips:['Rensning','Smøring','Opsætning']},
 {code:'VAERK',label:'Værktøj',chips:['Skift','Slid','Defekt']},
 {code:'STAK',label:'Stakker',chips:['Fejl','Opsamler','Andet']},
 {code:'FOLIE',label:'Manglende folie',chips:['Påfyld','Bestilling']},
 {code:'ORDRE',label:'Manglende ordre',chips:['Afventer','Uklar ordre']},
 {code:'ANDET',label:'Andet',chips:['Sikkerhed','Rengøring']}
];
var IS_STOPPED=false, STOP_START_ISO=null, stopMeta=null, TICK=null;
function setStatus(st){
 IS_STOPPED=st;
 $('btn-start').disabled=!st;
 $('dot').className=st?'dot stop':'dot';
 $('statxt').innerHTML=st?'Stop aktivt':'Kører normalt';
 $('liveTimer').innerHTML=st?'00:00:00':'—';
}
function tick(){
 if(!IS_STOPPED)return;
 var ms=Date.now()-new Date(STOP_START_ISO);
 $('liveTimer').innerHTML=fmtDur(ms);
 renderActivity();renderMixList();
}
function renderReasons(){
 var list=DEFAULT_REASONS,i,html='';
 for(i=0;i<list.length;i++){
  html+='<label class="chip"><input type="radio" name="reasonRadio" value="'+list[i].code+'"><b>'+list[i].code+'</b> – '+list[i].label+'</label>';
 }
 $('reasonTop').innerHTML=html;
 var inputs=document.getElementsByName('reasonRadio');
 for(i=0;i<inputs.length;i++){
  inputs[i].onclick=function(){
   var r=DEFAULT_REASONS.filter(function(x){return x.code===this.value}.bind(this))[0];
   var html2='';
   for(var j=0;j<(r?r.chips.length:0);j++){
    html2+='<label class="chip"><input type="checkbox" value="'+r.chips[j]+'">'+r.chips[j]+'</label>';
   }
   $('reasonChips').innerHTML=html2;
  };
 }
}
function captureStopForm(){
 var sel=document.querySelector('input[name="reasonRadio"]:checked');
 var r=DEFAULT_REASONS.filter(function(x){return x.code==(sel?sel.value:'')})[0]||{code:'ANDET',label:'Andet'};
 var chips=[],nodes=$('reasonChips').getElementsByTagName('input');
 for(var i=0;i<nodes.length;i++){if(nodes[i].checked)chips.push(nodes[i].value)}
 return {reason:r,detailChips:chips,other:$('other').value||'',comment:$('comment').value||''};
}

function restoreBasics(){
 var s=loadJSON(KEY_SETTINGS,{});
 if(s.line)$('line').value=s.line;
 if(s.orderNo)$('orderNo').value=s.orderNo;
 if(s.itemNo)$('itemNo').value=s.itemNo;
 if(s.operator)$('operator').value=s.operator;
}
function syncBasics(){
 var s={line:$('line').value,orderNo:$('orderNo').value,itemNo:$('itemNo').value,operator:$('operator').value};
 saveJSON(KEY_SETTINGS,s);
}
function startStop(){
 var meta=captureStopForm();
 STOP_START_ISO=new Date().toISOString();
 stopMeta=meta;
 setStatus(true);
 saveJSON(KEY_CURRENT,{start:STOP_START_ISO,meta:stopMeta});
 if(TICK)clearInterval(TICK);TICK=setInterval(tick,1000);tick();
 hide($('stopPanel'));
}
function endStop(){
 if(!IS_STOPPED)return;
 var end=new Date(),start=new Date(STOP_START_ISO),dur=end-start;
 var row={id:uuid(),start:start.toISOString(),end:end.toISOString(),durationMs:dur,
 line:$('line').value,orderNo:$('orderNo').value,itemNo:$('itemNo').value,operator:$('operator').value,
 reason:stopMeta.reason,detailChips:stopMeta.detailChips,other:stopMeta.other,comment:stopMeta.comment};
 var ev=loadJSON(KEY_EVENTS,[]);ev.push(row);saveJSON(KEY_EVENTS,ev);
 var feed=loadJSON(KEY_FEED,[]);
 feed.push({type:'stop',sent:false,id:row.id,start:row.start,end:row.end,durationMs:row.durationMs,
 line:row.line,orderNo:row.orderNo,itemNo:row.itemNo,operator:row.operator,
 reason:row.reason,detailChips:row.detailChips,other:row.other,comment:row.comment});
 saveJSON(KEY_FEED,feed);
 STOP_START_ISO=null;stopMeta=null;setStatus(false);
 clearInterval(TICK);TICK=null;localStorage.removeItem(KEY_CURRENT);
 renderActivity();renderMixList();
}
function renderActivity(){
 var svg=$('activity8h');if(!svg)return;svg.innerHTML='';
 var W=920,H=120,m={l:40,r:10,t:18,b:18},w=W-m.l-m.r,h=H-m.t-m.b;
 var now=new Date(),start=new Date(now.getTime()-8*3600*1000);
 function xPos(t){return m.l+Math.max(0,Math.min(w,((t-start)/(8*3600*1000))*w))}
 var bg=document.createElementNS('http://www.w3.org/2000/svg','rect');
 bg.setAttribute('x',m.l);bg.setAttribute('y',m.t);bg.setAttribute('width',w);bg.setAttribute('height',h);
 bg.setAttribute('class','runbg');svg.appendChild(bg);
 var rows=loadJSON(KEY_EVENTS,[]),nowt=now.getTime();
 for(var i=0;i<rows.length;i++){
  var s=new Date(rows[i].start).getTime(),e=new Date(rows[i].end).getTime();
  if(e<start||s>nowt)continue;
  var xs=xPos(Math.max(s,start)),xe=xPos(Math.min(e,nowt));
  var rr=document.createElementNS('http://www.w3.org/2000/svg','rect');
  rr.setAttribute('x',xs);rr.setAttribute('y',m.t+6);rr.setAttribute('width',Math.max(1,xe-xs));
  rr.setAttribute('height',h-12);rr.setAttribute('class','stop');svg.appendChild(rr);
 }
}
function renderMixList(){
 var list=$('mixList');list.innerHTML='';
 var rows=loadJSON(KEY_EVENTS,[]).slice().sort(function(a,b){return new Date(b.start)-new Date(a.start)});
 for(var i=0;i<rows.length;i++){
  var r=rows[i],li=document.createElement('li');li.className='logitem';
  li.innerHTML='<div class="log-ts">'+fmtDate(r.start)+'</div><div><span class="badge stop">Stop</span> '+
   r.reason.label+' · <span class="hint">'+fmtDur(r.durationMs)+'</span><div class="hint">'+r.comment+'</div></div>';
  list.appendChild(li);
 }
}
window.addEventListener('DOMContentLoaded',function(){
 restoreBasics();renderReasons();renderActivity();renderMixList();
 $('line').onchange=syncBasics;$('orderNo').oninput=syncBasics;$('itemNo').oninput=syncBasics;$('operator').oninput=syncBasics;
 $('btn-clear-order').onclick=function(){$('orderNo').value='';$('itemNo').value='';syncBasics()};
 $('btn-clear-line').onclick=function(){$('line').value='';$('operator').value='';syncBasics()};
 $('btn-open-stop').onclick=function(){show($('stopPanel'))};
 $('stop-cancel').onclick=function(){hide($('stopPanel'))};
 $('stop-confirm').onclick=startStop;
 $('btn-start').onclick=endStop;
 var cur=loadJSON(KEY_CURRENT,null);
 if(cur&&cur.start){STOP_START_ISO=cur.start;stopMeta=cur.meta;setStatus(true);TICK=setInterval(tick,1000);tick();}
});
/* === Power Automate integration === */
var ENDPOINT_EVENT="https://<din-flow-url>/event";
var ENDPOINT_REP="https://<din-flow-url>/rep";
var ENDPOINT_NOTE="https://<din-flow-url>/note";

function postJSON(url,payload,label){
 if(!url||url.indexOf('http')!==0)return;
 try{
  var x=new XMLHttpRequest();
  x.open('POST',url,true);
  x.setRequestHeader('Content-Type','application/json;charset=UTF-8');
  x.onreadystatechange=function(){if(x.readyState===4){console.log(label,'->',x.status)}};
  x.send(JSON.stringify(payload));
 }catch(e){}
}
function resendQueued(){
 var feed=loadJSON(KEY_FEED,[]),changed=false;
 for(var i=0;i<feed.length;i++){
  var r=feed[i];if(r.sent)continue;
  if(r.type==='stop'){
   postJSON(ENDPOINT_EVENT,{id:r.id,start:r.start,end:r.end,duration_ms:r.durationMs,
    line:r.line,order:r.orderNo,item:r.itemNo,operator:r.operator,
    cause_code:(r.reason&&r.reason.code)||'',cause_label:(r.reason&&r.reason.label)||'',
    details:(r.detailChips||[]).join(', '),other:r.other||'',comment:r.comment||''},'STOP');
   r.sent=true;changed=true;
  }
 }
 if(changed)saveJSON(KEY_FEED,feed);
}
window.addEventListener('DOMContentLoaded',function(){
 resendQueued();setInterval(resendQueued,5*60*1000);
});
</script>
</body>
</html>
