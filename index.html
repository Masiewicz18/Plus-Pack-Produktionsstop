<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Plus Pack – Produktionsstop (Legacy Edge 20H2)</title>

<style>
/* ====== Basic reset ====== */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;}
body{margin:0;font-family:Segoe UI, Arial, Helvetica, sans-serif;background:#f4f6f9;color:#0f172a}

/* ====== Colors & tokens (uden CSS-variabler) ====== */
.pp-brand{background:#0a61ae;color:#fff}
.pp-bg{background:#f4f6f9}
.pp-card{background:#ffffff;border:1px solid #e6ecf3;border-radius:14px}
.pp-btn{background:#ffffff;border:1px solid #dbe4ef;border-radius:12px;cursor:pointer}
.pp-btn:disabled{opacity:.55;cursor:not-allowed}
.pp-muted{color:#6b7280}
.pp-ok{color:#17833e}
.pp-danger{color:#b91c1c}
.pp-shadow{box-shadow:0 6px 20px rgba(15,23,42,.06)}

/* ====== Top bar ====== */
.brandbar{padding:12px 18px;font-weight:800;letter-spacing:.2px}
.tabs{padding:10px 12px;border-bottom:1px solid #e6ecf3;background:#fff}
.tabs .row{display:flex;flex-wrap:wrap;align-items:center}
.tab{border:0;background:transparent;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer}
.tab.active{background:#f8fafc;border:1px solid #e6ecf3}
.statuspill{margin-left:auto;display:inline-flex;align-items:center;gap:10px;border:1px solid #e6ecf3;border-radius:999px;padding:6px 10px;background:#fff}
.dot{width:12px;height:12px;border-radius:999px;background:#17833e}
.dot.stop{background:#dc2626}

/* ====== Layout (flex – ikke grid) ====== */
.container{max-width:1180px;margin:0 auto;padding:14px}
.flex{display:flex}
.col{flex:1 1 0}
.gap12{gap:12px}
.stack > *{margin-bottom:12px}
.card{padding:14px;border:1px solid #e6ecf3;border-radius:14px;background:#fff;box-shadow:0 6px 20px rgba(15,23,42,.06)}

/* ====== Inputs ====== */
label{font-size:12px;color:#6b7280;display:block;margin-bottom:4px}
input,select,textarea{width:100%;border:1px solid #e1e7f0;border-radius:10px;padding:10px 12px;background:#fff}
textarea{min-height:84px}
.row2{display:flex;flex-wrap:wrap;gap:10px}
.row2 .field{flex:1 1 240px}
.row3{display:flex;flex-wrap:wrap;gap:10px}
.row3 .field{flex:1 1 200px}
.field{margin-bottom:10px}

/* ====== Buttons ====== */
.btn{border:1px solid #dbe4ef;background:#fff;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btn-stop{border-color:#f3b3b3;background:#fff1f1;color:#7f1d1d}
.btn-start{border-color:#b7e6c7;background:#ebfff2;color:#0b5a3c}
.btn-ghost{background:#fff;border-color:#dbe4ef}
.btn-xl{padding:16px 20px;font-size:22px}

/* ====== Timer ====== */
.timer{font:700 44px/1.1 ui-monospace,Consolas,monospace;color:#111827}
.timer small{display:block;font:600 12px/1 Segoe UI,Arial;color:#6b7280;margin-bottom:4px}

/* ====== Chips (årsag/uddybning) ====== */
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #dbe4ef;border-radius:999px;background:#f5f9ff;cursor:pointer;font-size:13px}
.chip input{width:16px;height:16px}
.chip-radio.selected{background:#e8f1ff;border-color:#6ba8ff;font-weight:700}
.chip-check.selected{background:#ecfdf5;border-color:#22c55e;font-weight:700}

/* ====== 8h activity (svg) ====== */
.activity{width:100%;height:140px}
.activity .gridline{stroke:#e5e7eb;stroke-width:1}
.activity .gridline.sub{opacity:.5}
.activity .now{stroke:#0a61ae;stroke-width:2}
.activity .runbg{fill:rgba(16,185,129,.06)}
.activity .label{fill:#475569;font-size:10px}
.activity .stop{fill:rgba(220,38,38,.28);stroke:#dc2626;stroke-width:1}

/* ====== Logliste ====== */
.loglist{list-style:none;margin:0;padding:0;max-height:200px;overflow:auto;border:1px dashed #dbe4ef;border-radius:12px;background:#fff}
.loglist li{display:flex;gap:10px;padding:8px 10px;border-bottom:1px solid #eef2f7}
.loglist li:last-child{border-bottom:0}
.log-ts{min-width:140px;color:#6b7280;font-size:12px}
.tag{display:inline-block;border:1px solid #e2e8f0;background:#f8fafc;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:6px}

/* ====== KPI / simple “diagrammer” ====== */
.kpi{border:1px solid #e6ecf3;border-radius:10px;background:#f8fafc;padding:10px;min-width:140px}
.kpi .val{font-weight:900;font-size:22px}
.barlist{display:block}
.barrow{display:flex;align-items:center;gap:10px;margin:6px 0}
.bar{flex:1;height:10px;border-radius:999px;background:linear-gradient(90deg,#60a5fa,#2563eb)}

/* ====== Sections ====== */
h3{margin:0 0 8px}
.hint{font-size:12px;color:#6b7280}
.sep{height:1px;background:#e6ecf3;margin:8px 0}

/* ====== Responsive ====== */
@media (max-width:900px){
  .flex, .row2, .row3{display:block}
  .statuspill{margin-left:0;margin-top:8px}
}
</style>
</head>
<body>

<!-- Top -->
<div class="brandbar pp-brand">Plus Pack – Produktionsstop</div>
<div class="tabs">
  <div class="row">
    <button class="tab active" id="tab-handling" type="button">Handling</button>
    <button class="tab" id="tab-stats" type="button">Statistik</button>
    <button class="tab" id="tab-hist" type="button">Historik</button>
    <button class="tab" id="tab-share" type="button">Deling</button>
    <button class="tab" id="tab-settings" type="button">Indstillinger</button>
    <div class="statuspill"><span class="dot" id="dot"></span><span id="statxt">Kører</span></div>
  </div>
</div>

<div class="container">

  <!-- ============== Handling (alt uden popups) ============== -->
  <section id="view-handling">

    <!-- Primære knapper + timer -->
    <div class="card">
      <div class="stack">
        <div class="flex gap12">
          <button id="btn-stop" class="btn btn-stop btn-xl col">⏹ STOP (Ctrl+S)</button>
          <button id="btn-start" class="btn btn-start btn-xl col" disabled>▶ START (Ctrl+A)</button>
        </div>
        <div class="timer"><small>Aktuelt stop</small><span id="liveTimer">—</span></div>
      </div>
    </div>

    <!-- Registrér stop – altid som panel -->
    <div class="card" id="stopPanel" style="display:none">
      <h3>Registrér stop</h3>
      <div class="hint" id="stopHint">Udfyld Ordre nr. og Vare nr. før du bekræfter.</div>
      <div class="sep"></div>

      <div class="row2">
        <div class="field col">
          <label>Årsag</label>
          <div id="reasonTop" class="chips"></div>
          <div id="reasonMore" class="chips" style="margin-top:6px"></div>
        </div>
        <div class="field col">
          <label>Uddybning</label>
          <div id="reasonChips" class="chips"></div>
        </div>
      </div>

      <div class="row2">
        <div class="field col"><label>Andet</label><input id="other" type="text"></div>
        <div class="field col"><label>Kommentar</label><input id="comment" type="text"></div>
      </div>

      <div class="flex gap12" style="justify-content:flex-end;margin-top:6px">
        <button id="stop-cancel" class="btn btn-ghost">Annuller</button>
        <button id="stop-confirm" class="btn btn-stop">Bekræft stop</button>
      </div>
    </div>

    <!-- Basisoplysninger -->
    <div class="card">
      <h3>Basisoplysninger</h3>
      <div class="row3">
        <div class="field"><label>Linje / maskine</label>
          <select id="line">
            <option value="">— Vælg maskine —</option>
            <option>L10 75 t Rhodes special presse</option>
            <option>L11 Mech RF135 serie nr 18-11 Mnr888</option>
            <option disabled>L12 30 t Flexo C30 S15  INAKTIV</option>
            <option>L13 Press Beutler PD 40</option>
            <option>L14 50 t Flexo C50 S20 presse</option>
            <option>L15 30 t Flexo C30 S15 presse</option>
            <option>L16 40 t Schuler PNH 40/250 presse</option>
            <option>L17 30 t Flexo C30 S15 presse</option>
            <option>L20 50 t Bliss 50F MKII presse</option>
            <option>L22 50 t Bliss 50F MKII presse</option>
            <option>L23 45 t Bliss 21½ presse</option>
            <option>L24 30 t Flexo C30 S15</option>
            <option>L25 30 t Flexo C30 X presse</option>
            <option>L26 L 36 30 t Flexo C30 S 15 presse</option>
            <option>L27 45 t Bliss 21½ presse</option>
            <option>L28 50 t Flexo presse</option>
            <option>L29 30 t Flexo C30 presse</option>
            <option>L30 ny presse 2012</option>
            <option>L33 50 t Bliss 50F MKII presse</option>
            <option>L34 50 t Bliss 50F MKII presse</option>
            <option>L35 30 t Flexo C30 S15 presse</option>
            <option>L36 30 t Flexo C30 S15 presse Picop</option>
            <option>L40 50 t Flexo C50 S20 presse</option>
            <option>L41 L37, 50 t Bliss 50F MKII presse</option>
            <option>L42 Press Beutler PD 40 alu spez638</option>
            <option>L43 Press Beutler PD 40 alu spez637</option>
            <option>L80 Choko-kapsler</option>
            <option>L81 Lys-manchetter</option>
            <option>L82 Lys-manchetter</option>
          </select>
        </div>
        <div class="field"><label>Ordre nr. (krævet)</label><input id="orderNo" type="text"></div>
        <div class="field"><label>Vare nr. (krævet)</label><input id="itemNo" type="text"></div>
      </div>
      <div class="row3">
        <div class="field"><label>Operatør (valgfri)</label><input id="operator" type="text" placeholder="Navn/initialer"></div>
        <div class="field"><label>&nbsp;</label><button id="btn-clear-order" class="btn">Ryd ordre</button></div>
        <div class="field"><label>&nbsp;</label>
          <div class="flex gap12">
            <button id="btn-clear-line" class="btn">Ryd linje/navn</button>
            <button id="btn-open-rep" class="btn">Åbn rep-seddel (mail)</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Aktivitet + Log -->
    <div class="flex gap12">
      <div class="card col">
        <h3>Aktivitet – sidste 8 timer</h3>
        <svg class="activity" id="activity8h" viewBox="0 0 920 140"></svg>
        <div class="hint">Røde felter = registrerede stop. Højre kant er “nu”.</div>
      </div>
      <div class="card col">
        <h3>Aktivitetslog</h3>
        <ul class="loglist" id="log8h"></ul>
      </div>
    </div>

    <!-- Handover -->
    <div class="card">
      <h3>Overlevering / skift-noter</h3>
      <div class="row2">
        <div class="field col"><label>Noter</label><textarea id="handoverText" placeholder="Kort status, åbne punkter, kendte fejl…"></textarea></div>
        <div class="field col"><label>Tag</label><input id="handoverTag" type="text" placeholder="fx Vedligehold, Kvalitet"></div>
      </div>
      <div class="flex gap12">
        <button id="handoverSave" class="btn btn-start">Gem note</button>
        <button id="handoverClear" class="btn">Ryd felt</button>
      </div>
      <div id="handoverList" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- ============== Statistik ============== -->
  <section id="view-stats" style="display:none">
    <div class="card">
      <div class="flex gap12" style="align-items:center;flex-wrap:wrap;margin-bottom:8px">
        <h3 class="col" style="flex:0 0 auto">Stop-statistik</h3>
        <div class="hint">Visning</div>
        <select id="shiftSelect">
          <option value="all">Alle stop</option>
          <option value="current">Nuværende skift</option>
          <option value="day">Dag (06–14)</option>
          <option value="evening">Aften (14–22)</option>
          <option value="night">Nat (22–06)</option>
        </select>
        <select id="paretoMode">
          <option value="freq">Hyppighed</option>
          <option value="dur">Varighed</option>
        </select>
      </div>

      <div class="flex gap12" style="flex-wrap:wrap">
        <div class="kpi"><div class="pp-muted">Antal stop</div><div class="val" id="kpi-count">0</div></div>
        <div class="kpi"><div class="pp-muted">Samlet varighed</div><div class="val" id="kpi-dur">00:00:00</div></div>
        <div class="kpi"><div class="pp-muted">Gns. pr. stop</div><div class="val" id="kpi-avg">00:00:00</div></div>
        <div class="kpi"><div class="pp-muted">Top-årsag</div><div class="val" id="kpi-top">—</div><div class="pp-muted" id="kpi-top-sub">—</div></div>
      </div>

      <div class="sep"></div>

      <div class="flex gap12" style="flex-wrap:wrap">
        <div class="card col" style="min-width:300px">
          <div class="pp-muted" style="margin-bottom:6px">Hyppighed (antal pr. årsag)</div>
          <div id="bars-freq" class="barlist"></div>
        </div>
        <div class="card col" style="min-width:300px">
          <div class="pp-muted" style="margin-bottom:6px">Varighed (sum pr. årsag)</div>
          <div id="bars-dur" class="barlist"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ============== Historik ============== -->
  <section id="view-hist" style="display:none">
    <div class="card">
      <div class="flex gap12" style="align-items:center;flex-wrap:wrap;margin-bottom:8px">
        <strong>Poster:</strong><span id="countPosts">0</span>
        <strong style="margin-left:12px">Plads:</strong><span id="usageTxt">0%</span>
        <div style="height:8px;background:#eef2f7;border:1px solid #e6ecf3;border-radius:999px;overflow:hidden;width:180px">
          <div id="usageFill" style="height:100%;width:0;background:linear-gradient(90deg,#c7d2fe,#93c5fd)"></div>
        </div>
        <button class="btn" id="btn-archive" style="margin-left:auto">Arkivér & nulstil</button>
      </div>

      <div style="overflow:auto;max-height:60vh;border:1px solid #e6ecf3;border-radius:10px">
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#f8fafc">
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6ecf3">Start</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6ecf3">Slut</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6ecf3">Varighed</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6ecf3">Linje</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6ecf3">Ordre</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6ecf3">Vare</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6ecf3">Kode</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6ecf3">Uddybning</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6ecf3">Kommentar</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid #e6ecf3">Operatør</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid #e6ecf3">Handling</th>
            </tr>
          </thead>
          <tbody id="tbl-body"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ============== Deling ============== -->
  <section id="view-share" style="display:none">
    <div class="card">
      <div class="flex gap12" style="flex-wrap:wrap">
        <button class="btn" id="btn-csv">Eksporter CSV</button>
        <button class="btn" id="btn-json">Kopiér JSON</button>
        <button class="btn" id="btn-email">Åbn mail (vedhæft selv)</button>
        <button class="btn" id="btn-clear-log">Nulstil log</button>
      </div>
      <div class="hint" style="margin-top:6px">Data gemmes lokalt i browseren (localStorage).</div>
    </div>
  </section>

  <!-- ============== Indstillinger ============== -->
  <section id="view-settings" style="display:none">
    <div class="card">
      <h3>Indstillinger</h3>
      <div class="row2">
        <div class="field"><label>Standard-modtager</label><input id="defTo" type="email" placeholder="vedligehold@pluspack.com"></div>
        <div class="field"><label>Brandfarve (hex)</label><input id="brandColor" type="text" placeholder="#0a61ae"></div>
      </div>
      <div class="row2">
        <div class="field"><label>Tema</label>
          <select id="themeSelect">
            <option value="standard">Standard (lys)</option>
            <option value="dark">Mørk</option>
          </select>
        </div>
        <div class="field"><label>&nbsp;</label><button id="btn-save-settings" class="btn">Gem indstillinger</button></div>
      </div>
    </div>

    <div class="card">
      <h3>Årsager</h3>
      <div class="row2">
        <div class="field"><label>Kode (fx PRES)</label><input id="causeCode" type="text" placeholder="KODE"></div>
        <div class="field"><label>Navn/label</label><input id="causeLabel" type="text" placeholder="Beskrivelse"></div>
      </div>
      <div class="field"><label>Uddybning (chips, kommasepareret)</label><input id="causeChips" type="text" placeholder="fx Rensning, Sikkerhed, Opsætning"></div>
      <div class="flex gap12">
        <button class="btn" id="btn-add-cause">Tilføj årsag</button>
        <button class="btn" id="btn-reset-causes">Nulstil til standard</button>
      </div>
      <div id="causeList" style="margin-top:8px"></div>
    </div>
  </section>

</div><!-- /container -->

<script>
/* ===================== Legacy helpers (ingen ES6 syntaks) ===================== */
function $(id){return document.getElementById(id)}
function show(el){if(el) el.style.display=''}
function hide(el){if(el) el.style.display='none'}
function addClass(el,c){if(!el)return; if((' '+el.className+' ').indexOf(' '+c+' ')<0) el.className+=(el.className?' ':'')+c}
function remClass(el,c){if(!el)return; el.className=el.className.split(' ').filter(function(x){return x!==c}).join(' ')}
function pad(n){return (n<10?'0':'')+n}
function fmtDate(d){var dt=(d instanceof Date)?d:new Date(d); try{return dt.toLocaleString('da-DK')}catch(e){return dt.toString()}}
function fmtDur(ms){var s=Math.floor((ms||0)/1000),h=pad(Math.floor(s/3600)),m=pad(Math.floor((s%3600)/60)),ss=pad(s%60);return h+':'+m+':'+ss}
function fmtShort(ms){var s=Math.floor((ms||0)/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60;return h>0?(h+'t '+(m<10?'0':'')+m+'m'):((m>0?m+'m ':'')+((ss<10?'0':'')+ss)+'s')}
function bytesLen(str){return unescape(encodeURIComponent(str||'')).length}
function uuid(){return 'id-'+Date.now()+'-'+Math.floor(Math.random()*1e6)}

/* ===================== Storage keys ===================== */
var STORAGE='produktionsstop.events.v2';
var SETTINGS='produktionsstop.settings.v2';
var HANDOVER='produktionsstop.handover.v1';
var DRAFT='produktionsstop.handoverDraft.v1';
var CURRENT_STOP='produktionsstop.current.v1';

/* ===================== Load/Save ===================== */
function loadJSON(k,def){try{return JSON.parse(localStorage.getItem(k))||def}catch(e){return def}}
function saveJSON(k,v){localStorage.setItem(k,JSON.stringify(v))}
function loadEvents(){return loadJSON(STORAGE,[])}
function saveEvents(x){saveJSON(STORAGE,x)}
function loadSettings(){return loadJSON(SETTINGS,{})}
function saveSettings(x){saveJSON(SETTINGS,x)}
function loadHandover(){return loadJSON(HANDOVER,[])}
function saveHandover(x){saveJSON(HANDOVER,x)}
function loadDraft(){return loadJSON(DRAFT,{txt:'',tag:''})}
function saveDraft(x){saveJSON(DRAFT,x)}
function loadCurrentStop(){return loadJSON(CURRENT_STOP,null)}
function saveCurrentStop(x){saveJSON(CURRENT_STOP,x)}
function clearCurrentStop(){localStorage.removeItem(CURRENT_STOP)}

/* ===================== Konfiguration endpoints (indsæt jeres links) ===================== */
var ENDPOINT_STOP  = "#";   // POST afsluttet stop
/* Simple XHR POST */
function postJSON(url,payload,cb){
  if(!url || url==="#"){cb(true);return}
  try{
    var xhr=new XMLHttpRequest()
    xhr.open('POST',url,true)
    xhr.setRequestHeader('Content-Type','application/json;charset=UTF-8')
    xhr.onreadystatechange=function(){
      if(xhr.readyState===4){ cb(xhr.status>=200 && xhr.status<300) }
    }
    xhr.send(JSON.stringify(payload))
  }catch(e){ cb(false) }
}

/* ===================== Årsager ===================== */
var DEFAULT_REASONS=[
  {code:'PRES',label:'Presse',chips:['Rensning','Smøring','Opsætning']},
  {code:'VAERK',label:'Værktøj',chips:['Skift','Slid','Defekt']},
  {code:'STAK', label:'Stakker', chips:['Fejl','Opsamler','Andet']},
  {code:'FOLIE',label:'Manglende folie',chips:['Påfyld','Bestilling']},
  {code:'ORDRE',label:'Manglende ordre',chips:['Afventer','Uklar ordre']},
  {code:'ANDET',label:'Andet', chips:['Sikkerhed','Rengøring']}
]
function allReasons(){
  var s=loadSettings(), list=(s.customCauses||[]), map={}, out=[]
  for(var i=0;i<DEFAULT_REASONS.length;i++){map[DEFAULT_REASONS[i].code]=DEFAULT_REASONS[i]}
  for(var j=0;j<list.length;j++){var c=list[j]; map[c.code]={code:c.code,label:c.label,chips:c.chips||[]}}
  for(var k in map){out.push(map[k])}
  out.sort(function(a,b){return a.label.localeCompare(b.label)})
  return out
}
function getReason(code){
  var list=allReasons(); for(var i=0;i<list.length;i++){if(list[i].code===code) return list[i]}
  return null
}

/* ===================== UI refs ===================== */
var els={
  tabHandling:$('tab-handling'), tabStats:$('tab-stats'), tabHist:$('tab-hist'), tabShare:$('tab-share'), tabSettings:$('tab-settings'),
  viewHandling:$('view-handling'), viewStats:$('view-stats'), viewHist:$('view-hist'), viewShare:$('view-share'), viewSettings:$('view-settings'),
  btnStop:$('btn-stop'), btnStart:$('btn-start'), dot:$('dot'), statxt:$('statxt'), liveTimer:$('liveTimer'),
  stopPanel:$('stopPanel'), stopHint:$('stopHint'), stopCancel:$('stop-cancel'), stopConfirm:$('stop-confirm'),
  reasonTop:$('reasonTop'), reasonMore:$('reasonMore'), reasonChips:$('reasonChips'), other:$('other'), comment:$('comment'),
  line:$('line'), orderNo:$('orderNo'), itemNo:$('itemNo'), operator:$('operator'),
  btnClearOrder:$('btn-clear-order'), btnClearLine:$('btn-clear-line'), btnOpenRep:$('btn-open-rep'),
  activity:$('activity8h'), log8h:$('log8h'),
  handoverText:$('handoverText'), handoverTag:$('handoverTag'), handoverSave:$('handoverSave'), handoverClear:$('handoverClear'), handoverList:$('handoverList'),
  // stats
  shiftSelect:$('shiftSelect'), paretoMode:$('paretoMode'), barsFreq:$('bars-freq'), barsDur:$('bars-dur'),
  kpiCount:$('kpi-count'), kpiDur:$('kpi-dur'), kpiAvg:$('kpi-avg'), kpiTop:$('kpi-top'), kpiTopSub:$('kpi-top-sub'),
  // hist/share
  tableBody:$('tbl-body'), countPosts:$('countPosts'), usageTxt:$('usageTxt'), usageFill:$('usageFill'), btnArchive:$('btn-archive'),
  btnCsv:$('btn-csv'), btnJson:$('btn-json'), btnEmail:$('btn-email'), btnClearLog:$('btn-clear-log'),
  // settings
  defTo:$('defTo'), brandColor:$('brandColor'), themeSelect:$('themeSelect'), btnSaveSettings:$('btn-save-settings')
}

/* ===================== Status & timer ===================== */
var IS_STOPPED=false, STOP_START_ISO=null, stopMeta=null, timer=null
function setStatus(st){
  IS_STOPPED=st
  els.btnStop.disabled=st; els.btnStart.disabled=!st
  els.dot.className=st?'dot stop':'dot'
  els.statxt.innerHTML=st?'Stoppet':'Kører'
  els.liveTimer.innerHTML=st?'00:00:00':'—'
}
function tick(){
  if(!IS_STOPPED) return
  var ms=Date.now()-new Date(STOP_START_ISO)
  els.liveTimer.innerHTML=fmtDur(ms)
  renderActivity8h(); renderLog8h()
}

/* ===================== Årsag UI ===================== */
function renderChipsByCode(code){
  var r=getReason(code)||{chips:[]}, i, html=''
  for(i=0;i<(r.chips||[]).length;i++){
    html+='<label class="chip chip-check"><input type="checkbox" value="'+r.chips[i]+'">'+r.chips[i]+'</label>'
  }
  els.reasonChips.innerHTML=html
}
function selectedChipValues(){
  var boxes=els.reasonChips.getElementsByTagName('input'), out=[]
  for(var i=0;i<boxes.length;i++){ if(boxes[i].checked) out.push(boxes[i].value) }
  return out
}
function reasonRadioChanged(e){
  var t=e.target||e.srcElement
  if(t && t.name==='reasonRadio'){ renderChipsByCode(t.value); els.stopHint.innerHTML='' }
}
function renderReasons(){
  var list=allReasons(), top=list.slice(0,8), more=list.slice(8), i, html=''
  function mk(r){ return '<label class="chip chip-radio"><input type="radio" name="reasonRadio" value="'+r.code+'"><b>'+r.code+'</b> – '+r.label+'</label>' }
  for(i=0;i<top.length;i++){ html+=mk(top[i]) } els.reasonTop.innerHTML=html
  html=''; for(i=0;i<more.length;i++){ html+=mk(more[i]) } els.reasonMore.innerHTML=html
  var first=els.reasonTop.querySelector('input[name="reasonRadio"]') || els.reasonMore.querySelector('input[name="reasonRadio"]')
  if(first){ first.checked=true; renderChipsByCode(first.value) }
  els.reasonTop.onclick=reasonRadioChanged; els.reasonMore.onclick=reasonRadioChanged
}

/* ===================== Aktivitet & log ===================== */
function renderActivity8h(){
  var svg=els.activity; if(!svg) return; svg.innerHTML=''
  var W=920,H=140,m={l:40,r:10,t:20,b:20},w=W-m.l-m.r,h=H-m.t-m.b
  var now=new Date(), start=new Date(now.getTime()-8*3600*1000)
  function xPos(t){return m.l+Math.max(0,Math.min(w,((t-start)/(8*3600*1000))*w))}
  var bg=document.createElementNS('http://www.w3.org/2000/svg','rect'); bg.setAttribute('x',m.l); bg.setAttribute('y',m.t); bg.setAttribute('width',w); bg.setAttribute('height',h); bg.setAttribute('class','runbg'); svg.appendChild(bg)
  for(var i=0;i<=8;i++){
    var x=m.l+(w*(i/8)), ln=document.createElementNS('http://www.w3.org/2000/svg','line')
    ln.setAttribute('x1',x); ln.setAttribute('y1',m.t); ln.setAttribute('x2',x); ln.setAttribute('y2',m.t+h); ln.setAttribute('class','gridline'); svg.appendChild(ln)
    var t=document.createElementNS('http://www.w3.org/2000/svg','text'); var dt=new Date(start.getTime()+i*3600*1000)
    t.setAttribute('x',x+2); t.setAttribute('y',H-4); t.setAttribute('class','label'); t.textContent=pad(dt.getHours())+':00'; svg.appendChild(t)
    if(i<8){var xh=x+(w/8)/2, ln2=document.createElementNS('http://www.w3.org/2000/svg','line'); ln2.setAttribute('x1',xh); ln2.setAttribute('y1',m.t); ln2.setAttribute('x2',xh); ln2.setAttribute('y2',m.t+h); ln2.setAttribute('class','gridline sub'); svg.appendChild(ln2)}
  }
  var rows=loadEvents(),stops=[]
  for(i=0;i<rows.length;i++){
    var r=rows[i]; if(!r.end) continue
    var s=new Date(r.start), e=new Date(r.end); if(e<start||s>now) continue
    var cs=Math.max(s.getTime(),start.getTime()), ce=Math.min(e.getTime(),now.getTime()); stops.push([cs,ce])
  }
  if(IS_STOPPED && STOP_START_ISO){ var s2=Math.max(new Date(STOP_START_ISO).getTime(),start.getTime()), e2=now.getTime(); if(e2>s2) stops.push([s2,e2]) }
  for(i=0;i<stops.length;i++){
    var xs=xPos(stops[i][0]), xe=xPos(stops[i][1]), rr=document.createElementNS('http://www.w3.org/2000/svg','rect')
    rr.setAttribute('x',xs); rr.setAttribute('y',m.t+8); rr.setAttribute('width',Math.max(1,xe-xs)); rr.setAttribute('height',h-16); rr.setAttribute('class','stop'); svg.appendChild(rr)
  }
  var xnow=xPos(now), nowLn=document.createElementNS('http://www.w3.org/2000/svg','line'); nowLn.setAttribute('x1',xnow); nowLn.setAttribute('y1',m.t-2); nowLn.setAttribute('x2',xnow); nowLn.setAttribute('y2',m.t+h+2); nowLn.setAttribute('class','now'); svg.appendChild(nowLn)
}
function renderLog8h(){
  var el=els.log8h; el.innerHTML=''
  var now=new Date(), start=new Date(now.getTime()-8*3600*1000)
  var rows=loadEvents().filter(function(r){return r.end && new Date(r.end)>start}).sort(function(a,b){return new Date(b.start)-new Date(a.start)})
  if(rows.length===0 && !(IS_STOPPED && STOP_START_ISO)){ el.innerHTML='<li class="pp-muted" style="padding:8px 10px">Ingen registreringer i perioden</li>'; return }
  if(IS_STOPPED && STOP_START_ISO){
    var ms=Date.now()-new Date(STOP_START_ISO), li=document.createElement('li')
    li.innerHTML='<div class="log-ts">NU</div><div><strong>Aktivt stop</strong> <span class="tag">'+fmtDur(ms)+'</span></div>'; el.appendChild(li)
  }
  for(var i=0;i<rows.length;i++){
    var r=rows[i], code=(r.reason&&r.reason.code)||''
    var li2=document.createElement('li')
    li2.innerHTML='<div class="log-ts">'+fmtDate(r.start)+'</div><div>'+(code?('<span class="tag">'+code+'</span> '):'')+((r.reason&&r.reason.label)||'Stop')+' – <span class="pp-muted">'+fmtDur(r.durationMs||0)+'</span>'+(r.comment?(' · '+r.comment):'')+'</div>'
    el.appendChild(li2)
  }
}

/* ===================== Stats ===================== */
function getShiftRange(type, ref){
  if(!ref) ref=new Date()
  var d=new Date(ref), y=d.getFullYear(), m=d.getMonth(), day=d.getDate()
  function at(h){return new Date(y,m,day,h,0,0)}
  if(type==='day') return [at(6),at(14)]
  if(type==='evening') return [at(14),at(22)]
  if(type==='night'){var s=at(22), e=new Date(y,m,day+1,6,0,0); return [s,e]}
  if(type==='current'){
    var ranges=[getShiftRange('day',d),getShiftRange('evening',d),getShiftRange('night',d)]
    for(var i=0;i<ranges.length;i++){var s=ranges[i][0],e=ranges[i][1]; if(d>=s && d<e) return [s,e]}
    return getShiftRange('night', new Date(y,m,day-1,23,0,0))
  }
  return [null,null]
}
function filteredEvents(){
  var mode=els.shiftSelect.value||'all'
  if(mode==='all') return loadEvents()
  var se=getShiftRange(mode), s=se[0], e=se[1]
  return loadEvents().filter(function(r){var rs=new Date(r.start), re=new Date(r.end||Date.now()); return (!s||re>=s) && (!e||rs<e)})
}
function aggregate(rows){
  var map={}, i; for(i=0;i<rows.length;i++){
    var r=rows[i], key=((r.reason&&r.reason.code)||'UKENDT')+'|'+((r.reason&&r.reason.label)||'Ukendt')
    if(!map[key]) map[key]={code:(r.reason&&r.reason.code)||'UKENDT',label:(r.reason&&r.reason.label)||'Ukendt',count:0,dur:0}
    map[key].count+=1; map[key].dur+=(r.durationMs||0)
  }
  var out=[]; for(var k in map) out.push(map[k])
  out.sort(function(a,b){return (b.count-a.count)||(b.dur-a.dur)})
  return out
}
function renderBars(container,data,fmt,relKey){
  var max=1,i; for(i=0;i<data.length;i++){ if((data[i][relKey]||0)>max) max=data[i][relKey] }
  var html=''
  for(i=0;i<data.length;i++){
    var d=data[i], w=Math.round(((d[relKey]||0)/max)*100)
    html+='<div class="barrow"><div style="min-width:80px" class="pp-muted">'+d.code+'</div><div style="flex:1"><div class="bar" style="width:'+w+'%"></div></div><div style="min-width:70px;text-align:right">'+fmt(d)+'</div></div>'
  }
  container.innerHTML=html||'<div class="pp-muted">Ingen data</div>'
}
function computeStats(rows){
  var tot=0; for(var i=0;i<rows.length;i++) tot+=rows[i].durationMs||0
  return {count:rows.length, dur:tot, avg: rows.length?Math.round(tot/rows.length):0}
}
function renderStats(){
  var rows=filteredEvents().filter(function(r){return r.end})
  var agg=aggregate(rows), k=computeStats(rows)
  els.kpiCount.innerHTML=String(k.count)
  els.kpiDur.innerHTML=fmtDur(k.dur)
  els.kpiAvg.innerHTML=fmtDur(k.avg)
  if(agg.length){ els.kpiTop.innerHTML=agg[0].code; els.kpiTopSub.innerHTML='Hyppigst: '+agg[0].count+' stk' } else { els.kpiTop.innerHTML='—'; els.kpiTopSub.innerHTML='—' }
  renderBars(els.barsFreq, agg, function(x){return x.count+' stk'}, 'count')
  renderBars(els.barsDur,  agg, function(x){return fmtShort(x.dur||0)}, 'dur')
}

/* ===================== Historik/eksport ===================== */
function renderTable(){
  var rows=loadEvents().sort(function(a,b){return new Date(b.start)-new Date(a.start)})
  var html='', i
  for(i=0;i<rows.length;i++){
    var ev=rows[i]
    html+='<tr>'+
      td(fmtDate(ev.start))+
      td(ev.end?fmtDate(ev.end):'—')+
      td(ev.durationMs?fmtDur(ev.durationMs):'—')+
      td(ev.line||'')+
      td(ev.orderNo||'')+
      td(ev.itemNo||'')+
      td('<span class="tag">'+((ev.reason&&ev.reason.code)||'')+'</span> '+((ev.reason&&ev.reason.label)||''))+
      td((ev.detailChips||[]).join(', ')+(ev.other?(' '+ev.other):''))+
      td(ev.comment||'')+
      td(ev.operator||'')+
      '<td style="text-align:right;padding:8px;border-bottom:1px solid #e6ecf3"><button class="btn" data-id="'+ev.id+'" data-action="delete">Slet</button></td>'+
    '</tr>'
  }
  els.tableBody.innerHTML=html
  els.countPosts.innerHTML=String(rows.length)
  var used=[STORAGE,SETTINGS,HANDOVER].reduce(function(a,k){return a+bytesLen(localStorage.getItem(k)||'')},0)
  var pct=Math.min(100,Math.round((used/(5*1024*1024))*100))
  els.usageTxt.innerHTML=pct+'% ('+Math.round(used/1024)+' KB af 5120 KB)'; els.usageFill.style.width=pct+'%'
  renderActivity8h(); renderLog8h(); renderStats()
  function td(s){return '<td style="padding:8px;border-bottom:1px solid #e6ecf3">'+s+'</td>'}
}
function makeCsv(rows){
  function repl(s){return String(s||'').split(';').join(',')}
  function clean(s){return String(s||'').replace(/\n/g,' ')}
  var header=['id','start','slut','varighed_ms','varighed_hhmmss','linje','ordre','vare','kode','kode_label','uddybning','andet','kommentar','operatør'].join(';')
  var body=[]
  for(var i=0;i<rows.length;i++){
    var r=rows[i], code=(r.reason&&r.reason.code)||'', label=(r.reason&&r.reason.label)||''
    body.push([r.id,r.start,r.end,r.durationMs,fmtDur(r.durationMs||0),repl(r.line),repl(r.orderNo),repl(r.itemNo),code,label,repl((r.detailChips||[]).join('|')),repl(r.other),repl(clean(r.comment)),repl(r.operator)].join(';'))
  }
  return header+'\n'+body.join('\n')
}
function download(name,text){
  var blob=new Blob([text],{type:'text/plain;charset=utf-8;'}), url=URL.createObjectURL(blob), a=document.createElement('a')
  a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(function(){URL.revokeObjectURL(url)},400)
}

/* ===================== Tema & indstillinger ===================== */
function applyBrand(){
  var s=loadSettings()
  if(s.brandColor){
    // simpel farvebranding: topbar + aksent streg i activity
    var bb=document.getElementsByClassName('brandbar')[0]; if(bb) bb.style.background=s.brandColor
    var style=document.createElement('style')
    style.innerHTML='.activity .now{stroke:'+s.brandColor+';stroke-width:2}'
    document.head.appendChild(style)
  }
  els.defTo.value=s.defaultTo||'vedligehold@pluspack.com'
  els.brandColor.value=s.brandColor||'#0a61ae'
  els.themeSelect.value=s.theme||'standard'
  if(s.line) els.line.value=s.line
  els.operator.value=s.operator||''
  els.orderNo.value=s.orderNo||''
  els.itemNo.value=s.itemNo||''
  if(s.theme==='dark'){ document.body.style.background='#0b1220'; document.body.style.color='#e5e7eb' } else { document.body.style.background='#f4f6f9'; document.body.style.color='#0f172a' }
}

/* ===================== Init & events ===================== */
window.addEventListener('DOMContentLoaded', function(){
  // tabs
  function setTab(btn,view){
    [els.tabHandling,els.tabStats,els.tabHist,els.tabShare,els.tabSettings].forEach(function(b){remClass(b,'active')})
    addClass(btn,'active')
    [els.viewHandling,els.viewStats,els.viewHist,els.viewShare,els.viewSettings].forEach(hide)
    show(view)
  }
  els.tabHandling.onclick=function(){setTab(els.tabHandling,els.viewHandling)}
  els.tabStats.onclick=function(){setTab(els.tabStats,els.viewStats); renderStats()}
  els.tabHist.onclick=function(){setTab(els.tabHist,els.viewHist)}
  els.tabShare.onclick=function(){setTab(els.tabShare,els.viewShare)}
  els.tabSettings.onclick=function(){setTab(els.tabSettings,els.viewSettings)}

  // status
  setStatus(false); applyBrand(); renderTable(); renderReasons()
  // genoptag aktivt stop
  var cur=loadCurrentStop(); if(cur&&cur.start){ STOP_START_ISO=cur.start; stopMeta=cur.meta||null; setStatus(true); if(timer)clearInterval(timer); timer=setInterval(tick,1000) }

  // knapper
  els.btnStop.onclick=function(){ show(els.stopPanel) }
  els.stopCancel.onclick=function(){ hide(els.stopPanel); els.stopHint.innerHTML='' }
  els.stopConfirm.onclick=function(){
    if(!(els.orderNo.value||'').trim() || !(els.itemNo.value||'').trim()){ els.stopHint.innerHTML='Udfyld Ordre nr. og Vare nr. før du bekræfter.'; return }
    var sel=document.querySelector('input[name="reasonRadio"]:checked'), reason=getReason(sel?sel.value:null)||{code:'ANDET',label:'Andet'}
    stopMeta={reason:{code:reason.code,label:reason.label},detailChips:selectedChipValues(),other:(els.other.value||'').trim(),comment:(els.comment.value||'').trim()}
    STOP_START_ISO=new Date().toISOString(); setStatus(true); if(timer)clearInterval(timer); timer=setInterval(tick,1000); tick(); hide(els.stopPanel)
    saveCurrentStop({start:STOP_START_ISO,meta:stopMeta})
  }
  els.btnStart.onclick=function(){
    if(!IS_STOPPED) return
    var end=new Date(), start=new Date(STOP_START_ISO), duration=end-start
    var row={id:uuid(),start:start.toISOString(),end:end.toISOString(),durationMs:duration,line:els.line.value||'',operator:els.operator.value||'',orderNo:els.orderNo.value||'',itemNo:els.itemNo.value||'',reason:stopMeta?stopMeta.reason:null,detailChips:stopMeta?stopMeta.detailChips:[],other:stopMeta?stopMeta.other:'',comment:stopMeta?stopMeta.comment:''}
    var rows=loadEvents(); rows.push(row); saveEvents(rows)
    postJSON(ENDPOINT_STOP, row, function(){ setStatus(false); STOP_START_ISO=null; stopMeta=null; if(timer){clearInterval(timer);timer=null} renderTable(); clearCurrentStop() })
  }

  // genveje
  document.addEventListener('keydown',function(ev){
    if(ev.ctrlKey && (ev.key==='s'||ev.key==='S')){ev.preventDefault(); if(!IS_STOPPED){els.btnStop.click()}}
    if(ev.ctrlKey && (ev.key==='a'||ev.key==='A')){ev.preventDefault(); if(IS_STOPPED){els.btnStart.click()}}
  })

  // inputs sync
  function sync(){var s=loadSettings(); s.orderNo=els.orderNo.value||''; s.itemNo=els.itemNo.value||''; s.operator=els.operator.value||''; s.line=els.line.value||''; saveSettings(s)}
  els.line.onchange=sync; els.operator.oninput=sync; els.orderNo.oninput=sync; els.itemNo.oninput=sync
  els.btnClearOrder.onclick=function(){els.orderNo.value='';els.itemNo.value='';sync()}
  els.btnClearLine.onclick=function(){els.line.value='';els.operator.value='';sync()}
  els.btnOpenRep.onclick=function(){
    var to=(loadSettings().defaultTo||'vedligehold@pluspack.com')
    var subj='Reparationsseddel – '+(els.line.value||'Linje ?')+' – Ordre '+(els.orderNo.value||'?')+' / '+(els.itemNo.value||'?')
    var body='Linje: '+(els.line.value||'')+'\nOrdre/Vare: '+(els.orderNo.value||'')+' / '+(els.itemNo.value||'')+'\nOperatør: '+(els.operator.value||'')+'\n\nBeskrivelse:\n'
    window.location.href='mailto:'+encodeURIComponent(to)+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body)
  }

  // log/historik actions
  els.tableBody.onclick=function(e){
    var t=e.target; while(t && t.tagName!=='BUTTON' && t!==els.tableBody){t=t.parentNode}
    if(!t||t===els.tableBody)return
    if(t.getAttribute('data-action')==='delete'){
      var id=t.getAttribute('data-id'), rows=loadEvents().filter(function(r){return r.id!==id}); saveEvents(rows); renderTable()
    }
  }

  // deling
  els.btnCsv.onclick=function(){download('produktionsstop.csv',makeCsv(loadEvents()))}
  els.btnJson.onclick=function(){var json=JSON.stringify(loadEvents(),null,2); try{navigator.clipboard.writeText(json); alert('JSON kopieret')}catch(e){prompt('Kopiér JSON',json)}}
  els.btnClearLog.onclick=function(){if(confirm('Slet hele loggen?')){saveEvents([]);renderTable()}}
  els.btnArchive.onclick=function(){
    var rows=loadEvents(); if(!rows.length){alert('Ingen data at arkivere.');return}
    var d=new Date(), y=d.getFullYear(), mo=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'), hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0')
    download('produktionsstop_'+y+mo+da+'_'+hh+mm+'.csv', makeCsv(rows))
    if(confirm('Log blev eksporteret. Nulstille log nu?')){saveEvents([]);renderTable()}
  }
  els.btnEmail.onclick=function(){
    var to=(loadSettings().defaultTo||'vedligehold@pluspack.com'), subj='Produktionsstop – '+(els.line.value||'')+' – '+(new Date().toLocaleDateString('da-DK')||''), body='Se vedhæftet CSV/JSON som du eksporterer fra “Deling”.'
    window.location.href='mailto:'+encodeURIComponent(to)+'?subject='+encodeURIComponent(subj)+'&body='+encodeURIComponent(body)
  }

  // indstillinger
  els.btnSaveSettings.onclick=function(){
    var s=loadSettings(); s.defaultTo=els.defTo.value||''; s.brandColor=els.brandColor.value||'#0a61ae'; s.theme=els.themeSelect.value||'standard'; saveSettings(s); applyBrand(); alert('Indstillinger gemt.')
  }

  // handover
  function renderHandover(){
    var list=loadHandover().sort(function(a,b){return new Date(b.ts)-new Date(a.ts)}), c=els.handoverList
    c.innerHTML=''
    if(!list.length){c.innerHTML='<div class="pp-muted">Ingen noter endnu</div>'; return}
    for(var i=0;i<list.length;i++){
      var it=list[i], d=document.createElement('div'); d.className='card'; d.style.padding='10px'
      d.innerHTML='<div class="pp-muted">'+fmtDate(it.ts)+(it.tag?(' · '+it.tag):'')+'</div><div>'+it.txt+'</div><div style="text-align:right;margin-top:6px"><button class="btn" data-i="'+i+'">Slet</button></div>'
      c.appendChild(d)
    }
    var btns=c.getElementsByTagName('button'); for(i=0;i<btns.length;i++){btns[i].onclick=function(){var i=parseInt(this.getAttribute('data-i'),10); var arr=loadHandover(); arr.splice(i,1); saveHandover(arr); renderHandover()}}
  }
  renderHandover()
  var d=loadDraft(); if(!els.handoverText.value) els.handoverText.value=d.txt||''; if(!els.handoverTag.value) els.handoverTag.value=d.tag||''
  function draft(){saveDraft({txt:els.handoverText.value||'',tag:els.handoverTag.value||''})}
  els.handoverText.oninput=draft; els.handoverTag.oninput=draft
  els.handoverSave.onclick=function(){var txt=(els.handoverText.value||'').trim(); if(!txt){alert('Skriv en note.');return} var tag=(els.handoverTag.value||'').trim(); var arr=loadHandover(); arr.unshift({ts:new Date().toISOString(),txt:txt,tag:tag}); saveHandover(arr); localStorage.removeItem(DRAFT); els.handoverText.value=''; els.handoverTag.value=''; renderHandover()}
  els.handoverClear.onclick=function(){els.handoverText.value=''; els.handoverTag.value=''; localStorage.removeItem(DRAFT)}
})
</script>
</body>
</html>
