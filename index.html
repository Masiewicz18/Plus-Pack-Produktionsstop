<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Plus Pack – Produktionsstop (stabil/kompakt)</title>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%} body{margin:0;font-family:Segoe UI,Arial,Helvetica,sans-serif;background:#f4f6f9;color:#0f172a}
.topbar{background:#0a61ae;color:#fff;padding:8px 12px;font-weight:800}
.statuspill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.35);border-radius:999px;padding:4px 10px;background:rgba(255,255,255,.08)}
.dot{width:10px;height:10px;border-radius:999px;background:#17833e}.dot.stop{background:#dc2626}
.container{max-width:1180px;margin:0 auto;padding:12px}
.card{background:#fff;border:1px solid #e6ecf3;border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(15,23,42,.06);margin-bottom:10px}
.card-compact{padding:8px;border-radius:10px}
h3{margin:0 0 6px} label{font-size:11px;color:#6b7280;display:block;margin-bottom:3px}
.row{display:flex;flex-wrap:wrap;gap:8px} .field{margin-bottom:8px} .sm .field{flex:1 1 200px}
.hint{font-size:12px;color:#6b7280} .sep{height:1px;background:#e6ecf3;margin:8px 0}
input,select,textarea{width:100%;border:1px solid #dfe7f2;border-radius:10px;padding:8px 10px;background:#fff;font-size:14px}
textarea{min-height:72px}
.btn{border:1px solid #dbe4ef;background:#fff;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer;font-size:14px}
.btn:disabled{opacity:.55;cursor:not-allowed}
.btn-xs{padding:6px 8px;font-size:12px;border-radius:8px}
.btn-primary{background:#e8f1ff;border-color:#cfe2ff;color:#0a3d91}
.btn-danger{background:#fff1f1;border-color:#f3b3b3;color:#7f1d1d}
.btn-success{background:#ebfff2;border-color:#b7e6c7;color:#0b5a3c}
.timer{font:700 32px/1.1 ui-monospace,Consolas,monospace}
.timer small{display:block;font:600 11px/1 Segoe UI,Arial;color:#6b7280;margin-bottom:3px}
.activity{width:100%;height:120px}
.activity .gridline{stroke:#e5e7eb;stroke-width:1}.activity .gridline.sub{opacity:.5}
.activity .now{stroke:#0a61ae;stroke-width:2}
.activity .runbg{fill:rgba(16,185,129,.06)} .activity .label{fill:#475569;font-size:10px}
.activity .stop{fill:rgba(220,38,38,.28);stroke:#dc2626;stroke-width:1}
.loglist{list-style:none;margin:0;padding:0;border:1px dashed #dbe4ef;border-radius:10px;background:#fff;max-height:320px;overflow:auto}
.logitem{display:flex;gap:8px;padding:8px;border-bottom:1px solid #eef2f7} .logitem:last-child{border-bottom:0}
.log-ts{min-width:130px;color:#6b7280;font-size:12px}
.badge{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid #e2e8f0;background:#f8fafc}
.badge.stop{background:#ffe4e6;border-color:#fecdd3;color:#7f1d1d}
.badge.rep{background:#ede9fe;border-color:#ddd6fe;color:#4c1d95}
.badge.note{background:#dbeafe;border-color:#bfdbfe;color:#1e3a8a}
.legend{display:flex;gap:10px;flex-wrap:wrap} .legend .dotl{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
.l-stop{background:#ef4444}.l-rep{background:#8b5cf6}.l-note{background:#3b82f6}
@media (max-width:900px){.row{display:block}}
</style>
</head>
<body>
<div class="topbar"><span class="statuspill"><span id="dot" class="dot"></span><span id="statxt">Kører normalt</span></span></div>

<div class="container">

  <!-- Aktivitet øverst -->
  <div class="card">
    <h3>Aktivitet – sidste 8 timer</h3>
    <svg class="activity" id="activity8h" viewBox="0 0 920 120"></svg>
    <div class="hint">Røde felter = registrerede stop. Højre kant er “nu”.</div>
  </div>

  <!-- Knapper + inline panel-holder -->
  <div class="card">
    <div class="row" style="align-items:center;gap:10px">
      <div class="timer" style="min-width:160px"><small>Aktuelt stop</small><span id="liveTimer">—</span></div>
      <div class="row" style="gap:8px">
        <button id="btn-open-stop" class="btn btn-primary">Registrér stop</button>
        <button id="btn-open-rep" class="btn">Opret rep-seddel</button>
        <button id="btn-open-note" class="btn">Tilføj note</button>
      </div>
      <div style="margin-left:auto">
        <button id="btn-start" class="btn btn-success" disabled>Start (afslut stop)</button>
      </div>
    </div>
    <div id="inlinePanels"></div>
  </div>

  <!-- Basisoplysninger (kompakt) -->
  <div class="card card-compact sm">
    <h3 style="margin-bottom:4px">Basisoplysninger</h3>
    <div class="row">
      <div class="field" style="min-width:220px">
        <label>Linje / maskine</label>
        <select id="line">
          <option value="">— Vælg —</option>
          <option>L10 75 t Rhodes special presse</option>
          <option>L11 Mech RF135 serie nr 18-11 Mnr888</option>
          <option>L13 Press Beutler PD 40</option>
          <option>L14 50 t Flexo C50 S20 presse</option>
          <option>L15 30 t Flexo C30 S15 presse</option>
          <option>L16 40 t Schuler PNH 40/250 presse</option>
          <option>L17 30 t Flexo C30 S15 presse</option>
          <option>L20 50 t Bliss 50F MKII presse</option>
          <option>L22 50 t Bliss 50F MKII presse</option>
          <option>L23 45 t Bliss 21½ presse</option>
          <option>L24 30 t Flexo C30 S15</option>
          <option>L25 30 t Flexo C30 X presse</option>
          <option>L26 L 36 30 t Flexo C30 S 15 presse</option>
          <option>L27 45 t Bliss 21½ presse</option>
          <option>L28 50 t Flexo presse</option>
          <option>L29 30 t Flexo C30 presse</option>
          <option>L30 ny presse 2012</option>
          <option>L33 50 t Bliss 50F MKII presse</option>
          <option>L34 50 t Bliss 50F MKII presse</option>
          <option>L35 30 t Flexo C30 S15 presse</option>
          <option>L36 30 t Flexo C30 S15 presse Picop</option>
          <option>L40 50 t Flexo C50 S20 presse</option>
          <option>L41 L37, 50 t Bliss 50F MKII presse</option>
          <option>L42 Press Beutler PD 40 alu spez638</option>
          <option>L43 Press Beutler PD 40 alu spez637</option>
          <option>L80 Choko-kapsler</option>
          <option>L81 Lys-manchetter</option>
          <option>L82 Lys-manchetter</option>
        </select>
      </div>
      <div class="field"><label>Ordre nr.</label><input id="orderNo" type="text"></div>
      <div class="field"><label>Vare nr.</label><input id="itemNo" type="text"></div>
      <div class="field"><label>Værktøjs nr.</label><input id="toolNo" type="text" placeholder="fx 1234-AB"></div>
      <div class="field"><label>Operatør</label><input id="operator" type="text" placeholder="Navn/initialer"></div>
      <div class="field"><label>&nbsp;</label><button id="btn-clear-order" class="btn btn-xs">Ryd ordre/varenr</button></div>
      <div class="field"><label>&nbsp;</label><button id="btn-clear-line" class="btn btn-xs">Ryd linje/værktøj/navn</button></div>
    </div>
    <div class="hint">Alt gemmes i browseren og bevares ved refresh.</div>
  </div>

  <!-- Registreringer nederst -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3>Registreringer</h3>
      <div class="legend">
        <span><span class="dotl l-stop"></span>Stop</span>
        <span><span class="dotl l-rep"></span>Rep-seddel</span>
        <span><span class="dotl l-note"></span>Note</span>
      </div>
      <div style="margin-left:auto"><button id="btn-clear-all" class="btn btn-xs btn-danger">Ryd alle</button></div>
    </div>
    <ul id="mixList" class="loglist"></ul>
  </div>

</div>

<script>
/* ====== HELPER (ES5/Edge) ====== */
function $(id){return document.getElementById(id)}
function show(el){if(el) el.style.display=''}
function hide(el){if(el) el.style.display='none'}
function pad(n){return (n<10?'0':'')+n}
function fmtDate(d){var dt=(d instanceof Date)?d:new Date(d);try{return dt.toLocaleString('da-DK')}catch(e){return dt.toString()}}
function fmtDur(ms){var s=Math.floor((ms||0)/1000),h=pad(Math.floor(s/3600)),m=pad(Math.floor((s%3600)/60)),ss=pad(s%60);return h+':'+m+':'+ss}
function uuid(){return 'id-'+Date.now()+'-'+Math.floor(Math.random()*1e6)}
function loadJSON(k,def){try{var v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}}
function saveJSON(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}

/* ====== KEYS ====== */
var KEY_EVENTS='pp.events.v1';
var KEY_NOTES='pp.notes.v1';
var KEY_SETTINGS='pp.settings.v1';
var KEY_CURRENT='pp.current.v1';
var KEY_FEED='pp.feed.v1';

/* ====== STATE ====== */
var IS_STOPPED=false, STOP_START_ISO=null, stopMeta=null, TICK=null;

/* ====== ENDPOINTS (RET disse til dine PA flows) ====== */
var ENDPOINT_EVENT="https://<din-flow-url>/event";
var ENDPOINT_REP  ="https://<din-flow-url>/rep";
var ENDPOINT_NOTE ="https://<din-flow-url>/note";

/* ====== BASICS ====== */
var ui={
  act:$('activity8h'), mix:$('mixList'), inline:$('inlinePanels'),
  dot:$('dot'), stat:$('statxt'), timer:$('liveTimer'),
  line:$('line'), order:$('orderNo'), item:$('itemNo'), tool:$('toolNo'), oper:$('operator')
};
function settings(){return loadJSON(KEY_SETTINGS,{})}
function saveSettings(s){saveJSON(KEY_SETTINGS,s)}
function syncBasics(){var s=settings(); s.line=ui.line.value||''; s.order=ui.order.value||''; s.item=ui.item.value||''; s.tool=ui.tool.value||''; s.oper=ui.oper.value||''; saveSettings(s)}
function restoreBasics(){var s=settings(); if(s.line)ui.line.value=s.line; if(s.order)ui.order.value=s.order; if(s.item)ui.item.value=s.item; if(s.tool)ui.tool.value=s.tool; if(s.oper)ui.oper.value=s.oper}

/* ====== DATA ====== */
function events(){return loadJSON(KEY_EVENTS,[])} function saveEvents(x){saveJSON(KEY_EVENTS,x)}
function notes(){return loadJSON(KEY_NOTES,[])} function saveNotes(x){saveJSON(KEY_NOTES,x)}
function currentStop(){return loadJSON(KEY_CURRENT,null)} function saveCurrent(o){saveJSON(KEY_CURRENT,o)} function clearCurrent(){localStorage.removeItem(KEY_CURRENT)}

/* ====== STATUS/TIMER ====== */
function setStatus(st){IS_STOPPED=st; $('btn-start').disabled=!st; ui.dot.className=st?'dot stop':'dot'; ui.stat.innerHTML=st?'Stop aktivt':'Kører normalt'; ui.timer.innerHTML=st?'00:00:00':'—'}
function tick(){if(!IS_STOPPED)return; var ms=Date.now()-new Date(STOP_START_ISO); ui.timer.innerHTML=fmtDur(ms); renderActivity(); renderList()}

/* ====== AKTIVITET ====== */
function renderActivity(){
  var svg=ui.act; if(!svg) return; svg.innerHTML='';
  var W=920,H=120,m={l:40,r:10,t:18,b:18},w=W-m.l-m.r,h=H-m.t-m.b;
  var now=new Date(), start=new Date(now.getTime()-8*3600*1000);
  function xPos(t){return m.l+Math.max(0,Math.min(w,((t-start)/(8*3600*1000))*w))}
  var bg=document.createElementNS('http://www.w3.org/2000/svg','rect'); bg.setAttribute('x',m.l);bg.setAttribute('y',m.t);bg.setAttribute('width',w);bg.setAttribute('height',h);bg.setAttribute('class','runbg');svg.appendChild(bg);
  var i; for(i=0;i<=8;i++){var x=m.l+(w*(i/8)); var ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',x);ln.setAttribute('y1',m.t);ln.setAttribute('x2',x);ln.setAttribute('y2',m.t+h);ln.setAttribute('class','gridline');svg.appendChild(ln);
    var t=document.createElementNS('http://www.w3.org/2000/svg','text'); var dt=new Date(start.getTime()+i*3600*1000); t.setAttribute('x',x+2);t.setAttribute('y',H-4);t.setAttribute('class','label');t.textContent=pad(dt.getHours())+':00'; svg.appendChild(t);
    if(i<8){var xh=x+(w/8)/2, ln2=document.createElementNS('http://www.w3.org/2000/svg','line'); ln2.setAttribute('x1',xh); ln2.setAttribute('y1',m.t); ln2.setAttribute('x2',xh); ln2.setAttribute('y2',m.t+h); ln2.setAttribute('class','gridline sub'); svg.appendChild(ln2);}
  }
  var rows=events(), stops=[]; for(i=0;i<rows.length;i++){var r=rows[i]; if(!r.end) continue; var s=new Date(r.start), e=new Date(r.end); if(e<start||s>now) continue; var cs=Math.max(s.getTime(),start.getTime()), ce=Math.min(e.getTime(),now.getTime()); stops.push([cs,ce])}
  if(IS_STOPPED && STOP_START_ISO){var s2=Math.max(new Date(STOP_START_ISO).getTime(),start.getTime()), e2=now.getTime(); if(e2>s2) stops.push([s2,e2])}
  for(i=0;i<stops.length;i++){var xs=xPos(stops[i][0]), xe=xPos(stops[i][1]), rr=document.createElementNS('http://www.w3.org/2000/svg','rect'); rr.setAttribute('x',xs); rr.setAttribute('y',m.t+6); rr.setAttribute('width',Math.max(1,xe-xs)); rr.setAttribute('height',h-12); rr.setAttribute('class','stop'); svg.appendChild(rr)}
  var xnow=xPos(now), nowLn=document.createElementNS('http://www.w3.org/2000/svg','line'); nowLn.setAttribute('x1',xnow); nowLn.setAttribute('y1',m.t-2); nowLn.setAttribute('x2',xnow); nowLn.setAttribute('y2',m.t+h+2); nowLn.setAttribute('class','now'); svg.appendChild(nowLn);
}

/* ====== LISTE (samlet og sorteret) ====== */
function renderList(){
  var list=$('mixList'); list.innerHTML='';
  var ev=events().slice(), ns=notes().slice();
  // hvis stop har rep, vis separat rep-linje
  var i; for(i=0;i<ev.length;i++){ if(ev[i].rep){ ns.push({id:'rep-'+ev[i].id, ts:ev[i].end, kind:'rep', fromStop:ev[i].id, priority:ev[i].rep.priority, type:ev[i].rep.type, description:ev[i].rep.description}); } }
  var combined=[];
  for(i=0;i<ev.length;i++){ combined.push({kind:'stop', ts:ev[i].start, item:ev[i]}); }
  for(i=0;i<ns.length;i++){ combined.push({kind:(ns[i].kind||'note'), ts:ns[i].ts||ns[i].date||new Date().toISOString(), item:ns[i]}); }
  combined.sort(function(a,b){return new Date(b.ts)-new Date(a.ts)});
  for(i=0;i<combined.length;i++){
    var k=combined[i].kind, it=combined[i].item, li=document.createElement('li'); li.className='logitem';
    if(k==='stop'){
      var r=it;
      li.innerHTML='<div class="log-ts">'+fmtDate(r.start)+'</div><div><span class="badge stop">Stop</span> '+((r.reason&&r.reason.code)||'-')+' – '+((r.reason&&r.reason.label)||'')+
                   ' · <span class="hint">'+fmtDur(r.durationMs||0)+'</span>'+
                   '<div class="hint">Linje: '+(r.line||'-')+' · Ordre: '+(r.orderNo||'-')+' · Vare: '+(r.itemNo||'-')+(r.comment?(' · '+r.comment):'')+'</div>'+
                   '<div style="margin-top:4px"><button class="btn btn-xs" data-edit-stop="'+r.id+'">Redigér</button></div></div>';
    }else if(k==='rep'){
      li.innerHTML='<div class="log-ts">'+fmtDate(it.ts)+'</div><div><span class="badge rep">Rep</span> '+(it.type||'')+' · '+(it.priority||'')+
                   '<div class="hint">'+(it.description||'')+'</div>'+
                   '<div style="margin-top:4px"><button class="btn btn-xs" data-edit-rep="'+(it.fromStop||'')+'">Redigér</button></div></div>';
    }else{
      li.innerHTML='<div class="log-ts">'+fmtDate(it.ts)+'</div><div><span class="badge note">Note</span> '+(it.text||'')+
                   '<div class="hint">'+[(it.line||'-'),(it.order||it.orderNo||'-'),(it.item||it.itemNo||'-')].join(' · ')+'</div>'+
                   '<div style="margin-top:4px"><button class="btn btn-xs" data-edit-note="'+it.id+'">Redigér</button></div></div>';
    }
    list.appendChild(li);
  }
  // bind edit
  var btns=list.getElementsByTagName('button'), b;
  for(b=0;b<btns.length;b++){
    (function(btn){
      if(btn.getAttribute('data-edit-stop')) btn.onclick=function(){ openStopPanel(btn.getAttribute('data-edit-stop')); };
      if(btn.getAttribute('data-edit-rep'))  btn.onclick=function(){ openRepPanel(btn.getAttribute('data-edit-rep')); };
      if(btn.getAttribute('data-edit-note')) btn.onclick=function(){ editNote(btn.getAttribute('data-edit-note')); };
    })(btns[b]);
  }
}

/* ====== INLINE PANELS ====== */
function clearInline(){ $('inlinePanels').innerHTML=''; }

/* simple liste over fejlkoder */
var REASONS=[ // (code,label)
  ['PRES','Presse'],['VAERK','Værktøj'],['STAK','Stakker'],['FOLIE','Manglende folie'],['ORDRE','Manglende ordre'],['ANDET','Andet']
];

function openStopPanel(editId){
  clearInline();
  var wrap=document.createElement('div'); wrap.className='card'; wrap.style.marginTop='10px';
  wrap.innerHTML='' +
    '<h3>'+ (editId?'Redigér stop':'Registrér stop') +'</h3>'+
    '<div class="row sm">'+
      '<div class="field"><label>Fejlkode</label><select id="r-code"></select></div>'+
      '<div class="field"><label>Beskrivelse (kort)</label><input id="r-label" type="text" placeholder="fx Opsætning, Skift, Slid…"></div>'+
    '</div>'+
    '<div class="field"><label>Uddybning / Kommentar</label><textarea id="r-comment"></textarea></div>'+
    '<div class="sep"></div>'+
    '<div class="row sm">'+
      '<div class="field"><label>Bagkant – start</label><input id="back-start" type="datetime-local"></div>'+
      '<div class="field"><label>Bagkant – slut</label><input id="back-end" type="datetime-local"></div>'+
    '</div>'+
    '<div class="sep"></div>'+
    '<div class="row sm">'+
      '<div class="field"><label>Rep-seddel (valgfri)</label><select id="rep-on"><option value="no">Nej</option><option value="yes">Ja, vedhæft rep</option></select></div>'+
      '<div class="field"><label>Prioritet</label><select id="rep-pri"><option>Lav</option><option>Mellem</option><option>Høj</option><option>Kritisk</option></select></div>'+
      '<div class="field"><label>Fejltype</label><input id="rep-type" type="text"></div>'+
    '</div>'+
    '<div class="field"><label>Rep-beskrivelse</label><textarea id="rep-desc" placeholder="Hvis rep er valgt"></textarea></div>'+
    '<div class="row" style="justify-content:flex-end;gap:8px">'+
      '<button id="stop-cancel" class="btn">Luk</button>'+
      '<button id="stop-confirm" class="btn '+(editId?'btn-primary':'btn-danger')+'">'+(editId?'Gem ændringer':'Bekræft stop')+'</button>'+
    '</div>';
  $('inlinePanels').appendChild(wrap);

  // udfyld fejlkodeliste
  var rc=$('r-code'), i; for(i=0;i<REASONS.length;i++){ var o=document.createElement('option'); o.value=REASONS[i][0]; o.text=REASONS[i][0]+' – '+REASONS[i][1]; rc.appendChild(o); }

  var editing=null;
  if(editId){
    var arr=events(), j; for(j=0;j<arr.length;j++){ if(arr[j].id===editId){ editing=arr[j]; break; } }
    if(editing){
      $('r-code').value=(editing.reason&&editing.reason.code)||'ANDET';
      $('r-label').value=(editing.reason&&editing.reason.label)||'';
      $('r-comment').value=editing.comment||'';
      if(editing.start) $('back-start').value=editing.start.substring(0,16);
      if(editing.end)   $('back-end').value=editing.end.substring(0,16);
      if(editing.rep){ $('rep-on').value='yes'; $('rep-pri').value=editing.rep.priority||'Mellem'; $('rep-type').value=editing.rep.type||''; $('rep-desc').value=editing.rep.description||''; }
    }
  }

  $('stop-cancel').onclick=function(){ clearInline(); };
  $('stop-confirm').onclick=function(){
    if(!(ui.order.value||'').trim() || !(ui.item.value||'').trim()){ alert('Udfyld Ordre og Vare nr.'); return }
    var reason={code:$('r-code').value, label:($('r-label').value||REASONS[0][1])};
    var comment=($('r-comment').value||'').trim();
    var rep=null; if($('rep-on').value==='yes'){ rep={priority:$('rep-pri').value||'Mellem', type:$('rep-type').value||'', description:$('rep-desc').value||''}; }
    var bS=$('back-start').value, bE=$('back-end').value;

    if(editId && editing){
      editing.reason=reason; editing.comment=comment; if(rep) editing.rep=rep; else delete editing.rep;
      if(bS) editing.start=new Date(bS).toISOString(); if(bE){ editing.end=new Date(bE).toISOString(); editing.durationMs=(new Date(editing.end)-new Date(editing.start)); }
      var all=events(), idx=-1; for(var k=0;k<all.length;k++){ if(all[k].id===editing.id){ idx=k; break; } } if(idx>=0){ all[idx]=editing; saveEvents(all); }
      clearInline(); renderActivity(); renderList(); return;
    }

    if(bS && bE){ // bagkant
      var row={ id:uuid(), start:new Date(bS).toISOString(), end:new Date(bE).toISOString(), durationMs:(new Date(bE)-new Date(bS)),
        line:ui.line.value||'', operator:ui.oper.value||'', orderNo:ui.order.value||'', itemNo:ui.item.value||'', reason:reason, comment:comment };
      if(rep){ row.rep=rep; queueRep({id:row.id,end:row.end,line:row.line,orderNo:row.orderNo,itemNo:row.itemNo,operator:row.operator,rep:rep}); }
      var arr2=events(); arr2.push(row); saveEvents(arr2); queueStop(row); clearInline(); renderActivity(); renderList(); return;
    }

    // aktivt stop
    stopMeta={reason:reason, comment:comment, rep:rep};
    STOP_START_ISO=new Date().toISOString(); setStatus(true); if(TICK)clearInterval(TICK); TICK=setInterval(tick,1000); tick(); clearInline();
    saveCurrent({start:STOP_START_ISO, meta:stopMeta});
  };
}

function openRepPanel(fromStopId){
  clearInline();
  var wrap=document.createElement('div'); wrap.className='card'; wrap.style.marginTop='10px';
  wrap.innerHTML='' +
    '<h3>'+(fromStopId?'Redigér rep-seddel':'Opret rep-seddel uden stop')+'</h3>'+
    '<div class="row sm">'+
      '<div class="field"><label>Prioritet</label><select id="rep-pri"><option>Lav</option><option>Mellem</option><option>Høj</option><option>Kritisk</option></select></div>'+
      '<div class="field"><label>Fejltype</label><input id="rep-type" type="text"></div>'+
    '</div>'+
    '<div class="field"><label>Beskrivelse</label><textarea id="rep-desc"></textarea></div>'+
    '<div class="row" style="justify-content:flex-end;gap:8px"><button id="rep-cancel" class="btn">Luk</button><button id="rep-confirm" class="btn btn-primary">'+(fromStopId?'Gem':'Send')+'</button></div>';
  $('inlinePanels').appendChild(wrap);
  $('rep-cancel').onclick=function(){ clearInline(); };

  var editingStop=null;
  if(fromStopId){
    var ev=events(), i; for(i=0;i<ev.length;i++){ if(ev[i].id===fromStopId){ editingStop=ev[i]; break; } }
    if(editingStop && editingStop.rep){ $('rep-pri').value=editingStop.rep.priority||'Mellem'; $('rep-type').value=editingStop.rep.type||''; $('rep-desc').value=editingStop.rep.description||''; }
  }

  $('rep-confirm').onclick=function(){
    var rep={priority:$('rep-pri').value||'Mellem', type:$('rep-type').value||'', description:($('rep-desc').value||'')};
    if(fromStopId && editingStop){ editingStop.rep=rep; var arr=events(), idx=-1; for(var k=0;k<arr.length;k++){ if(arr[k].id===editingStop.id){ idx=k; break; } } if(idx>=0){ arr[idx]=editingStop; saveEvents(arr); } clearInline(); renderList(); return; }
    // uden stop
    var id='rep-'+uuid(), ts=new Date().toISOString();
    var n={id:id, ts:ts, kind:'rep', priority:rep.priority, type:rep.type, description:rep.description, line:ui.line.value||'', order:ui.order.value||'', item:ui.item.value||''};
    var ns=notes(); ns.push(n); saveNotes(ns);
    queueRep({id:id,end:ts,line:ui.line.value||'',orderNo:ui.order.value||'',itemNo:ui.item.value||'',operator:ui.oper.value||'',rep:rep});
    clearInline(); renderList();
  };
}

function openNotePanel(){
  clearInline();
  var wrap=document.createElement('div'); wrap.className='card'; wrap.style.marginTop='10px';
  wrap.innerHTML='<h3>Tilføj note</h3><div class="field"><label>Bemærkning</label><textarea id="note-text"></textarea></div>'+
                 '<div class="row" style="justify-content:flex-end;gap:8px"><button id="note-cancel" class="btn">Luk</button><button id="note-confirm" class="btn btn-primary">Gem note</button></div>';
  $('inlinePanels').appendChild(wrap);
  $('note-cancel').onclick=function(){ clearInline(); };
  $('note-confirm').onclick=function(){
    var txt=($('note-text').value||'').trim(); if(!txt) return;
    var n={id:uuid(), ts:new Date().toISOString(), text:txt, line:ui.line.value||'', order:ui.order.value||'', item:ui.item.value||'', oper:ui.oper.value||''};
    var ns=notes(); ns.unshift(n); saveNotes(ns); queueNote(n); clearInline(); renderList();
  };
}
function editNote(id){
  var ns=notes(), i,n=null; for(i=0;i<ns.length;i++){ if(ns[i].id===id){ n=ns[i]; break; } }
  if(!n) return;
  clearInline();
  var wrap=document.createElement('div'); wrap.className='card'; wrap.style.marginTop='10px';
  wrap.innerHTML='<h3>Redigér note</h3><div class="field"><label>Bemærkning</label><textarea id="note-text">'+(n.text||'')+'</textarea></div>'+
                 '<div class="row" style="justify-content:flex-end;gap:8px"><button id="note-cancel" class="btn">Luk</button><button id="note-confirm" class="btn btn-primary">Gem</button></div>';
  $('inlinePanels').appendChild(wrap);
  $('note-cancel').onclick=function(){ clearInline(); };
  $('note-confirm').onclick=function(){ n.text=$('note-text').value||''; saveNotes(ns); clearInline(); renderList(); };
}

/* ====== SEND/QUEUE ====== */
function postJSON(url,payload){ if(!url||url.indexOf('http')!==0) return; try{var x=new XMLHttpRequest(); x.open('POST',url,true); x.setRequestHeader('Content-Type','application/json;charset=UTF-8'); x.onreadystatechange=function(){}; x.send(JSON.stringify(payload)); }catch(e){} }
function queueStop(r){ var f=loadJSON(KEY_FEED,[]); f.push({type:'stop',sent:false,id:r.id,start:r.start,end:r.end,durationMs:r.durationMs,line:r.line,order:r.orderNo,item:r.itemNo,operator:r.operator,reason:r.reason,comment:r.comment}); saveJSON(KEY_FEED,f); }
function queueRep(o){ var f=loadJSON(KEY_FEED,[]); f.push({type:'rep',sent:false,id:o.id||('rep-'+uuid()),ts:o.end,line:o.line,order:o.orderNo,item:o.itemNo,operator:o.operator,priority:o.rep.priority,type:o.rep.type,description:o.rep.description}); saveJSON(KEY_FEED,f); }
function queueNote(n){ var f=loadJSON(KEY_FEED,[]); f.push({type:'note',sent:false,id:n.id,ts:n.ts,line:n.line,order:n.order||n.orderNo,item:n.item||n.itemNo,operator:n.oper||n.operator,text:n.text}); saveJSON(KEY_FEED,f); }
function resendQueued(){
  var f=loadJSON(KEY_FEED,[]), ch=false, i;
  for(i=0;i<f.length;i++){ var r=f[i]; if(r.sent) continue;
    if(r.type==='stop'){ postJSON(ENDPOINT_EVENT,{id:r.id,start:r.start,end:r.end,duration_ms:r.durationMs,line:r.line,order:r.order,item:r.item,operator:r.operator,cause_code:(r.reason&&r.reason.code)||'',cause_label:(r.reason&&r.reason.label)||'',comment:r.comment||''}); r.sent=true; ch=true; }
    if(r.type==='rep'){ postJSON(ENDPOINT_REP,{id:r.id,ts:r.ts,line:r.line,order:r.order,item:r.item,operator:r.operator,priority:r.priority,type:r.type,description:r.description}); r.sent=true; ch=true; }
    if(r.type==='note'){ postJSON(ENDPOINT_NOTE,{id:r.id,ts:r.ts,line:r.line,order:r.order,item:r.item,operator:r.operator,text:r.text}); r.sent=true; ch=true; }
  }
  if(ch) saveJSON(KEY_FEED,f);
}

/* ====== INIT ====== */
window.addEventListener('DOMContentLoaded', function(){
  restoreBasics(); renderActivity(); renderList();
  var cur=currentStop(); if(cur&&cur.start){ STOP_START_ISO=cur.start; stopMeta=cur.meta||null; setStatus(true); if(TICK)clearInterval(TICK); TICK=setInterval(tick,1000); tick(); }

  ui.line.onchange=syncBasics; ui.order.oninput=syncBasics; ui.item.oninput=syncBasics; ui.tool.oninput=syncBasics; ui.oper.oninput=syncBasics;
  $('btn-clear-order').onclick=function(){ ui.order.value=''; ui.item.value=''; syncBasics(); };
  $('btn-clear-line').onclick=function(){ ui.line.value=''; ui.tool.value=''; ui.oper.value=''; syncBasics(); };

  $('btn-open-stop').onclick=function(){ openStopPanel(); };
  $('btn-open-rep').onclick=function(){ openRepPanel(); };
  $('btn-open-note').onclick=function(){ openNotePanel(); };

  $('btn-start').onclick=function(){
    if(!IS_STOPPED) return;
    var add=confirm('Vil du tilføje hvad der er gjort?'); if(add){ var done=prompt('Hvad blev gjort?')||''; if(stopMeta){ stopMeta.comment=(stopMeta.comment?stopMeta.comment+' | ':'')+'GJORT: '+done; } }
    var end=new Date(), start=new Date(STOP_START_ISO), dur=end-start;
    var row={ id:uuid(), start:start.toISOString(), end:end.toISOString(), durationMs:dur, line:ui.line.value||'', operator:ui.oper.value||'', orderNo:ui.order.value||'', itemNo:ui.item.value||'', reason:stopMeta?stopMeta.reason:null, comment:stopMeta?stopMeta.comment:'' };
    if(stopMeta && stopMeta.rep){ row.rep=stopMeta.rep; queueRep({id:row.id,end:row.end,line:row.line,orderNo:row.orderNo,itemNo:row.itemNo,operator:row.operator,rep:row.rep}); }
    var arr=events(); arr.push(row); saveEvents(arr); queueStop(row);
    setStatus(false); STOP_START_ISO=null; stopMeta=null; if(TICK){clearInterval(TICK); TICK=null;} clearCurrent(); renderActivity(); renderList();
  };

  $('btn-clear-all').onclick=function(){
    if(!confirm('Slet alle lokale registreringer (stop/rep/note)?')) return;
    saveEvents([]); saveNotes([]); renderActivity(); renderList();
  };

  resendQueued(); setInterval(resendQueued,5*60*1000);
});
</script>
</body>
</html>
