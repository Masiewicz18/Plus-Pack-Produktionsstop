<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Plus Pack – Produktionsstop (Edge-kompatibel)</title>
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{margin:0;font-family:Segoe UI,Arial,Helvetica,sans-serif;background:#f4f6f9;color:#0f172a}
.topbar{background:#0a61ae;color:#fff;padding:8px 12px;font-weight:800}
.statuspill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.35);border-radius:999px;padding:4px 10px;background:rgba(255,255,255,.08)}
.dot{width:10px;height:10px;border-radius:999px;background:#17833e}
.dot.stop{background:#dc2626}
.container{max-width:1180px;margin:0 auto;padding:12px}
.card{background:#fff;border:1px solid #e6ecf3;border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(15,23,42,.06);margin-bottom:10px}
h3{margin:0 0 6px}
label{font-size:11px;color:#6b7280;display:block;margin-bottom:3px}
input,select,textarea{width:100%;border:1px solid #dfe7f2;border-radius:10px;padding:8px 10px;background:#fff;font-size:14px;line-height:1.2}
textarea{min-height:72px}
.row{display:flex;flex-wrap:wrap;gap:8px}
.sm .field{flex:1 1 220px}
.field{margin-bottom:8px}
.hint{font-size:12px;color:#6b7280}
.sep{height:1px;background:#e6ecf3;margin:8px 0}

  .btn{border:1px solid #dbe4ef;background:#fff;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer;font-size:14px}
.btn:disabled{opacity:.55;cursor:not-allowed}
.btn-primary{background:#e8f1ff;border-color:#cfe2ff;color:#0a3d91}
.btn-danger{background:#fff1f1;border-color:#f3b3b3;color:#7f1d1d}
.btn-success{background:#ebfff2;border-color:#b7e6c7;color:#0b5a3c}
.timer{font:700 34px/1.1 ui-monospace,Consolas,monospace}
.timer small{display:block;font:600 11px/1 Segoe UI,Arial;color:#6b7280;margin-bottom:3px}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #dbe4ef;background:#f5f9ff;border-radius:999px;padding:6px 8px;font-size:13px;cursor:pointer}
.chip input{width:16px;height:16px}
.activity{width:100%;height:120px}
.activity .gridline{stroke:#e5e7eb;stroke-width:1}.activity .gridline.sub{opacity:.5}
.activity .now{stroke:#0a61ae;stroke-width:2}
.activity .runbg{fill:rgba(16,185,129,.06)} .activity .label{fill:#475569;font-size:10px}
.activity .stop{fill:rgba(220,38,38,.28);stroke:#dc2626;stroke-width:1}
.loglist{list-style:none;margin:0;padding:0;border:1px dashed #dbe4ef;border-radius:10px;background:#fff;max-height:320px;overflow:auto}
.logitem{display:flex;gap:8px;padding:8px;border-bottom:1px solid #eef2f7}
.logitem:last-child{border-bottom:0}
.log-ts{min-width:130px;color:#6b7280;font-size:12px}
.badge{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid #e2e8f0;background:#f8fafc}
.badge.stop{background:#ffe4e6;border-color:#fecdd3;color:#7f1d1d}
.badge.rep{background:#ede9fe;border-color:#ddd6fe;color:#4c1d95}
.badge.note{background:#dbeafe;border-color:#bfdbfe;color:#1e3a8a}
.legend{display:flex;gap:10px;flex-wrap:wrap}
.legend .dotl{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:6px}
.l-stop{background:#ef4444}.l-rep{background:#8b5cf6}.l-note{background:#3b82f6}
@media (max-width:900px){.row{display:block}}
</style>
</head>
<body>
<div class="topbar">
  <span class="statuspill"><span id="dot" class="dot"></span><span id="statxt">Kører normalt</span></span>
</div>
<div class="container">
  <div class="card sm">
    <h3>Basisoplysninger</h3>
    <div class="row">
      <div class="field"><label>Linje / maskine</label>
        <select id="line">
          <option value="">— Vælg —</option>
          <option>L10 75 t Rhodes special presse</option>
          <option>L11 Mech RF135 serie nr 18-11 Mnr888</option>
          <option>L13 Press Beutler PD 40</option>
          <option>L14 50 t Flexo C50 S20 presse</option>
          <option>L15 30 t Flexo C30 S15 presse</option>
          <option>L16 40 t Schuler PNH 40/250 presse</option>
          <option>L17 30 t Flexo C30 S15 presse</option>
          <option>L20 50 t Bliss 50F MKII presse</option>
          <option>L22 50 t Bliss 50F MKII presse</option>
          <option>L23 45 t Bliss 21½ presse</option>
          <option>L24 30 t Flexo C30 S15</option>
          <option>L25 30 t Flexo C30 X presse</option>
          <option>L26 L 36 30 t Flexo C30 S 15 presse</option>
          <option>L27 45 t Bliss 21½ presse</option>
          <option>L28 50 t Flexo presse</option>
          <option>L29 30 t Flexo C30 presse</option>
          <option>L30 ny presse 2012</option>
          <option>L33 50 t Bliss 50F MKII presse</option>
          <option>L34 50 t Bliss 50F MKII presse</option>
          <option>L35 30 t Flexo C30 S15 presse</option>
          <option>L36 30 t Flexo C30 S15 presse Picop</option>
          <option>L40 50 t Flexo C50 S20 presse</option>
          <option>L41 L37, 50 t Bliss 50F MKII presse</option>
          <option>L42 Press Beutler PD 40 alu spez638</option>
          <option>L43 Press Beutler PD 40 alu spez637</option>
          <option>L80 Choko-kapsler</option>
          <option>L81 Lys-manchetter</option>
          <option>L82 Lys-manchetter</option>
        </select>
      </div>
      <div class="field"><label>Ordre nr. (krævet)</label><input id="orderNo" type="text"></div>
      <div class="field"><label>Vare nr. (krævet)</label><input id="itemNo" type="text"></div>
      <div class="field"><label>Værktøjs nr.</label><input id="toolNo" type="text" placeholder="fx 1234-AB"></div>
      <div class="field"><label>Operatør (valgfri)</label><input id="operator" type="text" placeholder="Navn/initialer"></div>
      <div class="field"><label>&nbsp;</label><button id="btn-clear-order" class="btn">Ryd ordre/varenr</button></div>
      <div class="field"><label>&nbsp;</label><button id="btn-clear-line" class="btn">Ryd linje/værktøj/navn</button></div>
    </div>
    <div class="hint">Alle felter autogemmes i browseren – også midt i indtastning.</div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center;gap:10px">
      <div class="timer" style="min-width:160px"><small>Aktuelt stop</small><span id="liveTimer">—</span></div>
      <div class="row" style="gap:8px">
        <button id="btn-open-stop" class="btn btn-primary">Registrér stop</button>
        <button id="btn-open-rep" class="btn">Opret rep-seddel</button>
        <button id="btn-open-note" class="btn">Tilføj bemærkning/note</button>
      </div>
      <div style="margin-left:auto">
        <button id="btn-start" class="btn btn-success" disabled>Start (afslut stop)</button>
      </div>
    </div>
    <!-- Inline afslutningsfelt (vises når man trykker Start) -->
    <div id="doneBlock" class="row" style="margin-top:8px;display:none">
      <div class="field" style="flex:1">
        <label>Hvad blev gjort for at løse problemet?</label>
        <textarea id="doneWhat" placeholder="Kort beskrivelse af handlinger (valgfri)"></textarea>
      </div>
      <div class="field" style="align-self:flex-end">
        <button id="doneSave" class="btn btn-success">Gem & afslut</button>
        <button id="doneSkip" class="btn">Spring over</button>
      </div>
    </div>
  </div>
  <div class="card">
    <h3>Aktivitet – sidste 8 timer</h3>
    <svg class="activity" id="activity8h" viewBox="0 0 920 120"></svg>
    <div class="hint">Røde felter = registrerede stop. Højre kant er “nu”.</div>
  </div>
  <div class="card">
    <h3>Registreringer</h3>
    <div class="legend" style="margin:4px 0 8px">
      <span><span class="dotl l-stop"></span>Stop</span>
      <span><span class="dotl l-rep"></span>Rep-seddel</span>
      <span><span class="dotl l-note"></span>Bemærkning/Note</span>
    </div>
    <ul id="mixList" class="loglist"></ul>
  </div>
  <div class="card" id="stopPanel" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3>Registrér stop</h3>
      <div id="stopHint" class="hint">Udfyld Ordre nr. og Vare nr., vælg årsag og bekræft.</div>
    </div>

    <div class="sep"></div>
    <div class="row">
      <div class="field" style="flex:1 1 320px">
        <label>Hurtig udfyldning – seneste 10</label>
        <select id="quick-last">
          <option value="">— Vælg tidligere registrering —</option>
        </select>
      </div>
      <div class="field" style="flex:1 1 320px">
        <label>Skabeloner (egne favoritter)</label>
        <div class="row" style="gap:6px">
          <select id="tpl-select" style="flex:1">
            <option value="">— Vælg skabelon —</option>
          </select>
          <button id="tpl-save" class="btn">Gem skabelon</button>
          <button id="tpl-del" class="btn">Slet skabelon</button>
        </div>
      </div>
    </div>

    <div class="sep"></div>
    <div class="row sm">
      <div class="field" style="flex:1 1 360px">
        <label>Årsag</label>
        <div id="reasonTop" class="chips"></div>
        <div id="reasonMore" class="chips" style="margin-top:6px"></div>
      </div>
      <div class="field" style="flex:1 1 360px">
        <label>Uddybning</label>
        <div id="reasonChips" class="chips"></div>
        <div class="row" style="gap:6px;margin-top:6px">
          <button id="btn-copy-last" class="btn" style="display:none">Kopier sidste for denne årsag</button>
          <button id="btn-clear-detail" class="btn">Ryd felter</button>
        </div>
      </div>
    </div>

    <div class="row sm">
      <div class="field"><label>Andet</label><input id="other" type="text"></div>
      <div class="field"><label>Kommentar</label><input id="comment" type="text"></div>
    </div>

    <div class="sep"></div>
    <div class="row sm">
      <div class="field" style="flex:1 1 240px">
        <label>Registrér på bagkant</label>
        <select id="retro-mode">
          <option value="no">Nej (start nu)</option>
          <option value="yes">Ja (manuelle tider)</option>
        </select>
      </div>
      <div class="field" style="flex:3 1 520px"></div>
    </div>
    <div id="retro-fields" style="display:none">
      <div class="row sm">
        <div class="field"><label>Start (dato/tid)</label><input id="retro-start" type="datetime-local"></div>
        <div class="field"><label>Slut (dato/tid)</label><input id="retro-end" type="datetime-local"></div>
      </div>
      <div class="hint">Brug denne, hvis du glemte at starte/stoppe i realtid.</div>
    </div>

    <div class="row" style="justify-content:flex-end;gap:8px">
      <button id="stop-cancel" class="btn">Annuller</button>
      <button id="stop-confirm" class="btn btn-danger">Bekræft stop</button>
    </div>
  </div>
  <div class="card" id="repPanel" style="display:none">
    <h3>Opret rep-seddel (uafhængigt af stop)</h3>
    <div class="row sm">
      <div class="field"><label>Modtager</label><input id="rep-to" type="email" placeholder="vedligehold@pluspack.com"></div>
      <div class="field"><label>CC</label><input id="rep-cc" type="text" placeholder="valgfri, kommasepareret"></div>
      <div class="field"><label>Prioritet</label><select id="rep-pri"><option>Lav</option><option>Mellem</option><option>Høj</option><option>Kritisk</option></select></div>
      <div class="field"><label>Fejltype</label><input id="rep-type" type="text" placeholder="fx Mekanisk, Elektrisk"></div>
    </div>
    <div class="field"><label>Beskrivelse</label><textarea id="rep-desc" placeholder="Kort og præcis beskrivelse"></textarea></div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button id="rep-cancel" class="btn">Luk</button>
      <button id="rep-create" class="btn btn-primary">Opret rep-seddel</button>
    </div>
  </div>
  <div class="card" id="notePanel" style="display:none">
    <h3>Tilføj bemærkning/note</h3>
    <div class="field"><label>Bemærkning</label><textarea id="note-text" placeholder="Skriv kort note…"></textarea></div>
    <div class="row" style="justify-content:flex-end;gap:8px">
      <button id="note-cancel" class="btn">Luk</button>
      <button id="note-create" class="btn btn-primary">Gem note</button>
    </div>
  </div>
</div> <!-- /container -->
<script>
function $(id){return document.getElementById(id)}
function show(el){if(el) el.style.display=''}
function hide(el){if(el) el.style.display='none'}
function pad(n){return (n<10?'0':'')+n}
function fmtDate(d){var dt=(d instanceof Date)?d:new Date(d);try{return dt.toLocaleString('da-DK')}catch(e){return dt.toString()}}
function fmtDur(ms){var s=Math.floor((ms||0)/1000),h=pad(Math.floor(s/3600)),m=pad(Math.floor((s%3600)/60)),ss=pad(s%60);return h+':'+m+':'+ss}
function uuid(){return 'id-'+Date.now()+'-'+Math.floor(Math.random()*1e6)}
function loadJSON(k,def){try{return JSON.parse(localStorage.getItem(k))||def}catch(e){return def}}
function saveJSON(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}
var KEY_EVENTS='produktionsstop.events.v3';
var KEY_SETTINGS='produktionsstop.settings.v3';
var KEY_CURRENT='produktionsstop.current.v1';
var KEY_TEMPLATES='produktionsstop.templates.v1';
var KEY_NOTES='produktionsstop.notes.v1';
var KEY_FEED='produktionsstop.feed.v1';

var ENDPOINT_EVENT = "https://<din-flow-url>/event";
var ENDPOINT_REP   = "https://<din-flow-url>/rep";
var ENDPOINT_NOTE  = "https://<din-flow-url>/note";

function events(){return loadJSON(KEY_EVENTS,[])}
function saveEvents(x){saveJSON(KEY_EVENTS,x)}
function settings(){return loadJSON(KEY_SETTINGS,{})}
function saveSettings(x){saveJSON(KEY_SETTINGS,x)}
function notes(){return loadJSON(KEY_NOTES,[])}
function saveNotes(x){saveJSON(KEY_NOTES,x)}
function templates(){return loadJSON(KEY_TEMPLATES,[])}
function saveTemplates(x){saveJSON(KEY_TEMPLATES,x)}
function currentStop(){return loadJSON(KEY_CURRENT,null)}
function saveCurrent(o){saveJSON(KEY_CURRENT,o)}
function clearCurrent(){localStorage.removeItem(KEY_CURRENT)}

function postJSON(url,payload){
  if(!url || url.indexOf('http')!==0){ return; }
  try{
    var xhr=new XMLHttpRequest();
    xhr.open('POST',url,true);
    xhr.setRequestHeader('Content-Type','application/json;charset=UTF-8');
    xhr.onreadystatechange=function(){};
    xhr.send(JSON.stringify(payload));
  }catch(e){}
}
var DEFAULT_REASONS=[
  {code:'PRES',label:'Presse',chips:['Rensning','Smøring','Opsætning']},
  {code:'VAERK',label:'Værktøj',chips:['Skift','Slid','Defekt']},
  {code:'STAK' ,label:'Stakker',chips:['Fejl','Opsamler','Andet']},
  {code:'FOLIE',label:'Manglende folie',chips:['Påfyld','Bestilling']},
  {code:'ORDRE',label:'Manglende ordre',chips:['Afventer','Uklar ordre']},
  {code:'ANDET',label:'Andet',chips:['Sikkerhed','Rengøring']}
];
function allReasons(){
  var s=settings(), list=(s.customCauses||[]), map={}, out=[], i;
  for(i=0;i<DEFAULT_REASONS.length;i++) map[DEFAULT_REASONS[i].code]=DEFAULT_REASONS[i];
  for(i=0;i<list.length;i++){ var c=list[i]; map[c.code]={code:c.code,label:c.label,chips:c.chips||[]} }
  for(var k in map) out.push(map[k]);
  out.sort(function(a,b){return a.label.localeCompare(b.label)});
  return out;
}
function getReason(code){var L=allReasons(),i; for(i=0;i<L.length;i++){if(L[i].code===code)return L[i]} return null}

function renderChipsByCode(code){
  var r=getReason(code)||{chips:[]}, html='', i;
  for(i=0;i<r.chips.length;i++) html+='<label class="chip"><input type="checkbox" value="'+r.chips[i]+'">'+r.chips[i]+'</label>';
  $('reasonChips').innerHTML=html;
}
function selectedChips(){
  var nodes=$('reasonChips').getElementsByTagName('input'), out=[], i;
  for(i=0;i<nodes.length;i++){ if(nodes[i].checked) out.push(nodes[i].value) }
  return out;
}
function renderReasons(){
  var list=allReasons(), top=list.slice(0,8), more=list.slice(8), i, html='';
  function mk(r){return '<label class="chip"><input type="radio" name="reasonRadio" value="'+r.code+'"><b>'+r.code+'</b> – '+r.label+'</label>'}
  for(i=0;i<top.length;i++) html+=mk(top[i]); $('reasonTop').innerHTML=html;
  html=''; for(i=0;i<more.length;i++) html+=mk(more[i]); $('reasonMore').innerHTML=html;
  var first=$('reasonTop').querySelector('input[name="reasonRadio"]')||$('reasonMore').querySelector('input[name="reasonRadio"]');
  if(first){ first.checked=true; renderChipsByCode(first.value); maybeShowCopy(first.value); }
  function onChange(e){var t=e.target||e.srcElement; if(t && t.name==='reasonRadio'){ renderChipsByCode(t.value); maybeShowCopy(t.value); }}
  $('reasonTop').onclick=onChange; $('reasonMore').onclick=onChange;
}
function syncBasics(){
  var s=settings();
  s.line=$('line').value||'';
  s.orderNo=$('orderNo').value||'';
  s.itemNo=$('itemNo').value||'';
  s.toolNo=$('toolNo').value||'';
  s.operator=$('operator').value||'';
  saveSettings(s);
}
function restoreBasics(){
  var s=settings();
  if(s.line) $('line').value=s.line;
  if(s.orderNo) $('orderNo').value=s.orderNo;
  if(s.itemNo) $('itemNo').value=s.itemNo;
  if(s.toolNo) $('toolNo').value=s.toolNo;
  if(s.operator) $('operator').value=s.operator;
}

function refreshQuick(){
  var rows=events().slice(-10).reverse(), html='<option value="">— Vælg tidligere registrering —</option>', i;
  for(i=0;i<rows.length;i++){
    var r=rows[i], code=(r.reason&&r.reason.code)||'?', lab=(r.reason&&r.reason.label)||'?';
    html+='<option value="'+r.id+'">'+code+' · '+lab+' · '+(r.comment||'-')+'</option>';
  }
  $('quick-last').innerHTML=html;
}
function applyFromEvent(ev){
  if(!ev) return;
  var radios=document.getElementsByName('reasonRadio'), i, set;
  for(i=0;i<radios.length;i++){ if(radios[i].value===((ev.reason&&ev.reason.code)||'')){ radios[i].checked=true; renderChipsByCode(radios[i].value); break; } }
  set=(ev.detailChips||[]); var nodes=$('reasonChips').getElementsByTagName('input');
  for(i=0;i<nodes.length;i++){ nodes[i].checked=(set.indexOf(nodes[i].value)>=0) }
  $('other').value=ev.other||''; $('comment').value=ev.comment||'';
}
function refreshTemplates(){
  var list=templates(), i, html='<option value="">— Vælg skabelon —</option>';
  for(i=0;i<list.length;i++){ html+='<option value="'+list[i].id+'">'+list[i].name+'</option>' }
  $('tpl-select').innerHTML=html;
}
function captureStopForm(){
  var sel=document.querySelector('input[name="reasonRadio"]:checked'), reason=getReason(sel?sel.value:null)||{code:'ANDET',label:'Andet'};
  return {reason:{code:reason.code,label:reason.label}, detailChips:selectedChips(), other:($('other').value||'').trim(), comment:($('comment').value||'').trim()};
}
function renderActivity(){
  var svg=$('activity8h'); if(!svg) return; svg.innerHTML='';
  var W=920,H=120,m={l:40,r:10,t:18,b:18},w=W-m.l-m.r,h=H-m.t-m.b;
  var now=new Date(), start=new Date(now.getTime()-8*3600*1000);
  function xPos(t){return m.l+Math.max(0,Math.min(w,((t-start)/(8*3600*1000))*w))}
  var bg=document.createElementNS('http://www.w3.org/2000/svg','rect'); bg.setAttribute('x',m.l); bg.setAttribute('y',m.t); bg.setAttribute('width',w); bg.setAttribute('height',h); bg.setAttribute('class','runbg'); svg.appendChild(bg);
  var i; for(i=0;i<=8;i++){ var x=m.l+(w*(i/8)); var ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',x); ln.setAttribute('y1',m.t); ln.setAttribute('x2',x); ln.setAttribute('y2',m.t+h); ln.setAttribute('class','gridline'); svg.appendChild(ln);
    var t=document.createElementNS('http://www.w3.org/2000/svg','text'), dt=new Date(start.getTime()+i*3600*1000); t.setAttribute('x',x+2); t.setAttribute('y',H-4); t.setAttribute('class','label'); t.textContent=pad(dt.getHours())+':00'; svg.appendChild(t);
    if(i<8){var xh=x+(w/8)/2, ln2=document.createElementNS('http://www.w3.org/2000/svg','line'); ln2.setAttribute('x1',xh); ln2.setAttribute('y1',m.t); ln2.setAttribute('x2',xh); ln2.setAttribute('y2',m.t+h); ln2.setAttribute('class','gridline sub'); svg.appendChild(ln2);}
  }
  var rows=events(), stops=[], r,s,e,cs,ce;
  for(i=0;i<rows.length;i++){ r=rows[i]; if(!r.end) continue; s=new Date(r.start); e=new Date(r.end); if(e<start||s>now) continue; cs=Math.max(s.getTime(),start.getTime()); ce=Math.min(e.getTime(),now.getTime()); stops.push([cs,ce]); }
  if(window.IS_STOPPED && window.STOP_START_ISO){ var s2=Math.max(new Date(window.STOP_START_ISO).getTime(),start.getTime()), e2=now.getTime(); if(e2>s2) stops.push([s2,e2]); }
  for(i=0;i<stops.length;i++){ var xs=xPos(stops[i][0]), xe=xPos(stops[i][1]), rr=document.createElementNS('http://www.w3.org/2000/svg','rect'); rr.setAttribute('x',xs); rr.setAttribute('y',m.t+6); rr.setAttribute('width',Math.max(1,xe-xs)); rr.setAttribute('height',h-12); rr.setAttribute('class','stop'); svg.appendChild(rr); }
  var xnow=xPos(now), nowLn=document.createElementNS('http://www.w3.org/2000/svg','line'); nowLn.setAttribute('x1',xnow); nowLn.setAttribute('y1',m.t-2); nowLn.setAttribute('x2',xnow); nowLn.setAttribute('y2',m.t+h+2); nowLn.setAttribute('class','now'); svg.appendChild(nowLn);
}
function renderMixList(){
  var list=$('mixList'); list.innerHTML='';
  var ev=events().slice(); var ns=notes().slice(); var arr=[], i;

  for(i=0;i<ev.length;i++){
    var r=ev[i];
    arr.push({type:'stop', ts: r.end || r.start, data:r});
    if(r.rep){ arr.push({type:'rep', ts: r.end, data:{ related:r.id, rep:r.rep }}); }
  }
  for(i=0;i<ns.length;i++){ arr.push({type:'note', ts: ns[i].ts, data: ns[i]}); }

  arr.sort(function(a,b){ return new Date(b.ts)-new Date(a.ts); });

  for(i=0;i<arr.length;i++){
    var it=arr[i], li=document.createElement('li'); li.className='logitem';
    if(it.type==='stop'){
      var r2=it.data, code=(r2.reason&&r2.reason.code)||'', lab=(r2.reason&&r2.reason.label)||'Stop';
      var extra='Linje: '+(r2.line||'-')+' · Ordre: '+(r2.orderNo||'-')+' · Vare: '+(r2.itemNo||'-')+' · Værktøj: '+(r2.toolNo||'-');
      var doneTxt=r2.doneWhat?(' · Gjort: '+r2.doneWhat):'';
      li.innerHTML='<div class="log-ts">'+fmtDate(r2.start)+'</div><div><span class="badge stop">Stop</span> <b>'+code+'</b> – '+lab+' · <span class="hint">'+fmtDur(r2.durationMs||0)+'</span><div class="hint">'+extra+(r2.comment?(' · '+r2.comment):'')+doneTxt+'</div></div>';
    } else if(it.type==='rep'){
      var rp=it.data.rep;
      li.innerHTML='<div class="log-ts">'+fmtDate(it.ts)+'</div><div><span class="badge rep">Rep</span> '+(rp.type||'')+' · '+(rp.priority||'')+'<div class="hint">'+(rp.description||'')+'</div></div>';
    } else {
      var n=it.data, meta='('+[(n.line||'-'),(n.orderNo||'-'),(n.itemNo||'-')].join(' · ')+')';
      li.innerHTML='<div class="log-ts">'+fmtDate(n.ts)+'</div><div><span class="badge note">Note</span> '+(n.text||'')+' <span class="hint">'+meta+'</span></div>';
    }
    list.appendChild(li);
  }
}
var IS_STOPPED=false, STOP_START_ISO=null, stopMeta=null, TICK=null;

function setStatus(st){
  IS_STOPPED=st; $('btn-start').disabled=!st;
  $('dot').className=st?'dot stop':'dot';
  $('statxt').innerHTML=st?'Stop aktivt':'Kører normalt';
  $('liveTimer').innerHTML=st?'00:00:00':'—';
}
function tick(){
  if(!IS_STOPPED) return;
  var ms=Date.now()-new Date(STOP_START_ISO);
  $('liveTimer').innerHTML=fmtDur(ms);
  renderActivity(); renderMixList();
}

function maybeShowCopy(code){
  var rows=events().filter(function(r){return r.reason&&r.reason.code===code}).sort(function(a,b){return new Date(b.start)-new Date(a.start)});
  var last=rows.length?rows[0]:null;
  if(last){
    $('btn-copy-last').style.display='';
    $('btn-copy-last').onclick=function(){
      $('other').value=last.other||''; $('comment').value=last.comment||'';
      var set=(last.detailChips||[]), nodes=$('reasonChips').getElementsByTagName('input'), i;
      for(i=0;i<nodes.length;i++){ nodes[i].checked=(set.indexOf(nodes[i].value)>=0) }
    };
  } else { $('btn-copy-last').style.display='none'; }
}

function openStopPanel(){ show($('stopPanel')); $('stopHint').innerHTML=''; }
function closeStopPanel(){ hide($('stopPanel')); }

function confirmStop(){
  if(!(($('orderNo').value||'').trim()) || !(($('itemNo').value||'').trim())){ $('stopHint').innerHTML='Udfyld Ordre nr. og Vare nr.'; return; }
  var sel=document.querySelector('input[name="reasonRadio"]:checked'), reason=getReason(sel?sel.value:null)||{code:'ANDET',label:'Andet'};
  stopMeta={ reason:{code:reason.code,label:reason.label}, detailChips:selectedChips(), other:($('other').value||'').trim(), comment:($('comment').value||'').trim() };

  if($('retro-mode').value==='yes'){
    var sVal=$('retro-start').value, eVal=$('retro-end').value;
    if(!sVal||!eVal){ $('stopHint').innerHTML='Vælg både start og slut ved registrering på bagkant.'; return; }
    var s=new Date(sVal), e=new Date(eVal); if(!(s&&e) || e<s){ $('stopHint').innerHTML='Slut skal være efter start.'; return; }
    var row={ id:uuid(), start:s.toISOString(), end:e.toISOString(), durationMs:(e-s),
      line:$('line').value||'', operator:$('operator').value||'', orderNo:$('orderNo').value||'', itemNo:$('itemNo').value||'', toolNo:$('toolNo').value||'',
      reason:stopMeta.reason, detailChips:stopMeta.detailChips, other:stopMeta.other, comment:stopMeta.comment, doneWhat:'' };
    var arr=events(); arr.push(row); saveEvents(arr);

    // send til feed
    var feed=loadJSON(KEY_FEED,[]);
    feed.push({type:'stop',sent:false,id:row.id,start:row.start,end:row.end,durationMs:row.durationMs,
      line:row.line,orderNo:row.orderNo,itemNo:row.itemNo,toolNo:row.toolNo,operator:row.operator,
      reason:row.reason,detailChips:row.detailChips,other:row.other,comment:row.comment});
    saveJSON(KEY_FEED,feed);

    renderActivity(); renderMixList(); refreshQuick();
    closeStopPanel();
    return;
  }

  // realtime
  STOP_START_ISO=new Date().toISOString(); setStatus(true);
  if(TICK)clearInterval(TICK); TICK=setInterval(tick,1000); tick(); closeStopPanel();
  saveCurrent({start:STOP_START_ISO, meta:stopMeta});
}
function showDoneInline(){ $('doneBlock').style.display=''; }
function hideDoneInline(){ $('doneBlock').style.display='none'; $('doneWhat').value=''; }

function finalizeStop(withDone){
  var doneTxt=withDone?($('doneWhat').value||''):'';
  var end=new Date(), start=new Date(STOP_START_ISO), dur=end-start;
  var row={ id:uuid(), start:start.toISOString(), end:end.toISOString(), durationMs:dur,
    line:$('line').value||'', operator:$('operator').value||'', orderNo:$('orderNo').value||'', itemNo:$('itemNo').value||'', toolNo:$('toolNo').value||'',
    reason: stopMeta?stopMeta.reason:null, detailChips: stopMeta?stopMeta.detailChips:[], other: stopMeta?stopMeta.other:'', comment: stopMeta?stopMeta.comment:'', doneWhat:doneTxt };

  var arr=events(); arr.push(row); saveEvents(arr);

  var feed=loadJSON(KEY_FEED,[]);
  feed.push({type:'stop',sent:false,id:row.id,start:row.start,end:row.end,durationMs:row.durationMs,
    line:row.line,orderNo:row.orderNo,itemNo:row.itemNo,toolNo:row.toolNo,operator:row.operator,
    reason:row.reason,detailChips:row.detailChips,other:row.other,comment:row.comment,doneWhat:row.doneWhat});
  saveJSON(KEY_FEED,feed);

  setStatus(false); STOP_START_ISO=null; stopMeta=null; if(TICK){clearInterval(TICK); TICK=null;} clearCurrent();
  hideDoneInline(); renderActivity(); renderMixList(); refreshQuick();
}

function createRepStandalone(){
  var rp={ to:($('rep-to').value||''), cc:($('rep-cc').value||''), priority:($('rep-pri').value||'Mellem'), type:($('rep-type').value||''), description:($('rep-desc').value||'') };
  var now=new Date().toISOString();
  // læg som separat post i feed og liste
  var feed=loadJSON(KEY_FEED,[]); var id='rep-'+uuid();
  feed.push({type:'rep',sent:false,id:id,ts:now,line:$('line').value||'',orderNo:$('orderNo').value||'',itemNo:$('itemNo').value||'',toolNo:$('toolNo').value||'',operator:$('operator').value||'', priority:rp.priority, faultType:rp.type, description:rp.description});
  saveJSON(KEY_FEED,feed);

  // spejl i mix ved pseudo-event (kun til visning)
  var ev=events(); ev.push({ id:'shadow-'+id, start:now, end:now, durationMs:0, line:$('line').value||'', orderNo:$('orderNo').value||'', itemNo:$('itemNo').value||'', toolNo:$('toolNo').value||'', operator:$('operator').value||'', reason:null, rep:rp });
  saveEvents(ev);

  renderMixList();
  hide($('repPanel'));
}

function createNote(){
  var txt=($('note-text').value||'').trim(); if(!txt){return;}
  var n={id:uuid(), ts:new Date().toISOString(), text:txt, line:$('line').value||'', orderNo:$('orderNo').value||'', itemNo:$('itemNo').value||'', toolNo:$('toolNo').value||'', operator:$('operator').value||''};
  var arr=notes(); arr.unshift(n); saveNotes(arr);

  var feed=loadJSON(KEY_FEED,[]);
  feed.push({type:'note',sent:false,id:n.id,ts:n.ts,line:n.line,orderNo:n.orderNo,itemNo:n.itemNo,toolNo:n.toolNo,operator:n.operator,text:n.text});
  saveJSON(KEY_FEED,feed);

  $('note-text').value='';
  hide($('notePanel'));
  renderMixList();
}
function resendQueued(){
  var feed=loadJSON(KEY_FEED,[]), changed=false, i;
  for(i=0;i<feed.length;i++){
    var r=feed[i]; if(r.sent) continue;
    if(r.type==='stop'){
      var payload={ id:r.id,start:r.start,end:r.end,duration_ms:r.durationMs,line:r.line,order:r.orderNo,item:r.itemNo,tool:r.toolNo,operator:r.operator,
        cause_code:(r.reason&&r.reason.code)||'', cause_label:(r.reason&&r.reason.label)||'',
        details:(r.detailChips||[]).join(', '), other:r.other||'', comment:r.comment||'', done:r.doneWhat||'' };
      postJSON(ENDPOINT_EVENT,payload); r.sent=true; changed=true;
    } else if(r.type==='rep'){
      var payloadR={ id:r.id, ts:r.ts||null, line:r.line, order:r.orderNo, item:r.itemNo, tool:r.toolNo, operator:r.operator, priority:r.priority, type:r.faultType, description:r.description };
      postJSON(ENDPOINT_REP,payloadR); r.sent=true; changed=true;
    } else if(r.type==='note'){
      var payloadN={ id:r.id, ts:r.ts||null, line:r.line, order:r.orderNo, item:r.itemNo, tool:r.toolNo, operator:r.operator, text:r.text };
      postJSON(ENDPOINT_NOTE,payloadN); r.sent=true; changed=true;
    }
  }
  if(changed) saveJSON(KEY_FEED,feed);
}

// autosave under skrivning (basis + stopfelter + note/rep)
function bindAutosaveInputs(){
  var ids=['line','orderNo','itemNo','toolNo','operator'];
  var i; for(i=0;i<ids.length;i++){ (function(id){ var el=$(id); if(!el) return; el.oninput=syncBasics; el.onchange=syncBasics; })(ids[i]); }
  $('btn-clear-order').onclick=function(){ $('orderNo').value=''; $('itemNo').value=''; syncBasics(); };
  $('btn-clear-line').onclick=function(){ $('line').value=''; $('toolNo').value=''; $('operator').value=''; syncBasics(); };

  // stopfelt-udkast
  var stopIds=['other','comment']; for(i=0;i<stopIds.length;i++){ (function(id){ var el=$(id); if(!el) return; el.oninput=function(){ var d=loadJSON('stopDraft',{}); d[id]=el.value||''; saveJSON('stopDraft',d); }; })(stopIds[i]); }
  // rep/note udkast
  var rpIds=['rep-to','rep-cc','rep-pri','rep-type','rep-desc']; for(i=0;i<rpIds.length;i++){ (function(id){ var el=$(id); if(!el)return; el.oninput=function(){ var d=loadJSON('repDraft',{}); d[id]=el.value||''; saveJSON('repDraft',d); }; })(rpIds[i]); }
  if($('note-text')) $('note-text').oninput=function(){ var d=loadJSON('noteDraft',{}); d.text=$('note-text').value||''; saveJSON('noteDraft',d); };
}
function restoreDrafts(){
  var d=loadJSON('stopDraft',{}); if(d.other && $('other')) $('other').value=d.other; if(d.comment && $('comment')) $('comment').value=d.comment;
  var r=loadJSON('repDraft',{}); if(r['rep-to']) $('rep-to').value=r['rep-to']; if(r['rep-cc']) $('rep-cc').value=r['rep-cc']; if(r['rep-pri']) $('rep-pri').value=r['rep-pri']; if(r['rep-type']) $('rep-type').value=r['rep-type']; if(r['rep-desc']) $('rep-desc').value=r['rep-desc'];
  var n=loadJSON('noteDraft',{}); if(n.text) $('note-text').value=n.text;
}
window.addEventListener('DOMContentLoaded', function(){
  // init
  setStatus(false);
  restoreBasics();
  renderReasons();
  renderActivity(); renderMixList();
  refreshQuick(); refreshTemplates();
  bindAutosaveInputs(); restoreDrafts();

  // genoptag aktivt stop
  var cur=currentStop(); if(cur&&cur.start){ STOP_START_ISO=cur.start; stopMeta=cur.meta||null; setStatus(true); if(TICK)clearInterval(TICK); TICK=setInterval(tick,1000); tick(); }

  // åbne/lukke paneler
  $('btn-open-stop').onclick=function(){ openStopPanel(); };
  $('stop-cancel').onclick=function(){ closeStopPanel(); };
  $('btn-open-rep').onclick=function(){ show($('repPanel')); };
  $('rep-cancel').onclick=function(){ hide($('repPanel')); };
  $('btn-open-note').onclick=function(){ show($('notePanel')); };
  $('note-cancel').onclick=function(){ hide($('notePanel')); };

  // stop-panel interaktion
  $('retro-mode').onchange=function(){ if(this.value==='yes'){ show($('retro-fields')); } else { hide($('retro-fields')); } };
  $('quick-last').onchange=function(){ var id=this.value; if(!id) return; var rows=events(),i,ev=null; for(i=0;i<rows.length;i++){ if(rows[i].id===id){ ev=rows[i]; break } } applyFromEvent(ev); };
  $('tpl-save').onclick=function(){ var name=prompt('Navn på skabelon?'); if(!name) return; var t=captureStopForm(); t.id=uuid(); t.name=name; var list=templates(); list.unshift(t); saveTemplates(list); refreshTemplates(); alert('Skabelon gemt.'); };
  $('tpl-del').onclick=function(){ var id=$('tpl-select').value; if(!id) return; var list=templates().filter(function(x){return x.id!==id}); saveTemplates(list); refreshTemplates(); };
  $('tpl-select').onchange=function(){ var id=this.value; if(!id) return; var list=templates(),i,t=null; for(i=0;i<list.length;i++){ if(list[i].id===id){ t=list[i]; break; } } if(t){ var radios=document.getElementsByName('reasonRadio'), i; for(i=0;i<radios.length;i++){ if(radios[i].value===t.reason.code){ radios[i].checked=true; renderChipsByCode(radios[i].value); break } } var nodes=$('reasonChips').getElementsByTagName('input'), set=(t.detailChips||[]), k; for(k=0;k<nodes.length;k++){ nodes[k].checked=(set.indexOf(nodes[k].value)>=0) } $('other').value=t.other||''; $('comment').value=t.comment||''; } };
  $('btn-clear-detail').onclick=function(){ $('other').value=''; $('comment').value=''; var nodes=$('reasonChips').getElementsByTagName('input'), i; for(i=0;i<nodes.length;i++){nodes[i].checked=false} };
  $('stop-confirm').onclick=confirmStop;

  // START (afslut) -> spørg inline
  $('btn-start').onclick=function(){ if(!IS_STOPPED) return; showDoneInline(); };
  $('doneSave').onclick=function(){ finalizeStop(true); };
  $('doneSkip').onclick=function(){ finalizeStop(false); };

  // Rep/Note
  $('rep-create').onclick=createRepStandalone;
  $('note-create').onclick=createNote;

  // resend feed nu og hver 5. minut
  resendQueued(); setInterval(resendQueued, 5*60*1000);
});
</script>
</body>
</html>

  
